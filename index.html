<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TERSYS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: none;
        }
        select::-ms-expand {
            display: none;
        }
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #e0e0e0;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #bdbdbd;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a0a0a0;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <script type="text/javascript">
        // Manual SVG Icons from Lucide
        const icons = {
            FileText: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-text"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L15 2z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>',
            PlusCircle: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus-circle"><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></svg>',
            Search: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>',
            Building: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-building"><rect width="16" height="20" x="4" y="2" rx="2" ry="2"/><path d="M9 22v-4h6v4"/><path d="M8 6h.01"/><path d="M16 6h.01"/><path d="M12 6h.01"/><path d="M12 10h.01"/><path d="M12 14h.01"/><path d="M12 18h.01"/></svg>',
            Truck: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-truck"><path d="M14 18V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v11a1 1 0 0 0 1 1h2"/><path d="M19 18h2a1 1 0 0 0 1-1v-3a1 1 0 0 0-1-1h-1V6a2 2 0 0 0-2-2h-3a2 2 0 0 0-2 2v11a1 1 0 0 0 1 1h2"/><circle cx="7" cy="18" r="2"/><circle cx="17" cy="18" r="2"/></svg>',
            UserCheck: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-check"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><polyline points="22 7 18 11 16 9"/></svg>',
            LogOut: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-log-out"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="17 16 22 12 17 8"/><line x1="22" x2="11" y1="12" y2="12"/></svg>',
            Trash2: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>',
            Menu: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-menu"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>',
            X: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>',
            ChevronDown: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down"><path d="m6 9 6 6 6-6"/></svg>',
            ChevronUp: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-up"><path d="m18 15-6-6-6 6"/></svg>',
            LayoutDashboard: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-layout-dashboard"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>',
            CalendarDays: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar-days"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/><path d="M8 14h.01"/><path d="M12 14h.01"/><path d="M16 14h.01"/><path d="M8 18h.01"/><path d="M12 18h.01"/><path d="M16 18h.01"/></svg>',
            User: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>',
            Users: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>',
            Settings: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-settings"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.78 1.28a2 2 0 0 0 .73 2.73l.04.02a2 2 0 0 1 .97 1.95v.44a2 2 0 0 1-.97 1.95l-.04.02a2 2 0 0 0-.73 2.73l.78 1.28a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.78-1.28a2 2 0 0 0-.73-2.73l-.04-.02a2 2 0 0 1-.97-1.95v-.44a2 2 0 0 1 .97 1.95l-.04-.02a2 2 0 0 0 .73-2.73l-.78-1.28a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>',
            ArrowLeftRight: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucude-arrow-left-right"><path d="M8 3L4 7L8 11"/><path d="M4 7h16"/><path d="M16 21l4-4l-4-4"/><path d="M20 17H4"/></svg>',
            ArrowLeft: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-left"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>',
            MapPin: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-map-pin"><path d="M12 18.3a3.3 3.3 0 1 0 0-6.6 3.3 3.3 0 0 0 0 6.6z"/><path d="M12 2C7.58 2 4 5.58 4 10c0 5.57 8 12 8 12s8-6.43 8-12c0-4.42-3.58-8-8-8z"/></svg>',
            Edit: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>',
            Save: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-save"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>',
            Ban: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-ban"><circle cx="12" cy="12" r="10"/><path d="m4.9 4.9 14.2 14.2"/></svg>',
            DollarSign: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-dollar-sign"><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>',
            ChevronsLeft: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevrons-left"><path d="m11 17-5-5 5-5"/><path d="m18 17-5-5 5-5"/></svg>',
            ChevronsRight: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevrons-right"><path d="m6 17 5-5-5-5"/><path d="m13 17 5-5-5-5"/></svg>'
        };

        function Toast({ message, type, onClose }) {
            const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            const icon = type === 'success' ? '✔' : '✖';
            React.useEffect(() => {
                const timer = setTimeout(() => onClose(), 3000);
                return () => clearTimeout(timer);
            }, [onClose]);
            return React.createElement('div', { className: `fixed bottom-4 right-4 ${bgColor} text-white p-4 rounded-lg shadow-lg flex items-center space-x-2 z-50` },
                React.createElement('span', { className: "font-bold text-xl" }, icon),
                React.createElement('p', null, message),
                React.createElement('button', { onClick: onClose, className: "ml-4 font-bold" }, 'X')
            );
        }

        function ConfirmationModal({ message, onConfirm, onCancel }) {
            return React.createElement('div', { className: "fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50" },
                React.createElement('div', { className: "bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full text-center" },
                    React.createElement('p', { className: "text-lg font-semibold text-gray-800 mb-6" }, message),
                    React.createElement('div', { className: "flex justify-center space-x-4" },
                        React.createElement('button', { onClick: onConfirm, className: "px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition" }, "Confirmar"),
                        React.createElement('button', { onClick: onCancel, className: "px-6 py-3 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition" }, "Cancelar")
                    )
                )
            );
        }

        function LucideIcon({ name, className }) {
            return React.createElement('span', {
                className: className,
                dangerouslySetInnerHTML: { __html: icons[name] || '' }
            });
        }

        window.onload = function() {
            const SUPABASE_URL = 'https://gfivmnnysomfwrffybeh.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdmaXZtbm55c29tZndyZmZ5YmVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMyOTY3NjgsImV4cCI6MjA2ODg3Mjc2OH0.NxetXJoCLh4q9zAqn_olimziI3YP4MAJzB8ed4qf8cg';
            let supabase;

            const initializeSupabaseAndRenderApp = () => {
                try {
                    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    ReactDOM.render(React.createElement(App), document.getElementById('root'));
                } catch (e) {
                    console.error("Erro ao inicializar o cliente Supabase:", e);
                }
            };

            const supabaseScript = document.createElement('script');
            supabaseScript.src = "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.43.0/dist/umd/supabase.min.js";
            supabaseScript.onload = initializeSupabaseAndRenderApp;
            supabaseScript.onerror = (error) => console.error("Erro ao carregar a biblioteca Supabase:", error);
            document.head.appendChild(supabaseScript);

            function LoginPage({ onLogin }) {
              const [username, setUsername] = React.useState('');
              const [password, setPassword] = React.useState('');
              const [error, setError] = React.useState('');
              const [isLoggingIn, setIsLoggingIn] = React.useState(false);

              const handleLogin = async (e) => {
                e.preventDefault();
                setIsLoggingIn(true);
                setError('');
                if (!username || !password) {
                  setError('Por favor, insira seu usuário e senha.');
                  setIsLoggingIn(false);
                  return;
                }
                try {
                    const { data, error: fetchError } = await supabase
                      .from('app_users')
                      .select('*')
                      .eq('username', username.toLowerCase())
                      .eq('password', password)
                      .single();

                    if (fetchError || !data) {
                        setError('Usuário ou senha inválidos.');
                    } else {
                        localStorage.setItem('userRole', data.role);
                        localStorage.setItem('userId', data.username);
                        localStorage.setItem('userFullname', data.fullname);
                        const userLinks = data.quick_access_links && data.quick_access_links.length > 0
                            ? data.quick_access_links
                            : ['dashboard', 'outsourcingDistribution', 'branchTransfer'];
                        localStorage.setItem('quickLinks', JSON.stringify(userLinks));
                        onLogin(data.role, data.username, data.fullname, userLinks);
                    }
                } catch (e) {
                    setError("Erro ao autenticar. Por favor, tente novamente.");
                }
                setIsLoggingIn(false);
              };

              return (
                React.createElement('div', { className: "flex items-center justify-center min-h-screen bg-gray-100" },
                  React.createElement('div', { className: "bg-white p-8 rounded-xl shadow-lg w-full max-w-md" },
                    React.createElement('div', { className: "flex justify-center mb-6" },
                        React.createElement('img', { src: "https://gfivmnnysomfwrffybeh.supabase.co/storage/v1/object/public/logo//LOGO_TERSYS-removebg-preview%20(1).png", alt: "TERSYS Logo", className: "h-32 w-auto" })
                    ),
                    error && React.createElement('div', { className: "bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4" }, error),
                    React.createElement('form', { onSubmit: handleLogin },
                      React.createElement('div', { className: "mb-4" },
                        React.createElement('label', { htmlFor: "username", className: "block text-sm font-medium text-gray-700" }, "Usuário"),
                        React.createElement('input', { type: "text", id: "username", value: username, onChange: (e) => setUsername(e.target.value), className: "mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm", placeholder: "Seu usuário", required: true, disabled: isLoggingIn })
                      ),
                      React.createElement('div', { className: "mb-6" },
                        React.createElement('label', { htmlFor: "password", className: "block text-sm font-medium text-gray-700" }, "Senha"),
                        React.createElement('input', { type: "password", id: "password", value: password, onChange: (e) => setPassword(e.target.value), className: "mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm", placeholder: "Sua senha", required: true, disabled: isLoggingIn })
                      ),
                      React.createElement('button', { type: "submit", className: "w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700", disabled: isLoggingIn }, isLoggingIn ? 'Entrando...' : 'Entrar')
                    )
                  )
                )
              );
            }

            function BranchManagement({ userId, userRole, showToast }) {
                const [newBranchName, setNewBranchName] = React.useState('');
                const [branches, setBranches] = React.useState([]);
                const [responsibleInput, setResponsibleInput] = React.useState("");
                const [error, setError] = React.useState(null);
                const [isLoading, setIsLoading] = React.useState(false);
                const [showConfirmModal, setShowConfirmModal] = React.useState(false);
                const [branchToDelete, setBranchToDelete] = React.useState(null);
                const [editingBranch, setEditingBranch] = React.useState(null);
                const [originalBranch, setOriginalBranch] = React.useState(null);
                const [availableSupervisors, setAvailableSupervisors] = React.useState([]);

                React.useEffect(() => {
                    const fetchBranchesAndSupervisors = async () => {
                        setIsLoading(true);
                        try {
                            const query = supabase.from('filiais').select('*').order('created_at', { ascending: false });
                            if (userRole === 'supervisor') query.eq('responsible', userId);
                            const { data: branchesData, error: branchesError } = await query;
                            if (branchesError) throw branchesError;
                            setBranches(branchesData);

                            const { data: supervisorsData, error: supervisorsError } = await supabase.from('app_users').select('username').eq('role', 'supervisor').order('username');
                            if (supervisorsError) throw supervisorsError;
                            setAvailableSupervisors(supervisorsData.map(u => u.username));
                        } catch (err) {
                            showToast("Erro ao carregar dados.", "error");
                        }
                        setIsLoading(false);
                    };
                    fetchBranchesAndSupervisors();
                }, [userId, userRole, showToast]);

                const handleAddBranch = async (e) => {
                    e.preventDefault();
                    if (!newBranchName.trim() || !responsibleInput.trim()) {
                        showToast("Preencha todos os campos.", "error");
                        return;
                    }
                    setIsLoading(true);
                    try {
                        const { data: existing } = await supabase.from('filiais').select('id').ilike('name', newBranchName.trim());
                        if (existing && existing.length > 0) {
                            showToast("Filial já existe.", "error");
                            setIsLoading(false);
                            return;
                        }
                        await supabase.from('filiais').insert([{ name: newBranchName.trim(), created_by_username: userId, responsible: responsibleInput.trim() }]);
                        showToast("Filial adicionada com sucesso!", "success");
                        setNewBranchName('');
                        setResponsibleInput("");
                        const { data } = await supabase.from('filiais').select('*').order('created_at', { ascending: false });
                        setBranches(data);
                    } catch (err) {
                        showToast("Erro ao adicionar filial.", "error");
                    }
                    setIsLoading(false);
                };

                const handleEditClick = (branch) => {
                    setEditingBranch({ ...branch });
                    setOriginalBranch({ ...branch });
                };

                const handleCancelEdit = () => {
                    setEditingBranch(null);
                    setOriginalBranch(null);
                };

                const handleUpdateBranch = async () => {
                    if (!editingBranch || !editingBranch.name.trim() || !editingBranch.responsible.trim()) {
                        showToast("Preencha todos os campos.", "error");
                        return;
                    }
                    setIsLoading(true);
                    try {
                        const { data: existing } = await supabase.from('filiais').select('id').ilike('name', editingBranch.name.trim()).neq('id', editingBranch.id);
                        if (existing && existing.length > 0) {
                            showToast("Nome de filial duplicado.", "error");
                            setIsLoading(false);
                            return;
                        }
                        await supabase.from('filiais').update({ name: editingBranch.name.trim(), responsible: editingBranch.responsible.trim() }).eq('id', editingBranch.id);
                        showToast("Filial atualizada com sucesso!", "success");
                        setEditingBranch(null);
                        const { data } = await supabase.from('filiais').select('*').order('created_at', { ascending: false });
                        setBranches(data);
                    } catch (err) {
                        showToast("Erro ao atualizar filial.", "error");
                    }
                    setIsLoading(false);
                };

                const handleFieldChange = (e, fieldName) => setEditingBranch(prev => ({ ...prev, [fieldName]: e.target.value }));
                
                const confirmDeleteBranch = (branch) => {
                    setBranchToDelete(branch);
                    setShowConfirmModal(true);
                };

                const handleDeleteBranch = async () => {
                    if (!branchToDelete) return;
                    setIsLoading(true);
                    try {
                        await supabase.from('filiais').delete().eq('id', branchToDelete.id);
                        showToast("Filial excluída com sucesso!", "success");
                        const { data } = await supabase.from('filiais').select('*').order('created_at', { ascending: false });
                        setBranches(data);
                    } catch (err) {
                        showToast("Erro ao excluir filial.", "error");
                    }
                    setIsLoading(false);
                    setShowConfirmModal(false);
                    setBranchToDelete(null);
                };

                return (
                    React.createElement('div', { className: "bg-white p-6 rounded-xl shadow-lg" },
                        React.createElement('h2', { className: "text-2xl font-bold text-gray-800 mb-4 text-center" }, "Cadastro de Filiais"),
                        error && React.createElement('div', { className: "bg-red-100 text-red-700 p-3 rounded mb-4" }, error),
                        React.createElement('form', { onSubmit: handleAddBranch, className: "grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6" },
                            React.createElement('input', { type: "text", value: newBranchName, onChange: (e) => setNewBranchName(e.target.value), className: "w-full p-2 border rounded", placeholder: "Nome da nova filial", required: true, disabled: isLoading }),
                            React.createElement('div', { className: "relative" },
                                React.createElement('select', { value: responsibleInput, onChange: (e) => setResponsibleInput(e.target.value), className: "w-full p-2 border rounded appearance-none pr-8", required: true, disabled: isLoading },
                                    React.createElement('option', { value: "" }, "Selecione um Responsável"),
                                    availableSupervisors.map(name => React.createElement('option', { key: name, value: name }, name))
                                ),
                                React.createElement(LucideIcon, { name: "ChevronDown", className: "h-5 w-5 text-gray-400 absolute right-2 top-1/2 -translate-y-1/2" })
                            ),
                            React.createElement('button', { type: "submit", className: "p-2 bg-blue-600 text-white rounded hover:bg-blue-700", disabled: isLoading }, isLoading ? 'Adicionando...' : 'Adicionar Filial')
                        ),
                        React.createElement('div', { className: "overflow-x-auto" },
                            React.createElement('table', { className: "min-w-full bg-white" },
                                React.createElement('thead', { className: "bg-gray-100" },
                                    React.createElement('tr', null,
                                        React.createElement('th', { className: "px-6 py-3 text-left" }, "Filial"),
                                        React.createElement('th', { className: "px-6 py-3 text-left" }, "Responsável"),
                                        React.createElement('th', { className: "px-6 py-3 text-right" }, "Ações")
                                    )
                                ),
                                React.createElement('tbody', { className: "divide-y" },
                                    isLoading && branches.length === 0 ? React.createElement('tr', null, React.createElement('td', { colSpan: "3", className: "p-4 text-center" }, "Carregando...")) :
                                    branches.length === 0 ? React.createElement('tr', null, React.createElement('td', { colSpan: "3", className: "p-4 text-center" }, "Nenhuma filial cadastrada.")) :
                                    branches.map(branch => (
                                        React.createElement('tr', { key: branch.id },
                                            React.createElement('td', { className: "px-6 py-4" },
                                                editingBranch && editingBranch.id === branch.id ?
                                                React.createElement('input', { type: "text", value: editingBranch.name, onChange: (e) => handleFieldChange(e, 'name'), className: "p-2 border rounded w-full" }) :
                                                branch.name
                                            ),
                                            React.createElement('td', { className: "px-6 py-4" },
                                                editingBranch && editingBranch.id === branch.id ?
                                                React.createElement('select', { value: editingBranch.responsible, onChange: (e) => handleFieldChange(e, 'responsible'), className: "p-2 border rounded w-full" },
                                                   React.createElement('option', { value: "" }, "Selecione"),
                                                   availableSupervisors.map(name => React.createElement('option', { key: name, value: name }, name))
                                                ) :
                                                branch.responsible || 'N/A'
                                            ),
                                            React.createElement('td', { className: "px-6 py-4 text-right" },
                                                editingBranch && editingBranch.id === branch.id ?
                                                React.createElement(React.Fragment, null,
                                                    React.createElement('button', { onClick: handleUpdateBranch, className: "text-green-600 mr-2", title: "Salvar" }, React.createElement(LucideIcon, {name: 'Save'})),
                                                    React.createElement('button', { onClick: handleCancelEdit, className: "text-gray-600", title: "Cancelar" }, React.createElement(LucideIcon, {name: 'Ban'}))
                                                ) :
                                                React.createElement(React.Fragment, null,
                                                    React.createElement('button', { onClick: () => handleEditClick(branch), className: "text-blue-600 mr-2", title: "Editar" }, React.createElement(LucideIcon, {name: 'Edit'})),
                                                    React.createElement('button', { onClick: () => confirmDeleteBranch(branch), className: "text-red-600", title: "Excluir" }, React.createElement(LucideIcon, {name: 'Trash2'}))
                                                )
                                            )
                                        )
                                    ))
                                )
                            )
                        ),
                        showConfirmModal && React.createElement(ConfirmationModal, { message: `Deseja excluir a filial "${branchToDelete?.name}"?`, onConfirm: handleDeleteBranch, onCancel: () => setShowConfirmModal(false) })
                    )
                );
            }

            function EquipmentManagement({ userId, showToast }) {
              const [newPlate, setNewPlate] = React.useState('');
              const [newModel, setNewModel] = React.useState('');
              const [newBrand, setNewBrand] = React.useState('');
              const [newChassis, setNewChassis] = React.useState('');
              const [newEquipmentType, setNewEquipmentType] = React.useState('');
              const [equipmentList, setEquipmentList] = React.useState([]);
              const [error, setError] = React.useState(null);
              const [isLoading, setIsLoading] = React.useState(false);
              const [showConfirmModal, setShowConfirmModal] = React.useState(false);
              const [equipmentToDelete, setEquipmentToDelete] = React.useState(null);
              const [editingEquipment, setEditingEquipment] = React.useState(null);
              const [searchTerm, setSearchTerm] = React.useState('');
              const [showForm, setShowForm] = React.useState(false);
              const equipmentTypes = ["BOMBA LANÇA", "BOMBA", "BETONEIRA"];

              React.useEffect(() => {
                const fetchEquipment = async () => {
                  setIsLoading(true);
                  try {
                    const { data, error: fetchError } = await supabase.from('equipamentos').select('*').order('created_at', { ascending: false });
                    if (fetchError) throw fetchError;
                    setEquipmentList(data);
                  } catch (err) {
                    showToast("Erro ao carregar equipamentos.", "error");
                  }
                  setIsLoading(false);
                };
                fetchEquipment();
              }, [showToast]);

              const handleAddEquipment = async (e) => {
                e.preventDefault();
                if (!newPlate.trim() || !newModel.trim() || !newBrand.trim() || !newChassis.trim() || !newEquipmentType) {
                  showToast("Preencha todos os campos.", "error");
                  return;
                }
                setIsLoading(true);
                try {
                  await supabase.from('equipamentos').insert([{ plate: newPlate.trim(), model: newModel.trim(), brand: newBrand.trim(), chassis: newChassis.trim(), type: newEquipmentType, created_by_username: userId }]);
                  showToast("Equipamento adicionado com sucesso!", "success");
                  setNewPlate(''); setNewModel(''); setNewBrand(''); setNewChassis(''); setNewEquipmentType(''); setShowForm(false);
                  const { data } = await supabase.from('equipamentos').select('*').order('created_at', { ascending: false });
                  setEquipmentList(data);
                } catch (err) {
                  showToast("Erro ao adicionar equipamento.", "error");
                }
                setIsLoading(false);
              };

              const handleEditClick = (eq) => { setEditingEquipment({ ...eq }); };
              const handleCancelEdit = () => { setEditingEquipment(null); };
              const handleFieldChange = (e, field) => setEditingEquipment(prev => ({...prev, [field]: e.target.value}));
              
              const handleUpdateEquipment = async () => {
                if (!editingEquipment) return;
                setIsLoading(true);
                try {
                  await supabase.from('equipamentos').update({ plate: editingEquipment.plate.trim(), model: editingEquipment.model.trim(), brand: editingEquipment.brand.trim(), chassis: editingEquipment.chassis.trim(), type: editingEquipment.type }).eq('id', editingEquipment.id);
                  showToast("Equipamento atualizado!", "success");
                  setEditingEquipment(null);
                  const { data } = await supabase.from('equipamentos').select('*').order('created_at', { ascending: false });
                  setEquipmentList(data);
                } catch (err) {
                   showToast("Erro ao atualizar.", "error");
                }
                setIsLoading(false);
              };

              const confirmDeleteEquipment = (eq) => { setEquipmentToDelete(eq); setShowConfirmModal(true); };

              const handleDeleteEquipment = async () => {
                if (!equipmentToDelete) return;
                setIsLoading(true);
                try {
                    await supabase.from('equipamentos').delete().eq('id', equipmentToDelete.id);
                    showToast("Equipamento excluído!", "success");
                    const { data } = await supabase.from('equipamentos').select('*').order('created_at', { ascending: false });
                    setEquipmentList(data);
                } catch(e) {
                    showToast("Erro ao excluir.", "error");
                }
                setIsLoading(false);
                setShowConfirmModal(false);
                setEquipmentToDelete(null);
              };

              const filteredEquipmentList = equipmentList.filter(eq =>
                  Object.values(eq).some(val => val && String(val).toLowerCase().includes(searchTerm.toLowerCase()))
              );

              return React.createElement('div', { className: "bg-white p-6 rounded-xl shadow-lg" },
                React.createElement('h2', { className: "text-2xl font-bold text-gray-800 mb-4 text-center" }, "Cadastro de Equipamentos"),
                !showForm && React.createElement('div', { className: "flex justify-center mb-6" }, React.createElement('button', { onClick: () => setShowForm(true), className: "p-2 bg-blue-600 text-white rounded" }, "Cadastrar Novo Equipamento")),
                showForm && React.createElement('form', { onSubmit: handleAddEquipment, className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6 p-4 border rounded" },
                    React.createElement('input', { placeholder: "Placa", value: newPlate, onChange: e => setNewPlate(e.target.value), className: "p-2 border rounded" }),
                    React.createElement('input', { placeholder: "Modelo", value: newModel, onChange: e => setNewModel(e.target.value), className: "p-2 border rounded" }),
                    React.createElement('input', { placeholder: "Marca", value: newBrand, onChange: e => setNewBrand(e.target.value), className: "p-2 border rounded" }),
                    React.createElement('input', { placeholder: "Chassi", value: newChassis, onChange: e => setNewChassis(e.target.value), className: "p-2 border rounded" }),
                    React.createElement('select', { value: newEquipmentType, onChange: e => setNewEquipmentType(e.target.value), className: "p-2 border rounded" },
                        React.createElement('option', { value: "" }, "Selecione o Tipo"),
                        equipmentTypes.map(type => React.createElement('option', { key: type, value: type }, type))
                    ),
                    React.createElement('div', { className: "lg:col-span-3 flex justify-center gap-4" },
                        React.createElement('button', { type: "submit", className: "p-2 bg-blue-600 text-white rounded" }, "Adicionar"),
                        React.createElement('button', { type: "button", onClick: () => setShowForm(false), className: "p-2 bg-gray-300 rounded" }, "Cancelar")
                    )
                ),
                React.createElement('input', { type: "text", placeholder: "Buscar...", value: searchTerm, onChange: e => setSearchTerm(e.target.value), className: "w-full p-2 border rounded mb-4" }),
                React.createElement('div', { className: "overflow-x-auto" },
                    React.createElement('table', { className: "min-w-full bg-white text-sm" },
                        React.createElement('thead', { className: "bg-gray-100" }, React.createElement('tr', null, 
                            React.createElement('th', {className: "p-2 text-left"}, "Placa"), 
                            React.createElement('th', {className: "p-2 text-left"}, "Modelo"),
                            React.createElement('th', {className: "p-2 text-left"}, "Marca"),
                            React.createElement('th', {className: "p-2 text-left"}, "Chassi"),
                            React.createElement('th', {className: "p-2 text-left"}, "Tipo"), 
                            React.createElement('th', {className: "p-2 text-right"}, "Ações"))),
                        React.createElement('tbody', { className: "divide-y" },
                            filteredEquipmentList.map(eq => (
                                React.createElement('tr', { key: eq.id, className: "hover:bg-gray-50" },
                                    editingEquipment && editingEquipment.id === eq.id ?
                                    React.createElement(React.Fragment, null,
                                        React.createElement('td', { className: "p-2" }, React.createElement('input', {value: editingEquipment.plate, onChange: e=>handleFieldChange(e, 'plate'), className:"p-1 border rounded w-full"})),
                                        React.createElement('td', { className: "p-2" }, React.createElement('input', {value: editingEquipment.model, onChange: e=>handleFieldChange(e, 'model'), className:"p-1 border rounded w-full"})),
                                        React.createElement('td', { className: "p-2" }, React.createElement('input', {value: editingEquipment.brand, onChange: e=>handleFieldChange(e, 'brand'), className:"p-1 border rounded w-full"})),
                                        React.createElement('td', { className: "p-2" }, React.createElement('input', {value: editingEquipment.chassis, onChange: e=>handleFieldChange(e, 'chassis'), className:"p-1 border rounded w-full"})),
                                        React.createElement('td', { className: "p-2" }, React.createElement('select', {value: editingEquipment.type, onChange: e=>handleFieldChange(e, 'type'), className:"p-1 border rounded w-full"}, equipmentTypes.map(t=>React.createElement('option',{key:t, value:t}, t)))),
                                        React.createElement('td', { className: "p-2 text-right whitespace-nowrap" },
                                          React.createElement('button', {onClick: handleUpdateEquipment, className:"text-green-600 mr-2 p-1 hover:bg-green-100 rounded-full"}, React.createElement(LucideIcon, {name:'Save'})),
                                          React.createElement('button', {onClick: handleCancelEdit, className:"text-gray-600 p-1 hover:bg-gray-200 rounded-full"}, React.createElement(LucideIcon, {name:'Ban'}))
                                        )
                                    ) :
                                    React.createElement(React.Fragment, null,
                                        React.createElement('td', { className: "p-2" }, eq.plate),
                                        React.createElement('td', { className: "p-2" }, eq.model),
                                        React.createElement('td', { className: "p-2" }, eq.brand),
                                        React.createElement('td', { className: "p-2" }, eq.chassis),
                                        React.createElement('td', { className: "p-2" }, eq.type),
                                        React.createElement('td', { className: "p-2 text-right whitespace-nowrap" },
                                            React.createElement('button', {onClick: ()=>handleEditClick(eq), className:"text-blue-600 mr-2 p-1 hover:bg-blue-100 rounded-full"}, React.createElement(LucideIcon, {name: 'Edit'})),
                                            React.createElement('button', {onClick: ()=>confirmDeleteEquipment(eq), className:"text-red-600 p-1 hover:bg-red-100 rounded-full"}, React.createElement(LucideIcon, {name: 'Trash2'}))
                                        )
                                    )
                                )
                            ))
                        )
                    )
                ),
                showConfirmModal && React.createElement(ConfirmationModal, { message: `Excluir equipamento placa "${equipmentToDelete?.plate}"?`, onConfirm: handleDeleteEquipment, onCancel: () => setShowConfirmModal(false) })
              );
            }

            function UserManagement({ userId, showToast }) {
              const [newUsername, setNewUsername] = React.useState('');
              const [newFullname, setNewFullname] = React.useState('');
              const [newPassword, setNewPassword] = React.useState('');
              const [newUserRole, setNewUserRole] = React.useState('usuario');
              const [usersList, setUsersList] = React.useState([]);
              const [isLoading, setIsLoading] = React.useState(false);
              const [showConfirmModal, setShowConfirmModal] = React.useState(false);
              const [userToDelete, setUserToDelete] = React.useState(null);
              const roles = ['administrador', 'supervisor', 'usuario'];

              React.useEffect(() => {
                const fetchUsers = async () => {
                  setIsLoading(true);
                  try {
                    const { data, error } = await supabase.from('app_users').select('*').order('created_at', { ascending: false });
                    if (error) throw error;
                    setUsersList(data);
                  } catch (e) {
                    showToast("Erro ao carregar usuários.", "error");
                  }
                  setIsLoading(false);
                };
                fetchUsers();
              }, [showToast]);

              const handleAddUser = async (e) => {
                e.preventDefault();
                if (!newUsername.trim() || !newFullname.trim() || !newPassword.trim()) { 
                    showToast("Preencha todos os campos.", "error");
                    return; 
                }
                setIsLoading(true);
                try {
                  const { data: existing } = await supabase.from('app_users').select('username').eq('username', newUsername.trim());
                  if (existing && existing.length > 0) { 
                      showToast("Nome de usuário já existe.", "error");
                      setIsLoading(false); 
                      return; 
                  }
                  await supabase.from('app_users').insert([{ 
                      username: newUsername.trim(), 
                      fullname: newFullname.trim(), 
                      password: newPassword, 
                      role: newUserRole 
                  }]);
                  showToast("Usuário adicionado!", "success");
                  setNewUsername(''); 
                  setNewFullname('');
                  setNewPassword(''); 
                  setNewUserRole('usuario');
                  const { data } = await supabase.from('app_users').select('*').order('created_at', { ascending: false });
                  setUsersList(data);
                } catch(e) {
                   showToast("Erro ao adicionar usuário.", "error");
                }
                setIsLoading(false);
              };

              const confirmDeleteUser = (user) => { setUserToDelete(user); setShowConfirmModal(true); };

              const handleDeleteUser = async () => {
                if (!userToDelete) return;
                setIsLoading(true);
                try {
                    await supabase.from('app_users').delete().eq('id', userToDelete.id);
                    showToast("Usuário excluído!", "success");
                    const { data } = await supabase.from('app_users').select('*').order('created_at', { ascending: false });
                    setUsersList(data);
                } catch(e) {
                    showToast("Erro ao excluir usuário.", "error");
                }
                setIsLoading(false);
                setShowConfirmModal(false);
                setUserToDelete(null);
              };

              return React.createElement('div', { className: "bg-white p-6 rounded-xl shadow-lg" },
                React.createElement('h2', { className: "text-2xl font-bold text-gray-800 mb-4 text-center" }, "Cadastro de Usuários"),
                React.createElement('form', { onSubmit: handleAddUser, className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6" },
                  React.createElement('input', { placeholder: "Nome de Usuário", value: newUsername, onChange: e => setNewUsername(e.target.value), className: "p-2 border rounded" }),
                  React.createElement('input', { placeholder: "Nome Completo", value: newFullname, onChange: e => setNewFullname(e.target.value), className: "p-2 border rounded" }),
                  React.createElement('input', { type: "password", placeholder: "Senha", value: newPassword, onChange: e => setNewPassword(e.target.value), className: "p-2 border rounded" }),
                  React.createElement('select', { value: newUserRole, onChange: e => setNewUserRole(e.target.value), className: "p-2 border rounded" }, roles.map(r => React.createElement('option', { key: r, value: r }, r.charAt(0).toUpperCase() + r.slice(1)))),
                  React.createElement('div', { className: "lg:col-span-3 flex justify-center" }, React.createElement('button', { type: "submit", className: "p-2 bg-blue-600 text-white rounded w-full md:w-auto" }, "Adicionar Usuário"))
                ),
                React.createElement('div', { className: "overflow-x-auto" },
                  React.createElement('table', { className: "min-w-full bg-white" },
                    React.createElement('thead', { className: "bg-gray-100" }, React.createElement('tr', null, 
                        React.createElement('th', {className:"p-2 text-left"}, "Usuário"), 
                        React.createElement('th', {className:"p-2 text-left"}, "Nome Completo"), 
                        React.createElement('th', {className:"p-2 text-left"}, "Função"), 
                        React.createElement('th', {className:"p-2 text-right"}, "Ações")
                    )),
                    React.createElement('tbody', { className: "divide-y" }, usersList.map(user => React.createElement('tr', { key: user.id },
                      React.createElement('td', {className:"p-2"}, user.username),
                      React.createElement('td', {className:"p-2"}, user.fullname),
                      React.createElement('td', {className:"p-2 capitalize"}, user.role),
                      React.createElement('td', {className:"p-2 text-right"}, React.createElement('button', { onClick: () => confirmDeleteUser(user), className: "text-red-600" }, React.createElement(LucideIcon, {name: 'Trash2'})))
                    )))
                  )
                ),
                showConfirmModal && React.createElement(ConfirmationModal, { message: `Excluir usuário "${userToDelete?.username}"?`, onConfirm: handleDeleteUser, onCancel: () => setShowConfirmModal(false) })
              );
            }

            function BranchTransfer({ userId, setCurrentPage, showToast }) {
              const [plate, setPlate] = React.useState('');
              const [newBranch, setNewBranch] = React.useState('');
              const [executionDate, setExecutionDate] = React.useState('');
              const [branches, setBranches] = React.useState([]);
              const [availablePlates, setAvailablePlates] = React.useState([]);
              const [isLoading, setIsLoading] = React.useState(false);
              const [status, setStatus] = React.useState('ATIVO');

              React.useEffect(() => {
                const fetchData = async () => {
                  setIsLoading(true);
                  try {
                    const { data: branchesData } = await supabase.from('filiais').select('name');
                    setBranches(branchesData.map(b => b.name));
                    const { data: platesData } = await supabase.from('equipamentos').select('plate');
                    setAvailablePlates(platesData.map(e => e.plate));
                  } catch (e) {
                    showToast("Erro ao carregar dados.", "error");
                  }
                  setIsLoading(false);
                };
                fetchData();
              }, [showToast]);

              const handleRegisterTransfer = async (e) => {
                e.preventDefault();
                if (!plate.trim() || !newBranch || !executionDate) { showToast("Preencha todos os campos.", "error"); return; }
                setIsLoading(true);
                try {
                  const { data: existingRecords } = await supabase.from('trocasFilial').select('*').eq('plate', plate.trim()).is('ending_date', null).order('executionDate', { ascending: false }).limit(1);
                  if (existingRecords && existingRecords.length > 0) {
                    const prevDate = new Date(executionDate);
                    prevDate.setDate(prevDate.getDate());
                    const prevDay = new Date(prevDate.getTime() - (24 * 60 * 60 * 1000)).toISOString().split('T')[0];
                    await supabase.from('trocasFilial').update({ ending_date: prevDay, status: 'INATIVO' }).eq('id', existingRecords[0].id);
                  }
                  await supabase.from('trocasFilial').insert([{ plate: plate.trim(), newBranch: newBranch, executionDate: executionDate, ending_date: null, created_by_username: userId, status: status }]);
                  showToast("Troca registrada com sucesso!", "success");
                  setPlate(''); setNewBranch(''); setExecutionDate(''); setStatus('ATIVO');
                } catch (e) {
                  showToast("Erro ao registrar troca.", "error");
                }
                setIsLoading(false);
              };

              return React.createElement('div', { className: "bg-white p-6 rounded-xl shadow-lg max-w-2xl mx-auto" },
                React.createElement('div', { className: "flex items-center mb-6" },
                  React.createElement('button', { onClick: () => setCurrentPage('quickAccessMenu'), className: "p-2 mr-4 border rounded" }, React.createElement(LucideIcon, {name: 'ArrowLeft'})),
                  React.createElement('h2', { className: "text-2xl font-bold text-gray-800 flex-grow text-center" }, "Troca de Filial de Equipamento")
                ),
                React.createElement('form', { onSubmit: handleRegisterTransfer, className: "space-y-6" },
                  React.createElement('select', { value: plate, onChange: e => setPlate(e.target.value), className: "w-full p-2 border rounded" }, React.createElement('option', {}, "Selecione a Placa"), availablePlates.map(p => React.createElement('option', {key: p, value: p}, p))),
                  React.createElement('select', { value: newBranch, onChange: e => setNewBranch(e.target.value), className: "w-full p-2 border rounded" }, React.createElement('option', {}, "Selecione a Nova Filial"), branches.map(b => React.createElement('option', {key: b, value: b}, b))),
                  React.createElement('input', { type: "date", value: executionDate, onChange: e => setExecutionDate(e.target.value), className: "w-full p-2 border rounded" }),
                  React.createElement('select', { value: status, onChange: e => setStatus(e.target.value), className: "w-full p-2 border rounded" }, React.createElement('option', {value: "ATIVO"}, "ATIVO"), React.createElement('option', {value: "INATIVO"}, "INATIVO")),
                  React.createElement('button', { type: "submit", className: "w-full p-3 bg-blue-600 text-white rounded", disabled: isLoading }, isLoading ? 'Registrando...' : 'Registrar Troca')
                )
              );
            }

            function Dashboard({ userId, showToast }) {
              const [equipmentCounts, setEquipmentCounts] = React.useState({ 'BOMBA LANÇA': 0, 'BOMBA': 0, 'BETONEIRA': 0 });
              const [registros, setRegistros] = React.useState([]);
              const [allEquipment, setAllEquipment] = React.useState([]);
              const [allBranches, setAllBranches] = React.useState([]);
              const [selectedUser, setSelectedUser] = React.useState('Todos os Responsáveis');
              const [availableUsers, setAvailableUsers] = React.useState(['Todos os Responsáveis']);
              const [selectedBranch, setSelectedBranch] = React.useState('Todas as Filiais');
              const [availableBranches, setAvailableBranches] = React.useState(['Todas as Filiais']);
              const [selectedEquipmentType, setSelectedEquipmentType] = React.useState('Todos os Tipos');
              const equipmentTypes = ['Todos os Tipos', "BOMBA LANÇA", "BOMBA", "BETONEIRA"];
              const [isLoading, setIsLoading] = React.useState(false);
              
              const formatDate = (dateString) => dateString ? new Date(dateString + 'T00:00:00').toLocaleDateString('pt-BR') : '';

              React.useEffect(() => {
                const fetchData = async () => {
                    setIsLoading(true);
                    try {
                        const { data: usersData } = await supabase.from('app_users').select('username').eq('role', 'supervisor');
                        setAvailableUsers(['Todos os Responsáveis', ...usersData.map(u => u.username)]);

                        const { data: branchesData } = await supabase.from('filiais').select('name, responsible');
                        setAvailableBranches(['Todas as Filiais', ...branchesData.map(b => b.name)]);
                        setAllBranches(branchesData);

                        const { data: equipmentData } = await supabase.from('equipamentos').select('plate, type, model, brand, chassis');
                        setAllEquipment(equipmentData);
                    } catch (e) {
                         showToast("Erro ao carregar filtros.", "error");
                    }
                    setIsLoading(false);
                };
                fetchData();
              }, [showToast]);

              React.useEffect(() => {
                const fetchDashboardData = async () => {
                    if (allBranches.length === 0 || allEquipment.length === 0) return;
                    setIsLoading(true);
                    try {
                        const { data: transfersData } = await supabase.from('trocasFilial').select('plate, newBranch').is('ending_date', null);
                        const currentBranchMap = new Map(transfersData.map(t => [t.plate, t.newBranch]));

                        let equipmentForCounting = allEquipment;
                        if (selectedUser !== 'Todos os Responsáveis') {
                            const userBranches = allBranches.filter(b => b.responsible === selectedUser).map(b => b.name);
                            equipmentForCounting = equipmentForCounting.filter(eq => userBranches.includes(currentBranchMap.get(eq.plate)));
                        }
                        if (selectedBranch !== 'Todas as Filiais') {
                            equipmentForCounting = equipmentForCounting.filter(eq => currentBranchMap.get(eq.plate) === selectedBranch);
                        }
                        if (selectedEquipmentType !== 'Todos os Tipos') {
                            equipmentForCounting = equipmentForCounting.filter(eq => eq.type === selectedEquipmentType);
                        }
                        
                        const counts = { 'BOMBA LANÇA': 0, 'BOMBA': 0, 'BETONEIRA': 0 };
                        equipmentForCounting.forEach(eq => { if (counts[eq.type] !== undefined) counts[eq.type]++; });
                        setEquipmentCounts(counts);

                        let query = supabase.from('trocasFilial').select('*').is('ending_date', null).order('newBranch', { ascending: true });
                        if (selectedBranch !== 'Todas as Filiais') query = query.eq('newBranch', selectedBranch);
                        let { data: trocasData } = await query;

                        if (selectedUser !== 'Todos os Responsáveis') {
                           const userBranches = allBranches.filter(b => b.responsible === selectedUser).map(b => b.name);
                           trocasData = trocasData.filter(t => userBranches.includes(t.newBranch));
                        }

                        let finalData = trocasData.map(t => {
                            const eq = allEquipment.find(e => e.plate === t.plate);
                            return { ...t, tipoEquipamento: eq?.type, modeloEquipamento: eq?.model, marcaEquipamento: eq?.brand, chassiEquipamento: eq?.chassis };
                        });

                        if (selectedEquipmentType !== 'Todos os Tipos') {
                            finalData = finalData.filter(d => d.tipoEquipamento === selectedEquipmentType);
                        }
                        setRegistros(finalData);
                    } catch (e) {
                         showToast("Erro ao carregar dados do dashboard.", "error");
                    }
                    setIsLoading(false);
                };
                fetchDashboardData();
              }, [selectedUser, selectedBranch, selectedEquipmentType, allBranches, allEquipment, showToast]);
              
              const exportToCSV = () => {
                const headers = ["Filial", "Placa", "Modelo", "Marca", "Chassi", "Tipo", "Data Início", "Status"];
                const rows = registros.map(r => [r.newBranch, r.plate, r.modeloEquipamento, r.marcaEquipamento, r.chassiEquipamento, r.tipoEquipamento, formatDate(r.executionDate), r.status]);
                let csvContent = headers.join(";") + "\n" + rows.map(e => e.join(";")).join("\n");
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "dashboard.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
              };

              const totalEquipment = Object.values(equipmentCounts).reduce((a, b) => a + b, 0);

              return (
                React.createElement('div', { className: "bg-white p-6 rounded-xl shadow-lg" },
                  React.createElement('div', { className: "flex justify-between items-center mb-6" },
                    React.createElement('h2', { className: "text-2xl font-bold" }, "Dashboard"),
                    React.createElement('button', { onClick: exportToCSV, className: "p-2 bg-green-600 text-white rounded" }, "Exportar CSV")
                  ),
                  React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 p-4 border rounded" },
                      React.createElement('select', { value: selectedBranch, onChange: e => setSelectedBranch(e.target.value), className: "p-2 border rounded" }, availableBranches.map(b => React.createElement('option',{key: b, value: b}, b))),
                      React.createElement('select', { value: selectedUser, onChange: e => setSelectedUser(e.target.value), className: "p-2 border rounded" }, availableUsers.map(u => React.createElement('option',{key: u, value: u}, u))),
                      React.createElement('select', { value: selectedEquipmentType, onChange: e => setSelectedEquipmentType(e.target.value), className: "p-2 border rounded" }, equipmentTypes.map(t => React.createElement('option',{key: t, value: t}, t)))
                  ),
                  React.createElement('h3', { className: "text-xl font-semibold mb-4" }, "Visão Geral"),
                  React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-3 gap-6 mb-8" },
                      Object.entries(equipmentCounts).map(([type, count]) => React.createElement('div', { key: type, className: "p-4 bg-gray-50 rounded-lg" }, React.createElement('p', {className: "font-semibold"}, type), React.createElement('p', {className: "text-2xl font-bold"}, count)))
                  ),
                   React.createElement('h3', { className: "text-xl font-semibold mb-4" }, "Distribuição"),
                   React.createElement('div', { className: "mb-8 space-y-2" }, totalEquipment === 0 ?
                       React.createElement('p',{}, "Nenhum equipamento para exibir.") : Object.entries(equipmentCounts).map(([type, count]) => {
                       const percentage = totalEquipment > 0 ? (count / totalEquipment * 100).toFixed(1) : 0;
                       const barColor = type === 'BOMBA LANÇA' ? 'bg-blue-500' : type === 'BETONEIRA' ? 'bg-green-500' : 'bg-yellow-500';
                       return React.createElement('div', {key: type}, `${type}: ${percentage}%`, React.createElement('div',{className:"w-full bg-gray-200 rounded-full h-2.5"}, React.createElement('div', {className:`${barColor} h-2.5 rounded-full`, style:{width: `${percentage}%`}})))
                   })),
                  React.createElement('h3', { className: "text-xl font-semibold mb-4" }, "Tabela de Equipamentos Ativos"),
                  React.createElement('div', { className: "overflow-x-auto" },
                    React.createElement('table', { className: "min-w-full bg-white" },
                      React.createElement('thead', {className:"bg-gray-100"}, React.createElement('tr', null, ["Filial", "Placa", "Modelo", "Marca", "Chassi", "Tipo", "Data Início", "Status"].map(h => React.createElement('th',{key:h, className:"p-2 text-left"}, h)))),
                      React.createElement('tbody', {className:"divide-y"}, registros.map(r => React.createElement('tr', {key:r.id},
                        React.createElement('td',{className:"p-2"}, r.newBranch),
                        React.createElement('td',{className:"p-2"}, r.plate),
                        React.createElement('td',{className:"p-2"}, r.modeloEquipamento),
                        React.createElement('td',{className:"p-2"}, r.marcaEquipamento),
                        React.createElement('td',{className:"p-2"}, r.chassiEquipamento),
                        React.createElement('td',{className:"p-2"}, r.tipoEquipamento),
                        React.createElement('td',{className:"p-2"}, formatDate(r.executionDate)),
                        React.createElement('td',{className:`p-2 font-semibold ${r.status === 'ATIVO' ? 'text-green-600' : 'text-red-600'}`}, r.status),
                      )))
                    )
                  )
                )
              );
            }

            function OutsourcingDistribution({ userId, showToast, setCurrentPage }) {
                const [branchesByResponsible, setBranchesByResponsible] = React.useState({});
                const [isLoading, setIsLoading] = React.useState(false);

                React.useEffect(() => {
                    const fetchDistributionData = async () => {
                        setIsLoading(true);
                        try {
                            const { data: branchesData } = await supabase.from('filiais').select('name, responsible');
                            const { data: supervisorsData } = await supabase.from('app_users').select('username').eq('role', 'supervisor').order('username');
                            const supervisors = supervisorsData.map(u => u.username);
                            const grouped = supervisors.reduce((acc, sup) => ({...acc, [sup]: []}), {});
                            grouped['Sem Responsável'] = [];
                            branchesData.forEach(branch => {
                                if (branch.responsible && grouped[branch.responsible]) {
                                    grouped[branch.responsible].push(branch.name);
                                } else {
                                    grouped['Sem Responsável'].push(branch.name);
                                }
                            });
                            setBranchesByResponsible(grouped);
                        } catch (e) {
                            showToast("Erro ao carregar dados.", "error");
                        }
                        setIsLoading(false);
                    };
                    fetchDistributionData();
                }, [showToast]);

                return (
                    React.createElement('div', { className: "bg-white p-6 rounded-xl shadow-lg w-full" },
                        React.createElement('div', { className: "flex items-center mb-6" },
                            React.createElement('button', { onClick: () => setCurrentPage('quickAccessMenu'), className: "p-2 mr-4 border rounded" }, React.createElement(LucideIcon, {name: 'ArrowLeft'})),
                            React.createElement('h2', { className: "text-2xl font-bold text-gray-800 flex-grow text-center" }, "Distribuição de Terceirização")
                        ),
                        isLoading ? React.createElement('p', {}, "Carregando...") :
                        React.createElement('div', { className: "flex flex-wrap gap-6 justify-center" },
                            Object.entries(branchesByResponsible).filter(([_, branches]) => branches.length > 0).map(([responsible, branches]) => (
                                React.createElement('div', { key: responsible, className: "w-full md:w-1/3 lg:w-1/4 p-2" },
                                    React.createElement('div', { className: "bg-gray-100 rounded-lg p-4 h-full" },
                                        React.createElement('h3', { className: "font-semibold border-b pb-2 mb-2" }, responsible),
                                        React.createElement('div', { className: "space-y-2" }, branches.map(branch => (
                                            React.createElement('div', { key: branch, className: "bg-white p-2 rounded shadow-sm" }, branch)
                                        )))
                                    )
                                )
                            ))
                        )
                    )
                );
            }
            
            function Displacements({ userId, userRole, showToast }) {
                const [displacements, setDisplacements] = React.useState([]);
                const [branches, setBranches] = React.useState([]);
                const [isLoading, setIsLoading] = React.useState(false);
                const [showForm, setShowForm] = React.useState(false);
                const [isEditing, setIsEditing] = React.useState(false);
                const [currentDisplacement, setCurrentDisplacement] = React.useState(null);
                const initialFormState = { tipo_de_implemento: '', filial_origem: '', filial_destino: '', km: '', valor: '' };
                const [formData, setFormData] = React.useState(initialFormState);

                const [searchTerm, setSearchTerm] = React.useState('');
                const [debouncedSearchTerm, setDebouncedSearchTerm] = React.useState(searchTerm);
                const [originFilter, setOriginFilter] = React.useState('all');
                const [destinationFilter, setDestinationFilter] = React.useState('all');
                const [hasSearched, setHasSearched] = React.useState(false);
                
                const formatDate = (date) => date ? new Date(date).toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit', year: 'numeric'}) : '';

                React.useEffect(() => {
                    const fetchBranches = async () => {
                        try {
                            const { data: bData } = await supabase.from('filiais').select('name').order('name');
                            setBranches(bData.map(b => b.name));
                        } catch (err) {
                            showToast("Erro ao carregar lista de filiais.", "error");
                        }
                    };
                    fetchBranches();
                }, [showToast]);

                React.useEffect(() => {
                    const timerId = setTimeout(() => {
                        setDebouncedSearchTerm(searchTerm);
                    }, 500);

                    return () => {
                        clearTimeout(timerId);
                    };
                }, [searchTerm]);

                React.useEffect(() => {
                    const fetchFilteredData = async () => {
                        if (debouncedSearchTerm === '' && originFilter === 'all' && destinationFilter === 'all') {
                            setDisplacements([]);
                            setHasSearched(false);
                            return;
                        }
                        
                        setHasSearched(true);
                        setIsLoading(true);
                        
                        try {
                            let query = supabase
                                .from('deslocamentos')
                                .select('*')
                                .is('data_encerramento', null)
                                .order('data_criacao', { ascending: false });

                            if (debouncedSearchTerm) {
                                query = query.ilike('tipo_de_implemento', `%${debouncedSearchTerm}%`);
                            }
                            if (originFilter !== 'all') {
                                query = query.eq('filial_origem', originFilter);
                            }
                            if (destinationFilter !== 'all') {
                                query = query.eq('filial_destino', destinationFilter);
                            }

                            const { data, error } = await query;
                            if (error) throw error;
                            
                            setDisplacements(data || []);
                        } catch (err) {
                            showToast("Erro ao buscar deslocamentos.", "error");
                        }
                        setIsLoading(false);
                    };
                    
                    fetchFilteredData();
                }, [debouncedSearchTerm, originFilter, destinationFilter, showToast]);

                const handleInputChange = e => setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));
                
                const handleFormSubmit = async (e) => {
                    e.preventDefault();
                    setIsLoading(true);
                    try {
                        if (isEditing) {
                            await supabase.from('deslocamentos').update({ data_encerramento: new Date().toISOString() }).eq('id', currentDisplacement.id);
                        }
                        await supabase.from('deslocamentos').insert([{ ...formData, km: parseFloat(formData.km), valor: parseFloat(formData.valor) }]);
                        showToast(`Registro ${isEditing ? 'atualizado' : 'criado'}!`, "success");
                        setShowForm(false); 
                        setIsEditing(false); 
                        setFormData(initialFormState);
                        setSearchTerm('');
                        setOriginFilter('all');
                        setDestinationFilter('all');
                    } catch (err) {
                        showToast("Falha ao salvar.", "error");
                    }
                    setIsLoading(false);
                };
            
                const handleEditClick = (d) => {
                    setIsEditing(true);
                    setCurrentDisplacement(d);
                    setFormData({ tipo_de_implemento: d.tipo_de_implemento, filial_origem: d.filial_origem, filial_destino: d.filial_destino, km: d.km, valor: d.valor });
                    setShowForm(true);
                };

                const handleCancel = () => { setShowForm(false); setIsEditing(false); setFormData(initialFormState); };

                return React.createElement('div', { className: "bg-white p-6 rounded-xl shadow-lg" },
                    React.createElement('div', { className: "flex justify-between items-center mb-6" },
                        React.createElement('h2', { className: "text-2xl font-bold" }, "Precificação de Deslocamentos"),
                        userRole === 'administrador' && !showForm && React.createElement('button', { onClick: () => setShowForm(true), className: "p-2 bg-blue-600 text-white rounded" }, "Novo Registro")
                    ),
                    showForm && userRole === 'administrador' && React.createElement('form', { onSubmit: handleFormSubmit, className: "grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 p-4 border rounded" },
                        React.createElement('input', { name: "tipo_de_implemento", value: formData.tipo_de_implemento, onChange: handleInputChange, placeholder:"Tipo de Implemento", className:"p-2 border rounded" }),
                        React.createElement('select', { name: "filial_origem", value: formData.filial_origem, onChange: handleInputChange, className:"p-2 border rounded" }, React.createElement('option', {}, "Origem"), branches.map(b => React.createElement('option',{key:b, value:b},b))),
                        React.createElement('select', { name: "filial_destino", value: formData.filial_destino, onChange: handleInputChange, className:"p-2 border rounded" }, React.createElement('option', {}, "Destino"), branches.map(b => React.createElement('option',{key:b, value:b},b))),
                        React.createElement('input', { type: "number", name: "km", value: formData.km, onChange: handleInputChange, placeholder:"KM", className:"p-2 border rounded" }),
                        React.createElement('input', { type: "number", name: "valor", value: formData.valor, onChange: handleInputChange, placeholder:"Valor", className:"p-2 border rounded" }),
                        React.createElement('div', { className: "md:col-span-3 flex justify-end gap-4" },
                            React.createElement('button', { type: "button", onClick: handleCancel, className: "p-2 bg-gray-300 rounded" }, "Cancelar"),
                            React.createElement('button', { type: "submit", className: "p-2 bg-blue-600 text-white rounded" }, "Salvar")
                        )
                    ),
                    React.createElement('div', { className: "mb-6 p-4 border rounded-lg bg-gray-50 grid grid-cols-1 md:grid-cols-3 gap-4 items-end" },
                        React.createElement('div', null,
                            React.createElement('label', { className: "block text-sm font-medium text-gray-700" }, "Buscar por Implemento"),
                            React.createElement('input', { type: "text", placeholder: "Digite o tipo...", value: searchTerm, onChange: e => setSearchTerm(e.target.value), className: "mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" })
                        ),
                        React.createElement('div', null,
                            React.createElement('label', { className: "block text-sm font-medium text-gray-700" }, "Filtrar por Origem"),
                            React.createElement('select', { value: originFilter, onChange: e => setOriginFilter(e.target.value), className: "mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" },
                                React.createElement('option', { value: "all" }, "Todas as Origens"),
                                branches.map(b => React.createElement('option', { key: b, value: b }, b))
                            )
                        ),
                        React.createElement('div', null,
                            React.createElement('label', { className: "block text-sm font-medium text-gray-700" }, "Filtrar por Destino"),
                            React.createElement('select', { value: destinationFilter, onChange: e => setDestinationFilter(e.target.value), className: "mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" },
                                React.createElement('option', { value: "all" }, "Todos os Destinos"),
                                branches.map(b => React.createElement('option', { key: b, value: b }, b))
                            )
                        )
                    ),
                    React.createElement('div', { className: "overflow-x-auto" },
                        React.createElement('table', { className: "min-w-full bg-white" },
                            React.createElement('thead',{className:"bg-gray-100"}, React.createElement('tr', null, ["Tipo", "Origem", "Destino", "KM", "Valor", "Criação", userRole === 'administrador' ? "Ações" : null].filter(Boolean).map(h => React.createElement('th',{key:h, className:"p-2 text-left"},h)))),
                            React.createElement('tbody', {className:"divide-y"}, 
                                isLoading ? React.createElement('tr', null, React.createElement('td', {colSpan:7, className:"p-4 text-center"}, "Carregando...")) : 
                                !hasSearched ? React.createElement('tr', null, React.createElement('td', {colSpan:7, className:"p-4 text-center text-gray-500"}, "Utilize os filtros acima para buscar os deslocamentos.")) :
                                displacements.length === 0 ? React.createElement('tr', null, React.createElement('td', {colSpan:7, className:"p-4 text-center text-gray-500"}, "Nenhum registro encontrado para os filtros aplicados.")) :
                                displacements.map(d => React.createElement('tr', {key:d.id},
                                    React.createElement('td',{className:"p-2"}, d.tipo_de_implemento),
                                    React.createElement('td',{className:"p-2"}, d.filial_origem),
                                    React.createElement('td',{className:"p-2"}, d.filial_destino),
                                    React.createElement('td',{className:"p-2"}, d.km),
                                    React.createElement('td',{className:"p-2"}, `R$ ${d.valor.toFixed(2).replace('.', ',')}`),
                                    React.createElement('td',{className:"p-2"}, formatDate(d.data_criacao)),
                                    userRole === 'administrador' && React.createElement('td', {className:"p-2 text-right"}, React.createElement('button',{onClick:()=>handleEditClick(d), className:"text-blue-600"}, React.createElement(LucideIcon, {name:'Edit'})))
                                )))
                        )
                    )
                );
            }
            
            function AdditionalCities({ userId, userRole, showToast }) {
                const [records, setRecords] = React.useState([]);
                const [branches, setBranches] = React.useState([]);
                const [isLoading, setIsLoading] = React.useState(false);
                const [showForm, setShowForm] = React.useState(false);
                const [isEditing, setIsEditing] = React.useState(false);
                const [currentRecord, setCurrentRecord] = React.useState(null);
                const initialFormState = { filial: '', cidade: '', km: '', valor: '' };
                const [formData, setFormData] = React.useState(initialFormState);
                
                const [searchTerm, setSearchTerm] = React.useState('');
                const [debouncedSearchTerm, setDebouncedSearchTerm] = React.useState(searchTerm);
                const [branchFilter, setBranchFilter] = React.useState('all');
                const [hasSearched, setHasSearched] = React.useState(false);

                const formatDate = (date) => date ? new Date(date).toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit', year: 'numeric'}) : '';
            
                React.useEffect(() => {
                    const fetchBranches = async () => {
                        try {
                            const { data: bData } = await supabase.from('filiais').select('name').order('name');
                            setBranches(bData.map(b => b.name) || []);
                        } catch (err) {
                            showToast("Erro ao carregar lista de filiais.", "error");
                        }
                    };
                    fetchBranches();
                }, [showToast]);

                React.useEffect(() => {
                    const timerId = setTimeout(() => {
                        setDebouncedSearchTerm(searchTerm);
                    }, 500);

                    return () => {
                        clearTimeout(timerId);
                    };
                }, [searchTerm]);

                React.useEffect(() => {
                    const fetchFilteredData = async () => {
                        if (debouncedSearchTerm === '' && branchFilter === 'all') {
                            setRecords([]);
                            setHasSearched(false);
                            return;
                        }
                        
                        setHasSearched(true);
                        setIsLoading(true);
                        
                        try {
                            let query = supabase
                                .from('adicionais_cidades')
                                .select('*')
                                .is('data_encerramento', null)
                                .order('data_criacao', { ascending: false });

                            if (debouncedSearchTerm) {
                                query = query.ilike('cidade', `%${debouncedSearchTerm}%`);
                            }
                            if (branchFilter !== 'all') {
                                query = query.eq('filial', branchFilter);
                            }

                            const { data, error } = await query;
                            if (error) throw error;
                            
                            setRecords(data || []);
                        } catch (err) {
                            showToast("Erro ao buscar adicionais de cidades.", "error");
                        }
                        setIsLoading(false);
                    };
                    
                    fetchFilteredData();
                }, [debouncedSearchTerm, branchFilter, showToast]);

                const handleInputChange = e => setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));
                
                const handleFormSubmit = async (e) => {
                    e.preventDefault();
                    if (!formData.filial || !formData.cidade.trim() || formData.km === '' || formData.valor === '') {
                        showToast("Por favor, preencha todos os campos.", "error");
                        return;
                    }

                    setIsLoading(true);
                    try {
                        if (isEditing) {
                            const { error: updateError } = await supabase
                                .from('adicionais_cidades')
                                .update({ data_encerramento: new Date().toISOString() })
                                .eq('id', currentRecord.id);
                            if (updateError) throw updateError;
                        }
                        
                        const newRecord = {
                            filial: formData.filial,
                            cidade: formData.cidade.trim(),
                            km: parseFloat(formData.km),
                            valor: parseFloat(formData.valor)
                        };
                        const { error: insertError } = await supabase
                            .from('adicionais_cidades')
                            .insert([newRecord]);
                        if (insertError) throw insertError;
            
                        showToast(`Registro ${isEditing ? 'atualizado' : 'criado'} com sucesso!`, "success");
                        setShowForm(false); 
                        setIsEditing(false); 
                        setFormData(initialFormState);
                        setSearchTerm('');
                        setBranchFilter('all');
                    } catch (err) {
                        console.error("Erro ao salvar registro:", err);
                        showToast("Falha ao salvar o registro.", "error");
                    }
                    setIsLoading(false);
                };
            
                const handleEditClick = (record) => {
                    setIsEditing(true);
                    setCurrentRecord(record);
                    setFormData({
                        filial: record.filial,
                        cidade: record.cidade,
                        km: record.km,
                        valor: record.valor
                    });
                    setShowForm(true);
                };
            
                const handleCancel = () => { 
                    setShowForm(false);
                    setIsEditing(false); 
                    setFormData(initialFormState); 
                };
            
                return React.createElement('div', { className: "bg-white p-6 rounded-xl shadow-lg" },
                    React.createElement('div', { className: "flex justify-between items-center mb-6" },
                        React.createElement('h2', { className: "text-2xl font-bold" }, "Adicional de Cidades"),
                        userRole === 'administrador' && !showForm && React.createElement('button', { onClick: () => setShowForm(true), className: "p-2 bg-blue-600 text-white rounded flex items-center" }, 
                            React.createElement(LucideIcon, {name: 'PlusCircle', className: 'mr-2'}),
                            "Novo Registro"
                        )
                    ),
                    showForm && userRole === 'administrador' && React.createElement('form', { onSubmit: handleFormSubmit, className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6 p-4 border rounded" },
                        React.createElement('select', { name: "filial", value: formData.filial, onChange: handleInputChange, required: true, className:"p-2 border rounded" }, React.createElement('option', {value: ""}, "Selecione a Filial"), branches.map(b => React.createElement('option',{key:b, value:b},b))),
                        React.createElement('input', { name: "cidade", value: formData.cidade, onChange: handleInputChange, placeholder:"Cidade", required: true, className:"p-2 border rounded" }),
                        React.createElement('input', { type: "number", name: "km", value: formData.km, onChange: handleInputChange, placeholder:"KM", required: true, step: "0.01", className:"p-2 border rounded" }),
                        React.createElement('input', { type: "number", name: "valor", value: formData.valor, onChange: handleInputChange, placeholder:"Valor", required: true, step: "0.01", className:"p-2 border rounded" }),
                        React.createElement('div', { className: "md:col-span-full flex justify-end gap-4 mt-2" },
                            React.createElement('button', { type: "button", onClick: handleCancel, className: "p-2 bg-gray-300 rounded" }, "Cancelar"),
                            React.createElement('button', { type: "submit", className: "p-2 bg-blue-600 text-white rounded" }, isEditing ? "Salvar Alterações" : "Salvar")
                        )
                    ),
                    React.createElement('div', { className: "mb-6 p-4 border rounded-lg bg-gray-50 grid grid-cols-1 md:grid-cols-2 gap-4 items-end" },
                        React.createElement('div', null,
                            React.createElement('label', { className: "block text-sm font-medium text-gray-700" }, "Buscar por Cidade"),
                            React.createElement('input', { type: "text", placeholder: "Digite a cidade...", value: searchTerm, onChange: e => setSearchTerm(e.target.value), className: "mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" })
                        ),
                        React.createElement('div', null,
                            React.createElement('label', { className: "block text-sm font-medium text-gray-700" }, "Filtrar por Filial"),
                            React.createElement('select', { value: branchFilter, onChange: e => setBranchFilter(e.target.value), className: "mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" },
                                React.createElement('option', { value: "all" }, "Todas as Filiais"),
                                branches.map(b => React.createElement('option', { key: b, value: b }, b))
                            )
                        )
                    ),
                    React.createElement('div', { className: "overflow-x-auto" },
                        React.createElement('table', { className: "min-w-full bg-white" },
                            React.createElement('thead',{className:"bg-gray-100"}, React.createElement('tr', null, ["Filial", "Cidade", "KM", "Valor", "Data Criação", userRole === 'administrador' ? "Ações" : null].filter(Boolean).map(h => React.createElement('th',{key:h, className:"p-2 text-left"},h)))),
                            React.createElement('tbody', {className:"divide-y"}, 
                                isLoading ? React.createElement('tr', null, React.createElement('td', {colSpan:6, className:"p-4 text-center"}, "Carregando...")) : 
                                !hasSearched ? React.createElement('tr', null, React.createElement('td', {colSpan:6, className:"p-4 text-center text-gray-500"}, "Utilize os filtros acima para buscar.")) :
                                records.length === 0 ? React.createElement('tr', null, React.createElement('td', {colSpan:6, className:"p-4 text-center text-gray-500"}, "Nenhum registro encontrado para os filtros aplicados.")) :
                                records.map(r => React.createElement('tr', {key:r.id},
                                    React.createElement('td',{className:"p-2"}, r.filial),
                                    React.createElement('td',{className:"p-2"}, r.cidade),
                                    React.createElement('td',{className:"p-2"}, r.km),
                                    React.createElement('td',{className:"p-2"}, `R$ ${r.valor.toFixed(2).replace('.', ',')}`),
                                    React.createElement('td',{className:"p-2"}, formatDate(r.data_criacao)),
                                    userRole === 'administrador' && React.createElement('td', {className:"p-2 text-right"}, React.createElement('button',{onClick:()=>handleEditClick(r), className:"text-blue-600"}, React.createElement(LucideIcon, {name:'Edit'})))
                                )))
                        )
                    )
                );
            }
            
            function FixedPrices({ userId, userRole, showToast }) {
                const [records, setRecords] = React.useState([]);
                const [branches, setBranches] = React.useState([]);
                const [isLoading, setIsLoading] = React.useState(true);
                const [showForm, setShowForm] = React.useState(false);
                const [isEditing, setIsEditing] = React.useState(false);
                const [currentRecord, setCurrentRecord] = React.useState(null);
                const initialFormState = { tipo_de_implemento: '', filial: '', preco: '' };
                const [formData, setFormData] = React.useState(initialFormState);
                const implementTypes = ["BOMBA LANÇA", "BOMBA", "BETONEIRA", "TODOS"];

                const [searchTerm, setSearchTerm] = React.useState('');
                const [branchFilter, setBranchFilter] = React.useState('all');

                const formatDate = (date) => date ? new Date(date).toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit', year: 'numeric'}) : '';
            
                React.useEffect(() => {
                    const fetchData = async () => {
                        setIsLoading(true);
                        try {
                            const { data: recordsData, error: recordsError } = await supabase
                                .from('precos_fixos')
                                .select('*')
                                .is('data_encerramento', null)
                                .order('data_criacao', { ascending: false });
                            if (recordsError) throw recordsError;
                            setRecords(recordsData || []);
            
                            const { data: bData, error: branchError } = await supabase.from('filiais').select('name').order('name');
                            if (branchError) throw branchError;
                            setBranches(bData.map(b => b.name) || []);
                        } catch (err) {
                            showToast("Erro ao carregar dados de preços fixos.", "error");
                        }
                        setIsLoading(false);
                    };
                    fetchData();
                }, [showToast]);
            
                const handleInputChange = e => setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));
                
                const handleFormSubmit = async (e) => {
                    e.preventDefault();
                    if (!formData.tipo_de_implemento || !formData.filial || formData.preco === '') {
                        showToast("Por favor, preencha todos os campos.", "error");
                        return;
                    }

                    setIsLoading(true);
                    try {
                        if (isEditing) {
                            const { error: updateError } = await supabase
                                .from('precos_fixos')
                                .update({ data_encerramento: new Date().toISOString() })
                                .eq('id', currentRecord.id);
                            if (updateError) throw updateError;
                        }
                        
                        const newRecord = {
                            tipo_de_implemento: formData.tipo_de_implemento,
                            filial: formData.filial,
                            preco: parseFloat(formData.preco)
                        };
                        const { error: insertError } = await supabase.from('precos_fixos').insert([newRecord]);
                        if (insertError) throw insertError;
            
                        showToast(`Registro ${isEditing ? 'atualizado' : 'criado'} com sucesso!`, "success");
                        setShowForm(false); 
                        setIsEditing(false); 
                        setFormData(initialFormState);
                        const { data } = await supabase.from('precos_fixos').select('*').is('data_encerramento', null).order('data_criacao', { ascending: false });
                        setRecords(data || []);
                    } catch (err) {
                        console.error("Erro ao salvar registro de preço fixo:", err);
                        showToast("Falha ao salvar o registro de preço fixo.", "error");
                    }
                    setIsLoading(false);
                };
            
                const handleEditClick = (record) => {
                    setIsEditing(true); 
                    setCurrentRecord(record);
                    setFormData({
                        tipo_de_implemento: record.tipo_de_implemento,
                        filial: record.filial,
                        preco: record.preco
                    });
                    setShowForm(true);
                };
            
                const handleCancel = () => { 
                    setShowForm(false); 
                    setIsEditing(false); 
                    setFormData(initialFormState); 
                };

                const filteredRecords = records.filter(r => {
                    const searchTermMatch = searchTerm === '' || (r.tipo_de_implemento && r.tipo_de_implemento.toLowerCase().includes(searchTerm.toLowerCase()));
                    const branchMatch = branchFilter === 'all' || r.filial === branchFilter || r.filial === 'Todas';
                    return searchTermMatch && branchMatch;
                });

                return React.createElement('div', { className: "bg-white p-6 rounded-xl shadow-lg" },
                    React.createElement('div', { className: "flex justify-between items-center mb-6" },
                        React.createElement('h2', { className: "text-2xl font-bold" }, "Preço Fixo"),
                        userRole === 'administrador' && !showForm && React.createElement('button', { onClick: () => {setShowForm(true); setIsEditing(false); setFormData(initialFormState);}, className: "p-2 bg-blue-600 text-white rounded flex items-center" }, 
                            React.createElement(LucideIcon, {name: 'PlusCircle', className: 'mr-2'}),
                            "Novo Registro"
                        )
                    ),
                    showForm && userRole === 'administrador' && React.createElement('form', { onSubmit: handleFormSubmit, className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6 p-4 border rounded" },
                        React.createElement('select', { name: "tipo_de_implemento", value: formData.tipo_de_implemento, onChange: handleInputChange, required: true, className:"p-2 border rounded" },
                             React.createElement('option', {value: ""}, "Selecione o Implemento"), 
                             implementTypes.map(type => React.createElement('option', {key: type, value: type}, type))
                        ),
                        React.createElement('select', { name: "filial", value: formData.filial, onChange: handleInputChange, required: true, className:"p-2 border rounded" }, 
                            React.createElement('option', {value: ""}, "Selecione a Filial"), 
                            React.createElement('option', {value: "Todas"}, "Todas"),
                            branches.map(b => React.createElement('option',{key:b, value:b},b))
                        ),
                        React.createElement('input', { type: "number", name: "preco", value: formData.preco, onChange: handleInputChange, placeholder:"Preço", required: true, step: "0.01", className:"p-2 border rounded" }),
                        React.createElement('div', { className: "md:col-span-full flex justify-end gap-4 mt-2" },
                            React.createElement('button', { type: "button", onClick: handleCancel, className: "p-2 bg-gray-300 rounded" }, "Cancelar"),
                            React.createElement('button', { type: "submit", className: "p-2 bg-blue-600 text-white rounded" }, isEditing ? "Salvar Alterações" : "Salvar")
                        )
                    ),
                    React.createElement('div', { className: "mb-6 p-4 border rounded-lg bg-gray-50 grid grid-cols-1 md:grid-cols-2 gap-4 items-end" },
                        React.createElement('div', null,
                            React.createElement('label', { className: "block text-sm font-medium text-gray-700" }, "Buscar por Implemento"),
                            React.createElement('input', { type: "text", placeholder: "Digite o tipo...", value: searchTerm, onChange: e => setSearchTerm(e.target.value), className: "mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" })
                        ),
                        React.createElement('div', null,
                            React.createElement('label', { className: "block text-sm font-medium text-gray-700" }, "Filtrar por Filial"),
                            React.createElement('select', { value: branchFilter, onChange: e => setBranchFilter(e.target.value), className: "mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" },
                                React.createElement('option', { value: "all" }, "Todas as Filiais"),
                                branches.map(b => React.createElement('option', { key: b, value: b }, b))
                            )
                        )
                    ),
                    React.createElement('div', { className: "overflow-x-auto" },
                        React.createElement('table', { className: "min-w-full bg-white" },
                            React.createElement('thead',{className:"bg-gray-100"}, React.createElement('tr', null, ["Tipo de Implemento", "Filial", "Preço", "Data Criação", userRole === 'administrador' ? "Ações" : null].filter(Boolean).map(h => React.createElement('th',{key:h, className:"p-2 text-left"},h)))),
                            React.createElement('tbody', {className:"divide-y"}, 
                                isLoading ? React.createElement('tr', null, React.createElement('td', {colSpan:5, className:"p-4 text-center"}, "Carregando...")) : 
                                filteredRecords.length === 0 ? React.createElement('tr', null, React.createElement('td', {colSpan:5, className:"p-4 text-center text-gray-500"}, "Nenhum registro encontrado.")) :
                                filteredRecords.map(r => React.createElement('tr', {key:r.id},
                                    React.createElement('td',{className:"p-2"}, r.tipo_de_implemento),
                                    React.createElement('td',{className:"p-2"}, r.filial),
                                    React.createElement('td',{className:"p-2"}, `R$ ${r.preco.toFixed(2).replace('.', ',')}`),
                                    React.createElement('td',{className:"p-2"}, formatDate(r.data_criacao)),
                                    userRole === 'administrador' && React.createElement('td', {className:"p-2 text-right"}, React.createElement('button',{onClick:()=>handleEditClick(r), className:"text-blue-600"}, React.createElement(LucideIcon, {name:'Edit'})))
                                )))
                        )
                    )
                );
            }

            function QuickAccessMenu({ setCurrentPage, userFullname, quickLinks, onEdit }) {
              const ALL_PAGES = {
                    dashboard: { title: 'Dashboard', icon: 'LayoutDashboard' },
                    outsourcingDistribution: { title: 'Distribuição', icon: 'MapPin' },
                    branchTransfer: { title: 'Troca de Filial', icon: 'ArrowLeftRight' },
                    displacements: { title: 'Deslocamentos', icon: 'ArrowLeftRight' },
                    additionalCities: { title: 'Adicional Cidades', icon: 'Building' },
                    fixedPrices: { title: 'Preço Fixo', icon: 'DollarSign' },
                    branchManagement: { title: 'Cadastro de Filiais', icon: 'Building', adminOnly: true },
                    equipmentManagement: { title: 'Cadastro de Equipamentos', icon: 'Truck', adminOnly: true },
                    userManagement: { title: 'Cadastro de Usuários', icon: 'Users', adminOnly: true },
              };

              const colors = ['bg-gray-800', 'bg-yellow-500', 'bg-gray-800'];
              const hoverColors = ['hover:bg-gray-900', 'hover:bg-yellow-600', 'hover:bg-gray-900'];
              const iconColors = ['text-gray-300', 'text-yellow-100', 'text-gray-300'];

              return (
                React.createElement('div', { className: "flex flex-col items-center justify-center bg-white p-6 rounded-xl shadow-lg text-center" },
                  React.createElement('h2', { className: "text-3xl font-bold text-gray-800 mb-8" }, "Bem-vindo ao TERSYS!"),
                  React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-3 gap-6 w-full max-w-4xl" },
                    (quickLinks || []).map((linkKey, index) => {
                        const page = ALL_PAGES[linkKey];
                        if (!page) return null;
                        const colorIndex = index % colors.length;
                        return React.createElement('button', { 
                            key: linkKey,
                            onClick: () => setCurrentPage(linkKey), 
                            className: `p-6 ${colors[colorIndex]} text-white rounded-xl shadow-md ${hoverColors[colorIndex]} transition flex flex-col items-center justify-center` 
                        },
                          React.createElement(LucideIcon, { name: page.icon, className: `h-12 w-12 mx-auto mb-3 ${iconColors[colorIndex]}` }),
                          React.createElement('span', { className: "text-xl font-semibold" }, page.title)
                        )
                    })
                  ),
                   React.createElement('button', {
                        onClick: onEdit,
                        className: "mt-8 inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50"
                    }, 
                    React.createElement(LucideIcon, {name: 'Edit', className: 'mr-2'}),
                    "Editar Atalhos"
                   )
                )
              );
            }

            function EditShortcutsModal({ currentLinks, onClose, onSave, userRole }) {
                const [selectedLinks, setSelectedLinks] = React.useState(currentLinks || []);
                const ALL_PAGES = {
                    dashboard: { title: 'Dashboard', icon: 'LayoutDashboard' },
                    outsourcingDistribution: { title: 'Distribuição', icon: 'MapPin' },
                    branchTransfer: { title: 'Troca de Filial', icon: 'ArrowLeftRight' },
                    displacements: { title: 'Deslocamentos', icon: 'ArrowLeftRight' },
                    additionalCities: { title: 'Adicional Cidades', icon: 'Building' },
                    fixedPrices: { title: 'Preço Fixo', icon: 'DollarSign' },
                    branchManagement: { title: 'Cadastro de Filiais', icon: 'Building', adminOnly: true },
                    equipmentManagement: { title: 'Cadastro de Equipamentos', icon: 'Truck', adminOnly: true },
                    userManagement: { title: 'Cadastro de Usuários', icon: 'Users', adminOnly: true },
                };
                const availablePages = Object.keys(ALL_PAGES).filter(key => {
                    return userRole === 'administrador' || !ALL_PAGES[key].adminOnly;
                });
                const handleLinkChange = (pageKey) => {
                    const newSelectedLinks = [...selectedLinks];
                    const index = newSelectedLinks.indexOf(pageKey);

                    if (index > -1) {
                        newSelectedLinks.splice(index, 1);
                    } else {
                        if (newSelectedLinks.length < 9) {
                            newSelectedLinks.push(pageKey);
                        } else {
                            alert("Você pode selecionar no máximo 9 atalhos.");
                        }
                    }
                    setSelectedLinks(newSelectedLinks);
                };

                return React.createElement('div', { className: "fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50" },
                    React.createElement('div', { className: "bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg" },
                        React.createElement('h2', { className: "text-2xl font-bold mb-6 text-center" }, "Editar Atalhos da Página Inicial"),
                        React.createElement('p', {className: "text-center text-gray-600 mb-6"}, "Selecione até 9 atalhos para exibir na sua página inicial."),
                        React.createElement('div', { className: "grid grid-cols-2 md:grid-cols-3 gap-4 mb-8" },
                            availablePages.map(key => {
                                const page = ALL_PAGES[key];
                                const isSelected = selectedLinks.includes(key);
                                return React.createElement('div', {
                                    key: key,
                                    onClick: () => handleLinkChange(key),
                                    className: `p-4 border rounded-lg cursor-pointer flex flex-col items-center justify-center text-center transition-colors ${isSelected ? 'bg-blue-100 border-blue-500' : 'hover:bg-gray-100'}`
                                },
                                    React.createElement(LucideIcon, { name: page.icon, className: `h-8 w-8 mb-2 ${isSelected ? 'text-blue-600' : 'text-gray-500'}` }),
                                    React.createElement('span', { className: `text-sm font-medium ${isSelected ? 'text-blue-700' : 'text-gray-700'}` }, page.title)
                                );
                            })
                        ),
                        React.createElement('div', { className: "flex justify-end space-x-4" },
                            React.createElement('button', { onClick: onClose, className: "px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition" }, "Cancelar"),
                            React.createElement('button', { onClick: () => onSave(selectedLinks), className: "px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition" }, "Salvar")
                        )
                    )
                );
            }

            // Componente Principal da Aplicação
            function App() {
                const [userRole, setUserRole] = React.useState(localStorage.getItem('userRole'));
                const [userId, setUserId] = React.useState(localStorage.getItem('userId'));
                const [userFullname, setUserFullname] = React.useState(localStorage.getItem('userFullname'));
                const [quickLinks, setQuickLinks] = React.useState(JSON.parse(localStorage.getItem('quickLinks')) || ['dashboard', 'outsourcingDistribution', 'branchTransfer']);
                const [currentPage, setCurrentPage] = React.useState('quickAccessMenu');
                const [toast, setToast] = React.useState({ show: false, message: '', type: '' });
                const [isSidebarOpen, setIsSidebarOpen] = React.useState(false);
                const [openMenu, setOpenMenu] = React.useState('');
                const [isSidebarCollapsed, setIsSidebarCollapsed] = React.useState(false);
                const [isEditModalOpen, setIsEditModalOpen] = React.useState(false);

                const handleLogin = (role, id, fullname, links) => { 
                    setUserRole(role);
                    setUserId(id); 
                    setUserFullname(fullname);
                    setQuickLinks(links || []);
                };
                const handleLogout = () => { 
                    localStorage.clear();
                    setUserRole(null); 
                    setUserId(null);
                    setUserFullname(null);
                    setQuickLinks([]);
                };
                const showToast = (message, type = 'success') => setToast({ show: true, message, type });
                const closeToast = () => setToast({ show: false, message: '', type: '' });
                
                const toggleMenu = (menu) => {
                    if (isSidebarCollapsed) {
                        setIsSidebarCollapsed(false);
                    } else {
                        setOpenMenu(openMenu === menu ? '' : menu);
                    }
                };

                const toggleSidebarCollapse = () => {
                    setIsSidebarCollapsed(!isSidebarCollapsed);
                    if (!isSidebarCollapsed) {
                        setOpenMenu('');
                    }
                };

                const handleSaveQuickLinks = async (newLinks) => {
                    try {
                        const { error } = await supabase
                            .from('app_users')
                            .update({ quick_access_links: newLinks })
                            .eq('username', userId);
                        if (error) throw error;

                        localStorage.setItem('quickLinks', JSON.stringify(newLinks));
                        setQuickLinks(newLinks);
                        showToast('Atalhos salvos com sucesso!', 'success');
                        setIsEditModalOpen(false);
                    } catch (err) {
                        showToast('Erro ao salvar os atalhos.', 'error');
                        console.error("Erro ao salvar atalhos:", err);
                    }
                };

                if (!userRole) return React.createElement(LoginPage, { onLogin: handleLogin });

                const MenuItem = ({ page, icon, text }) => {
                   const isActive = currentPage === page;
                   return (
                     React.createElement('li', null,
                        React.createElement('button', {
                           onClick: () => { setCurrentPage(page); setIsSidebarOpen(false); },
                           className: `flex items-center w-full px-4 py-2 rounded-lg transition-colors ${isSidebarCollapsed ? 'justify-center' : ''} ${isActive ? 'bg-blue-600 text-white' : 'hover:bg-gray-700 text-gray-300'}`
                        },
                        React.createElement(LucideIcon, { name: icon, className: `h-5 w-5 ${!isSidebarCollapsed && 'mr-3'}` }),
                        !isSidebarCollapsed && text
                       )
                     )
                   );
                };

                const MenuCategory = ({ title, icon, children, menuKey }) => {
                    const isOpen = openMenu === menuKey;
                    return (
                        React.createElement('li', { className: "mb-2" },
                            React.createElement('button', {
                                onClick: () => toggleMenu(menuKey),
                                className: `flex items-center w-full px-4 py-2 rounded-lg transition-colors ${isSidebarCollapsed ? 'justify-center' : 'justify-between'} ${isOpen && !isSidebarCollapsed ? 'bg-gray-700' : 'hover:bg-gray-700'} text-gray-200`
                            },
                                React.createElement('span', {className: 'flex items-center'},
                                    React.createElement(LucideIcon, { name: icon, className: `h-5 w-5 ${!isSidebarCollapsed && 'mr-3'}` }),
                                    !isSidebarCollapsed && title
                                ),
                                !isSidebarCollapsed && React.createElement(LucideIcon, { name: isOpen ? "ChevronUp" : "ChevronDown", className: "h-5 w-5" })
                            ),
                            !isSidebarCollapsed && isOpen && React.createElement('ul', { className: "ml-6 mt-2 space-y-2" }, children)
                        )
                    );
                };

                const renderPage = () => {
                    switch (currentPage) {
                        case 'dashboard': return React.createElement(Dashboard, { userId, showToast });
                        case 'outsourcingDistribution': return React.createElement(OutsourcingDistribution, { userId, showToast, setCurrentPage });
                        case 'branchTransfer': return React.createElement(BranchTransfer, { userId, setCurrentPage, showToast });
                        case 'displacements': return React.createElement(Displacements, { userId, userRole, showToast });
                        case 'additionalCities': return React.createElement(AdditionalCities, { userId, userRole, showToast });
                        case 'fixedPrices': return React.createElement(FixedPrices, { userId, userRole, showToast });
                        case 'branchManagement': return userRole === 'administrador' ? React.createElement(BranchManagement, { userId, userRole, showToast }) : null;
                        case 'equipmentManagement': return userRole === 'administrador' ? React.createElement(EquipmentManagement, { userId, showToast }) : null;
                        case 'userManagement': return userRole === 'administrador' ? React.createElement(UserManagement, { userId, showToast }) : null;
                        case 'quickAccessMenu':
                        default: return React.createElement(QuickAccessMenu, { setCurrentPage, userFullname, quickLinks, onEdit: () => setIsEditModalOpen(true) });
                    }
                };

                return (
                    React.createElement('div', { className: "flex min-h-screen bg-gray-100" },
                        React.createElement('aside', { className: `fixed inset-y-0 left-0 bg-gray-800 text-white p-4 transform ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} md:relative md:translate-x-0 transition-all duration-300 z-30 flex flex-col rounded-r-xl ${isSidebarCollapsed ? 'w-20' : 'w-64'}` },
                            React.createElement('div', { className: `flex items-center mb-8 ${isSidebarCollapsed ? 'justify-center' : 'justify-between md:justify-center'}` },
                                !isSidebarCollapsed && React.createElement('img', { src: "https://gfivmnnysomfwrffybeh.supabase.co/storage/v1/object/public/logo//LOGO_TERSYS-removebg-preview%20(1).png", alt: "TERSYS Logo", className: "h-12 cursor-pointer", onClick: () => setCurrentPage('quickAccessMenu') }),
                                isSidebarCollapsed && React.createElement(LucideIcon, {name: 'Building', className: 'h-8 w-8 cursor-pointer', onClick: toggleSidebarCollapse}),
                                !isSidebarCollapsed && React.createElement('button', { onClick: () => setIsSidebarOpen(false), className: "md:hidden text-white" }, React.createElement(LucideIcon, { name: "X" }))
                            ),
                            React.createElement('nav', { className: "flex-grow" },
                                React.createElement('ul', { className: "space-y-2" },
                                     React.createElement(MenuCategory, { title: "Dashboard", icon: "LayoutDashboard", menuKey: "dashboard" },
                                        React.createElement(MenuItem, { page: 'dashboard', icon: 'Truck', text: 'Equipamentos' }),
                                        React.createElement(MenuItem, { page: 'outsourcingDistribution', icon: 'MapPin', text: 'Distribuição' })
                                    ),
                                     React.createElement(MenuCategory, { title: "Operacional", icon: "Settings", menuKey: "operacional" },
                                        React.createElement(MenuItem, { page: 'branchTransfer', icon: 'ArrowLeftRight', text: 'Troca de Filial' })
                                     ),
                                     React.createElement(MenuCategory, { title: "Precificação", icon: "DollarSign", menuKey: "pricing" },
                                        React.createElement(MenuItem, { page: 'fixedPrices', icon: 'DollarSign', text: 'Preço Fixo' }),
                                        React.createElement(MenuItem, { page: 'displacements', icon: 'ArrowLeftRight', text: 'Deslocamentos' }),
                                        React.createElement(MenuItem, { page: 'additionalCities', icon: 'Building', text: 'Adicional Cidades' })
                                     ),
                                     userRole === 'administrador' && React.createElement(MenuCategory, { title: "Cadastro", icon: "PlusCircle", menuKey: "cadastro" },
                                        React.createElement(MenuItem, { page: 'branchManagement', icon: 'Building', text: 'Filiais' }),
                                        React.createElement(MenuItem, { page: 'equipmentManagement', icon: 'Truck', text: 'Equipamentos' }),
                                        React.createElement(MenuItem, { page: 'userManagement', icon: 'Users', text: 'Usuários' })
                                    )
                                )
                            ),
                            React.createElement('div', {className: 'mt-auto pt-4 border-t border-gray-700'},
                                React.createElement('button', { onClick: toggleSidebarCollapse, className: "w-full flex items-center p-3 rounded-lg text-gray-400 hover:bg-gray-700 justify-center mb-2" },
                                    React.createElement(LucideIcon, { name: isSidebarCollapsed ? "ChevronsRight" : "ChevronsLeft", className: "w-6 h-6" })
                                ),
                                React.createElement('button', { onClick: handleLogout, className: `w-full flex items-center p-3 rounded-lg text-red-400 hover:bg-gray-700 ${isSidebarCollapsed ? 'justify-center' : ''}` },
                                    React.createElement(LucideIcon, { name: "LogOut", className: `w-6 h-6 ${!isSidebarCollapsed && 'mr-3'}` }),
                                    !isSidebarCollapsed && 'Sair'
                                )
                            )
                        ),
                        React.createElement('main', { className: "flex-1 p-4 md:p-8 flex flex-col" },
                            React.createElement('header', { className: "w-full bg-white p-4 rounded-xl shadow-lg mb-8 flex justify-between items-center" },
                                React.createElement('button', { className: "md:hidden text-gray-700 p-2", onClick: () => setIsSidebarOpen(true) }, React.createElement(LucideIcon, { name: "Menu" })),
                                React.createElement('div', { className: "text-right text-sm text-gray-600" },
                                    React.createElement('p', null, "Nome: ", React.createElement('strong', null, userFullname)),
                                    React.createElement('p', {className: "capitalize"}, "Função: ", React.createElement('strong', null, userRole))
                                )
                            ),
                            React.createElement('div', { className: "flex-grow" }, renderPage()),
                            toast.show && React.createElement(Toast, { message: toast.message, type: toast.type, onClose: closeToast }),
                             isEditModalOpen && React.createElement(EditShortcutsModal, { 
                                currentLinks: quickLinks, 
                                onClose: () => setIsEditModalOpen(false), 
                                onSave: handleSaveQuickLinks,
                                userRole: userRole
                             })
                        )
                    )
                );
            }
        }
    </script>
</body>
</html>

