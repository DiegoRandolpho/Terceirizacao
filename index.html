<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Placa App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        select { -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: none; }
        select::-ms-expand { display: none; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #e0e0e0; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <script type="text/javascript">
        console.log("Script principal começando a carregar.");
        const icons = {
            FileText: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-text"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L15 2z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>',
            PlusCircle: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus-circle"><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></svg>',
            Search: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>',
            Building: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-building"><rect width="16" height="20" x="4" y="2" rx="2" ry="2"/><path d="M9 22v-4h6v4"/><path d="M8 6h.01"/><path d="M16 6h.01"/><path d="M12 6h.01"/><path d="M12 10h.01"/><path d="M12 14h.01"/><path d="M12 18h.01"/></svg>',
            Truck: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-truck"><path d="M14 18V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v11a1 1 0 0 0 1 1h2"/><path d="M19 18h2a1 1 0 0 0 1-1v-3a1 1 0 0 0-1-1h-1V6a2 2 0 0 0-2-2h-3a2 2 0 0 0-2 2v11a1 1 0 0 0 1 1h2"/><circle cx="7" cy="18" r="2"/><circle cx="17" cy="18" r="2"/></svg>',
            UserCheck: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-check"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><polyline points="22 7 18 11 16 9"/></svg>',
            LogOut: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-log-out"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="17 16 22 12 17 8"/><line x1="22" x2="11" y1="12" y2="12"/></svg>',
            Trash2: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>',
            Menu: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-menu"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>',
            X: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>',
            ChevronDown: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down"><path d="m6 9 6 6 6-6"/></svg>',
            ChevronUp: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-up"><path d="m18 15-6-6-6 6"/></svg>',
            LayoutDashboard: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-layout-dashboard"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>',
            CalendarDays: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar-days"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/><path d="M8 14h.01"/><path d="M12 14h.01"/><path d="M16 14h.01"/><path d="M8 18h.01"/><path d="M12 18h.01"/><path d="M16 18h.01"/></svg>',
            User: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>',
            Users: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>',
            Settings: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-settings"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.78 1.28a2 2 0 0 0 .73 2.73l.04.02a2 2 0 0 1 .97 1.95v.44a2 2 0 0 1-.97 1.95l-.04.02a2 2 0 0 0-.73 2.73l.78 1.28a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l-.15.08a2 2 0 0 0 2.73-.73l-.78-1.28a2 2 0 0 0-.73-2.73l-.04-.02a2 2 0 0 1-.97-1.95v-.44a2 2 0 0 1 .97-1.95l-.04-.02a2 2 0 0 0 .73-2.73l-.78-1.28a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>',
            ArrowLeftRight: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucude-arrow-left-right"><path d="M8 3L4 7L8 11"/><path d="M4 7h16"/><path d="M16 21l4-4l-4-4"/><path d="M20 17H4"/></svg>',
            ArrowLeft: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-left"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>',
            MapPin: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-map-pin"><path d="M12 18.3a3.3 3.3 0 1 0 0-6.6 3.3 3.3 0 0 0 0 6.6z"/><path d="M12 2C7.58 2 4 5.58 4 10c0 5.57 8 12 8 12s8-6.43 8-12c0-4.42-3.58-8-8-8z"/></svg>',
            Factory: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-factory"><path d="M2 20a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 9.86 2H7.14a2 2 0 0 0-1.66.9l-.82 1.2A2 2 0 0 1 4 6H2v14z"/><path d="M10 10v4"/><path d="M14 10v4"/><path d="M18 10v4"/><path d="M6 10v4"/></svg>',
            Edit: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>',
            Save: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-save"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>',
            Ban: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-ban"><circle cx="12" cy="12" r="10"/><path d="m4.9 4.9 14.2 14.2"/></svg>'
        };
        function LucideIcon({ name, className }) {
            return React.createElement('span', { className: className, dangerouslySetInnerHTML: { __html: icons[name] || '' } });
        }

        function Toast({ message, type, onClose }) {
            const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            const icon = type === 'success' ? '✔' : '✖';
            React.useEffect(() => {
                const timer = setTimeout(() => {
                    onClose();
                }, 3000);
                return () => clearTimeout(timer);
            }, [onClose]);
            return (
                React.createElement('div', { className: `fixed bottom-4 right-4 ${bgColor} text-white p-4 rounded-lg shadow-lg flex items-center space-x-2 z-50 transition-all duration-300 ease-in-out transform translate-y-0 opacity-100` },
                    React.createElement('span', { className: "font-bold text-xl" }, icon),
                    React.createElement('p', null, message),
                    React.createElement('button', { onClick: onClose, className: "ml-4 font-bold opacity-75 hover:opacity-100 transition-opacity" }, 'X')
                )
            );
        }

        function ConfirmationModal({ message, onConfirm, onCancel }) {
            return (
                React.createElement('div', { className: "fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 animate-fade-in" },
                    React.createElement('div', { className: "bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full text-center transform scale-95 animate-scale-in" },
                        React.createElement('p', { className: "text-lg font-semibold text-gray-800 mb-6" }, message),
                        React.createElement('div', { className: "flex justify-center space-x-4" },
                            React.createElement('button', {
                                onClick: onConfirm,
                                className: "px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-300 ease-in-out transform hover:scale-105 shadow-md"
                            }, "Confirmar"),
                            React.createElement('button', {
                                onClick: onCancel,
                                className: "px-6 py-3 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition duration-300 ease-in-out transform hover:scale-105 shadow-md"
                            }, "Cancelar")
                        )
                    )
                )
            );
        }

        window.onload = function() {
            console.log("window.onload disparado.");
            const SUPABASE_URL = 'https://gfivmnnysomfwrffybeh.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdmaXZtbm55c29tZndyZmZ5YmVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMyOTY3NjgsImV4cCI6MjA2ODg3Mjc2OH0.NxetXJoCLh4q9zAqn_olimziI3YP4MAJzB8ed4qf8cg';

            let supabase;

            const initializeSupabaseAndRenderApp = () => {
                try {
                    console.log("Tentando inicializar o cliente Supabase...");
                    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    console.log("Cliente Supabase inicializado com sucesso.");
                    ReactDOM.render(React.createElement(App, null), document.getElementById('root'));
                } catch (e) {
                    console.error("Erro ao inicializar o cliente Supabase:", e);
                    ReactDOM.render(
                        React.createElement('div', { style: { textAlign: 'center', padding: '20px', color: 'red' } },
                            React.createElement('h1', null, 'Erro ao Inicializar Supabase'),
                            React.createElement('p', null, `Ocorreu um erro ao inicializar o cliente Supabase: ${e.message}. Verifique as suas credenciais e a configuração do projeto Supabase.`)
                        ),
                        document.getElementById('root')
                    );
                }
            };
            const supabaseScript = document.createElement('script');
            supabaseScript.src = "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.43.0/dist/umd/supabase.min.js";
            supabaseScript.onload = () => {
                console.log("Biblioteca Supabase carregada com sucesso.");
                initializeSupabaseAndRenderApp();
            };
            supabaseScript.onerror = (error) => {
                console.error("Erro ao carregar a biblioteca Supabase:", error);
                ReactDOM.render(
                    React.createElement('div', { style: { textAlign: 'center', padding: '20px', color: 'red' } },
                        React.createElement('h1', null, 'Erro ao Carregar Aplicação'),
                        React.createElement('p', null, 'A biblioteca Supabase não foi carregada. Por favor, verifique a sua ligação à internet ou o link CDN do Supabase no código HTML.')
                    ),
                    document.getElementById('root')
                );
            };
            document.head.appendChild(supabaseScript);

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            function LoginPage({ onLogin }) {
              const [username, setUsername] = React.useState('');
              const [password, setPassword] = React.useState('');
              const [error, setError] = React.useState('');
              const [isLoggingIn, setIsLoggingIn] = React.useState(false);
              const handleLogin = async (e) => {
                e.preventDefault();
                setIsLoggingIn(true);
                setError('');

                if (!username || !password) {
                  setError('Por favor, insira seu usuário e senha.');
                  setIsLoggingIn(false);
                  return;
                }

                // Removed artificial delay
                let role = null;

                try {
                    console.log("Tentando login com username:", username.toLowerCase(), "e password:", password);
                    const { data, error: fetchError } = await supabase
                      .from('app_users')
                      .select('*')
                      .eq('username', username.toLowerCase())
                      .eq('password', password);
                    console.log("Resultado da consulta Supabase (data):", data);
                    console.log("Resultado da consulta Supabase (erro):", fetchError);
                    if (fetchError) {
                        console.error("Erro ao buscar usuário no Supabase:", fetchError);
                        setError("Erro ao autenticar. Por favor, tente novamente.");
                    } else if (data && data.length > 0) {
                        role = data[0].role;
                        localStorage.setItem('userRole', role);
                        localStorage.setItem('userId', username.toLowerCase());
                    } else {
                        setError('Usuário ou senha inválidos.');
                    }
                } catch (e) {
                    console.error("Erro inesperado ao buscar usuário no Supabase:", e);
                    setError("Erro ao autenticar. Por favor, tente novamente.");
                }

                if (role) {
                  onLogin(role, username.toLowerCase());
                } else {
                  if (!error) {
                    setError('Usuário ou senha inválidos.');
                  }
                }
                setIsLoggingIn(false);
              };

              return (
                React.createElement('div', { className: "flex items-center justify-center min-h-screen bg-gray-100 font-sans" },
                  React.createElement('div', { className: "bg-white p-8 rounded-xl shadow-lg w-full max-w-md" },
                    React.createElement('div', { className: "flex flex-col items-center justify-center mb-6" },
                        React.createElement('h2', { className: "text-4xl font-extrabold text-blue-600 text-center" }, "TERC SISTEMAS")
                    ),
                    error && (
                      React.createElement('div', { className: "bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4", role: "alert" },
                        React.createElement('strong', { className: "font-bold" }, "Erro:"),
                        React.createElement('span', { className: "block sm:inline" }, " ", error)
                      )
                    ),
                    React.createElement('form', { onSubmit: handleLogin },
                      React.createElement('div', { className: "mb-4" },
                        React.createElement('label', { htmlFor: "username", className: "block text-sm font-medium text-gray-700 mb-1" }, "Usuário"),
                        React.createElement('input', {
                          type: "text",
                          id: "username",
                          value: username,
                          onChange: (e) => { setUsername(e.target.value); setError(''); },
                          className: "mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition duration-150 ease-in-out",
                          placeholder: "Digite seu usuário",
                          required: true,
                          disabled: isLoggingIn
                        })
                      ),
                      React.createElement('div', { className: "mb-6" },
                        React.createElement('label', { htmlFor: "password", className: "block text-sm font-medium text-gray-700 mb-1" }, "Senha"),
                        React.createElement('input', {
                          type: "password",
                          id: "password",
                          value: password,
                          onChange: (e) => setPassword(e.target.value),
                          className: "mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition duration-150 ease-in-out",
                          placeholder: "Digite sua senha",
                          required: true,
                          disabled: isLoggingIn
                        })
                      ),
                      React.createElement('button', {
                        type: "submit",
                        className: "w-full inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out transform hover:scale-105",
                        disabled: isLoggingIn
                      },
                      isLoggingIn ? (
                          React.createElement('svg', { className: "animate-spin -ml-1 mr-3 h-5 w-5 text-white", xmlns: "http://www.w3.org/2000/svg", fill: "none", viewBox: "0 0 24 24" },
                            React.createElement('circle', { className: "opacity-25", cx: "12", cy: "12", r: "10", stroke: "currentColor", strokeWidth: "4" }),
                            React.createElement('path', { className: "opacity-75", fill: "currentColor", d: "M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" })
                          )
                        ) : (
                          React.createElement(LucideIcon, { name: "UserCheck", className: "mr-2 h-5 w-5" })
                        ),
                        isLoggingIn ? 'Entrando...' : 'Entrar'
                      )
                    )
                  )
                )
              );
            }

            function BranchManagement({ userId, userRole, showToast }) {
                const [newBranchName, setNewBranchName] = React.useState('');
                const [branches, setBranches] = React.useState([]);
                const [responsibleInput, setResponsibleInput] = React.useState("");
                const [error, setError] = React.useState(null);
                const [isLoading, setIsLoading] = React.useState(false);
                const [showConfirmModal, setShowConfirmModal] = React.useState(false);
                const [branchToDelete, setBranchToDelete] = React.useState(null);
                const [editingBranch, setEditingBranch] = React.useState(null);
                const [originalBranch, setOriginalBranch] = React.useState(null);
                const [availableSupervisors, setAvailableSupervisors] = React.useState([]);

                React.useEffect(() => {
                    if (!userId || !userRole) return;

                    const fetchBranchesAndSupervisors = async () => {
                        setIsLoading(true);

                        const query = supabase.from('filiais').select('*').order('created_at', { ascending: false });
                        if (userRole === 'supervisor') {
                            query.eq('responsible', userId);
                        }
                        const { data: branchesData, error: fetchBranchesError } = await query;

                        if (fetchBranchesError) {
                            console.error("Erro ao buscar filiais:", fetchBranchesError);
                            setError("Erro ao carregar filiais.");
                            showToast("Erro ao carregar filiais.", "error");
                        } else {
                            setBranches(branchesData);
                        }

                        const { data: supervisorsData, error: fetchSupervisorsError } = await supabase
                            .from('app_users')
                            .select('username')
                            .eq('role', 'supervisor')
                            .order('username', { ascending: true });
                        if (fetchSupervisorsError) {
                            console.error("Erro ao buscar supervisores:", fetchSupervisorsError);
                            setError("Erro ao carregar supervisores.");
                            showToast("Erro ao carregar supervisores.", "error");
                        } else {
                            setAvailableSupervisors(supervisorsData.map(u => u.username));
                        }

                        setIsLoading(false);
                    };

                    fetchBranchesAndSupervisors();
                }, [userId, userRole, showToast]);

                const handleAddBranch = async (e) => {
                    e.preventDefault();
                    const trimmedBranchName = newBranchName.trim();

                    if (!trimmedBranchName) {
                        setError("O nome da filial não pode estar vazio.");
                        showToast("O nome da filial não pode estar vazio.", "error");
                        return;
                    }
                    if (!responsibleInput.trim()) {
                        setError("Por favor, selecione um responsável para a nova filial.");
                        showToast("Selecione um responsável.", "error");
                        return;
                    }

                    setIsLoading(true);
                    try {
                        const { data: existingBranches, error: checkError } = await supabase
                            .from('filiais')
                            .select('id')
                            .ilike('name', trimmedBranchName);

                        if (checkError) throw checkError;
                        if (existingBranches && existingBranches.length > 0) {
                            setError("Já existe uma filial com este nome. Por favor, escolha outro.");
                            showToast("Filial já existe.", "error");
                            setIsLoading(false);
                            return;
                        }

                        const { error: insertError } = await supabase
                            .from('filiais')
                            .insert([
                                {
                                    name: trimmedBranchName,
                                    created_by_username: userId,
                                    responsible: responsibleInput.trim(),
                                },
                            ]);
                        if (insertError) throw insertError;

                        setNewBranchName('');
                        setResponsibleInput("");
                        setError(null);
                        showToast("Filial adicionada com sucesso!", "success");

                        const query = supabase.from('filiais').select('*').order('created_at', { ascending: false });
                        if (userRole === 'supervisor') {
                            query.eq('responsible', userId);
                        }
                        const { data } = await query;
                        setBranches(data);
                    } catch (e) {
                        console.error("Erro ao adicionar filial:", e);
                        setError("Erro ao adicionar filial.");
                        showToast("Erro ao adicionar filial.", "error");
                    } finally {
                        setIsLoading(false);
                    }
                };

                const handleEditClick = (branch) => {
                    setEditingBranch({ ...branch });
                    setOriginalBranch({ ...branch });
                };

                const handleCancelEdit = () => {
                    setEditingBranch(null);
                    setOriginalBranch(null);
                    setBranches(prevBranches => prevBranches.map(b => b.id === originalBranch.id ? originalBranch : b ));
                };

                const handleUpdateBranch = async () => {
                    if (!editingBranch) return;
                    const trimmedBranchName = editingBranch.name.trim();

                    if (!trimmedBranchName) {
                        setError("O nome da filial não pode estar vazio.");
                        showToast("O nome da filial não pode estar vazio.", "error");
                        return;
                    }
                    if (!editingBranch.responsible.trim()) {
                        setError("Por favor, selecione um responsável para a filial.");
                        showToast("Selecione um responsável.", "error");
                        return;
                    }
                    setIsLoading(true);
                    try {
                        const { data: existingBranches, error: checkError } = await supabase
                            .from('filiais')
                            .select('id')
                            .ilike('name', trimmedBranchName)
                            .neq('id', editingBranch.id);

                        if (checkError) throw checkError;
                        if (existingBranches && existingBranches.length > 0) {
                            setError("Já existe outra filial com este nome. Por favor, escolha outro.");
                            showToast("Nome de filial duplicado.", "error");
                            setIsLoading(false);
                            return;
                        }

                        const { error: updateError } = await supabase
                            .from('filiais')
                            .update({ name: trimmedBranchName, responsible: editingBranch.responsible.trim() })
                            .eq('id', editingBranch.id);
                        if (updateError) throw updateError;
                        showToast("Filial atualizada com sucesso!", "success");
                        setEditingBranch(null);
                        setOriginalBranch(null);
                        const query = supabase.from('filiais').select('*').order('created_at', { ascending: false });
                        if (userRole === 'supervisor') {
                            query.eq('responsible', userId);
                        }
                        const { data } = await query;
                        setBranches(data);
                    } catch (e) {
                        console.error("Erro ao atualizar filial:", e);
                        setError("Erro ao atualizar filial.");
                        showToast("Erro ao atualizar filial.", "error");
                    } finally {
                        setIsLoading(false);
                    }
                };

                const handleFieldChange = (e, fieldName) => {
                    setEditingBranch(prev => ({ ...prev, [fieldName]: e.target.value }));
                };

                const confirmDeleteBranch = (branch) => {
                    setBranchToDelete(branch);
                    setShowConfirmModal(true);
                };

                const handleDeleteBranch = async () => {
                    if (!branchToDelete) return;
                    setIsLoading(true);
                    setShowConfirmModal(false);
                    try {
                        const { error: deleteError } = await supabase
                            .from('filiais')
                            .delete()
                            .eq('id', branchToDelete.id);
                        if (deleteError) throw deleteError;
                        showToast("Filial excluída com sucesso!", "success");
                        const query = supabase.from('filiais').select('*').order('created_at', { ascending: false });
                        if (userRole === 'supervisor') {
                            query.eq('responsible', userId);
                        }
                        const { data } = await query;
                        setBranches(data);
                    } catch (e) {
                        console.error("Erro ao excluir filial:", e);
                        setError("Erro ao excluir filial.");
                        showToast("Erro ao excluir filial.", "error");
                    } finally {
                        setIsLoading(false);
                        setBranchToDelete(null);
                    }
                };

                return (
                    React.createElement('div', { className: "bg-white p-6 rounded-xl shadow-lg" },
                        React.createElement('h2', { className: "text-2xl font-bold text-gray-800 mb-4 text-center" }, "Cadastro de Filiais"),
                        error && (
                            React.createElement('div', { className: "bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4", role: "alert" },
                                React.createElement('strong', { className: "font-bold" }, "Erro:"),
                                React.createElement('span', { className: "block sm:inline" }, " ", error)
                            )
                        ),
                        React.createElement('form', { onSubmit: handleAddBranch, className: "grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6" },
                            React.createElement('input', { type: "text", value: newBranchName, onChange: (e) => setNewBranchName(e.target.value), className: "flex-grow mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition duration-150 ease-in-out", placeholder: "Nome da nova filial", required: true, disabled: isLoading }),
                            React.createElement('div', { className: "relative" },
                                React.createElement('select', { value: responsibleInput, onChange: (e) => setResponsibleInput(e.target.value), className: "mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm appearance-none pr-8 transition duration-150 ease-in-out", required: true, disabled: isLoading },
                                    React.createElement('option', { value: "" }, "Selecione um Responsável"),
                                    isLoading && availableSupervisors.length === 0 ? (
                                        React.createElement('option', { disabled: true }, "Carregando responsáveis...")
                                    ) : availableSupervisors.length === 0 ? (
                                        React.createElement('option', { disabled: true }, "Nenhum responsável encontrado.")
                                    ) : (
                                        availableSupervisors.map(username =>
                                            React.createElement('option', { key: username, value: username }, username)
                                        )
                                    )
                                ),
                                React.createElement('div', { className: "pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700" },
                                    React.createElement(LucideIcon, { name: "ChevronDown", className: "h-4 w-4" })
                                )
                            ),
                            React.createElement('button', { type: "submit", className: `w-full px-4 py-2 rounded-md font-semibold text-white transition duration-300 ease-in-out shadow-md flex items-center justify-center space-x-2 ${isLoading ? 'bg-gray-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700 transform hover:scale-105'}`, disabled: isLoading },
                                isLoading ? (
                                    React.createElement('svg', { className: "animate-spin h-5 w-5 text-white", xmlns: "http://www.w3.org/2000/svg", fill: "none", viewBox: "0 0 24 24" },
                                        React.createElement('circle', { className: "opacity-25", cx: "12", cy: "12", r: "10", stroke: "currentColor", strokeWidth: "4" }),
                                        React.createElement('path', { className: "opacity-75", fill: "currentColor", d: "M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" })
                                    )
                                ) : (
                                    React.createElement(LucideIcon, { name: "PlusCircle", className: "h-5 w-5" })
                                ),
                                React.createElement('span', null, "Adicionar Filial")
                            )
                        ),
                        React.createElement('div', { className: "bg-gray-50 p-4 rounded-lg shadow-inner mb-6 max-h-96 overflow-y-auto" },
                            branches.length === 0 && !isLoading ? (
                                React.createElement('p', { className: "text-center text-gray-500" }, "Nenhuma filial cadastrada.")
                            ) : (
                                React.createElement('ul', { className: "space-y-3" },
                                    branches.map(branch => (
                                        React.createElement('li', { key: branch.id, className: "bg-white p-4 rounded-lg shadow flex flex-col sm:flex-row justify-between items-center transition-all duration-200 ease-in-out hover:shadow-md" },
                                            editingBranch && editingBranch.id === branch.id ? (
                                                React.createElement(React.Fragment, null,
                                                    React.createElement('input', {
                                                        type: "text",
                                                        value: editingBranch.name,
                                                        onChange: (e) => handleFieldChange(e, 'name'),
                                                        className: "flex-grow w-full sm:w-auto px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm mb-2 sm:mb-0 mr-0 sm:mr-2",
                                                        disabled: isLoading
                                                    }),
                                                    React.createElement('div', { className: "relative w-full sm:w-auto" },
                                                        React.createElement('select', {
                                                            value: editingBranch.responsible,
                                                            onChange: (e) => handleFieldChange(e, 'responsible'),
                                                            className: "mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm appearance-none pr-8 transition duration-150 ease-in-out",
                                                            disabled: isLoading
                                                        },
                                                            React.createElement('option', { value: "" }, "Selecione um Responsável"),
                                                            availableSupervisors.map(username =>
                                                                React.createElement('option', { key: username, value: username }, username)
                                                            )
                                                        ),
                                                        React.createElement('div', { className: "pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700" },
                                                            React.createElement(LucideIcon, { name: "ChevronDown", className: "h-4 w-4" })
                                                        )
                                                    ),
                                                    React.createElement('div', { className: "flex space-x-2 mt-2 sm:mt-0" },
                                                        React.createElement('button', { onClick: handleUpdateBranch, className: `p-2 rounded-full text-white ${isLoading ? 'bg-gray-400' : 'bg-green-500 hover:bg-green-600'} transition-colors duration-200`, disabled: isLoading }, React.createElement(LucideIcon, { name: "Save", className: "h-5 w-5" })),
                                                        React.createElement('button', { onClick: handleCancelEdit, className: "p-2 rounded-full bg-gray-300 hover:bg-gray-400 transition-colors duration-200", disabled: isLoading }, React.createElement(LucideIcon, { name: "X", className: "h-5 w-5" }))
                                                    )
                                                )
                                            ) : (
                                                React.createElement(React.Fragment, null,
                                                    React.createElement('span', { className: "text-gray-700 font-medium flex-grow w-full sm:w-auto" }, `${branch.name} (Responsável: ${branch.responsible})`),
                                                    React.createElement('div', { className: "flex space-x-2 mt-2 sm:mt-0" },
                                                        (userRole === 'admin' || (userRole === 'supervisor' && userId === branch.responsible)) &&
                                                            React.createElement('button', { onClick: () => handleEditClick(branch), className: "p-2 rounded-full bg-blue-500 text-white hover:bg-blue-600 transition-colors duration-200", disabled: isLoading }, React.createElement(LucideIcon, { name: "Edit", className: "h-5 w-5" })),
                                                        userRole === 'admin' &&
                                                            React.createElement('button', { onClick: () => confirmDeleteBranch(branch), className: "p-2 rounded-full bg-red-500 text-white hover:bg-red-600 transition-colors duration-200", disabled: isLoading }, React.createElement(LucideIcon, { name: "Trash2", className: "h-5 w-5" }))
                                                    )
                                                )
                                            )
                                        )
                                    ))
                                )
                            )
                        ),
                        showConfirmModal && React.createElement(ConfirmationModal, {
                            message: `Tem certeza que deseja excluir a filial "${branchToDelete?.name}"?`,
                            onConfirm: handleDeleteBranch,
                            onCancel: () => setShowConfirmModal(false)
                        })
                    )
                );
            }

            function UserManagement({ showToast, userId, userRole }) {
                const [users, setUsers] = React.useState([]);
                const [isLoading, setIsLoading] = React.useState(false);
                const [error, setError] = React.useState(null);
                const [newUser, setNewUser] = React.useState({ username: '', password: '', role: '' });
                const [showConfirmModal, setShowConfirmModal] = React.useState(false);
                const [userToDelete, setUserToDelete] = React.useState(null);
                const [editingUser, setEditingUser] = React.useState(null);
                const [originalUser, setOriginalUser] = React.useState(null);

                React.useEffect(() => {
                    fetchUsers();
                }, []);

                const fetchUsers = async () => {
                    setIsLoading(true);
                    setError(null);
                    try {
                        const { data, error: fetchError } = await supabase
                            .from('app_users')
                            .select('*')
                            .order('created_at', { ascending: false });
                        if (fetchError) throw fetchError;
                        setUsers(data);
                    } catch (e) {
                        console.error("Erro ao buscar usuários:", e);
                        setError("Erro ao carregar usuários.");
                        showToast("Erro ao carregar usuários.", "error");
                    } finally {
                        setIsLoading(false);
                    }
                };

                const handleAddUser = async (e) => {
                    e.preventDefault();
                    if (!newUser.username || !newUser.password || !newUser.role) {
                        setError("Por favor, preencha todos os campos para o novo usuário.");
                        showToast("Preencha todos os campos do usuário.", "error");
                        return;
                    }

                    setIsLoading(true);
                    setError(null);
                    try {
                        const { data: existingUsers, error: checkError } = await supabase
                            .from('app_users')
                            .select('id')
                            .ilike('username', newUser.username.trim());
                        if (checkError) throw checkError;
                        if (existingUsers && existingUsers.length > 0) {
                            setError("Já existe um usuário com este nome. Por favor, escolha outro.");
                            showToast("Usuário já existe.", "error");
                            setIsLoading(false);
                            return;
                        }

                        const { error: insertError } = await supabase
                            .from('app_users')
                            .insert([
                                {
                                    username: newUser.username.trim().toLowerCase(),
                                    password: newUser.password.trim(),
                                    role: newUser.role,
                                },
                            ]);
                        if (insertError) throw insertError;
                        showToast("Usuário adicionado com sucesso!", "success");
                        setNewUser({ username: '', password: '', role: '' });
                        fetchUsers();
                    } catch (e) {
                        console.error("Erro ao adicionar usuário:", e);
                        setError("Erro ao adicionar usuário.");
                        showToast("Erro ao adicionar usuário.", "error");
                    } finally {
                        setIsLoading(false);
                    }
                };

                const handleEditClick = (user) => {
                    setEditingUser({ ...user });
                    setOriginalUser({ ...user });
                };

                const handleCancelEdit = () => {
                    setEditingUser(null);
                    setOriginalUser(null);
                    setUsers(prevUsers => prevUsers.map(u => u.id === originalUser.id ? originalUser : u ));
                };

                const handleUpdateUser = async () => {
                    if (!editingUser) return;
                    if (!editingUser.username || !editingUser.password || !editingUser.role) {
                        setError("Por favor, preencha todos os campos para o usuário.");
                        showToast("Preencha todos os campos do usuário.", "error");
                        return;
                    }

                    setIsLoading(true);
                    setError(null);
                    try {
                        const { data: existingUsers, error: checkError } = await supabase
                            .from('app_users')
                            .select('id')
                            .ilike('username', editingUser.username.trim())
                            .neq('id', editingUser.id);
                        if (checkError) throw checkError;
                        if (existingUsers && existingUsers.length > 0) {
                            setError("Já existe outro usuário com este nome. Por favor, escolha outro.");
                            showToast("Nome de usuário duplicado.", "error");
                            setIsLoading(false);
                            return;
                        }

                        const { error: updateError } = await supabase
                            .from('app_users')
                            .update({
                                username: editingUser.username.trim().toLowerCase(),
                                password: editingUser.password.trim(),
                                role: editingUser.role,
                            })
                            .eq('id', editingUser.id);
                        if (updateError) throw updateError;
                        showToast("Usuário atualizado com sucesso!", "success");
                        setEditingUser(null);
                        setOriginalUser(null);
                        fetchUsers();
                    } catch (e) {
                        console.error("Erro ao atualizar usuário:", e);
                        setError("Erro ao atualizar usuário.");
                        showToast("Erro ao atualizar usuário.", "error");
                    } finally {
                        setIsLoading(false);
                    }
                };

                const handleFieldChange = (e, fieldName) => {
                    setEditingUser(prev => ({ ...prev, [fieldName]: e.target.value }));
                };

                const confirmDeleteUser = (user) => {
                    setUserToDelete(user);
                    setShowConfirmModal(true);
                };

                const handleDeleteUser = async () => {
                    if (!userToDelete) return;
                    setIsLoading(true);
                    setShowConfirmModal(false);
                    try {
                        const { error: deleteError } = await supabase
                            .from('app_users')
                            .delete()
                            .eq('id', userToDelete.id);
                        if (deleteError) throw deleteError;
                        showToast("Usuário excluído com sucesso!", "success");
                        fetchUsers();
                    } catch (e) {
                        console.error("Erro ao excluir usuário:", e);
                        setError("Erro ao excluir usuário.");
                        showToast("Erro ao excluir usuário.", "error");
                    } finally {
                        setIsLoading(false);
                        setUserToDelete(null);
                    }
                };

                return (
                    React.createElement('div', { className: "bg-white p-6 rounded-xl shadow-lg" },
                        React.createElement('h2', { className: "text-2xl font-bold text-gray-800 mb-4 text-center" }, "Gerenciamento de Usuários"),
                        userRole === 'admin' && (
                            React.createElement('form', { onSubmit: handleAddUser, className: "grid grid-cols-1 md:grid-cols-4 gap-4 mb-6" },
                                React.createElement('input', { type: "text", value: newUser.username, onChange: (e) => setNewUser({ ...newUser, username: e.target.value }), className: "mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm", placeholder: "Nome de usuário", required: true, disabled: isLoading }),
                                React.createElement('input', { type: "password", value: newUser.password, onChange: (e) => setNewUser({ ...newUser, password: e.target.value }), className: "mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm", placeholder: "Senha", required: true, disabled: isLoading }),
                                React.createElement('div', { className: "relative" },
                                    React.createElement('select', { value: newUser.role, onChange: (e) => setNewUser({ ...newUser, role: e.target.value }), className: "mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm appearance-none pr-8", required: true, disabled: isLoading },
                                        React.createElement('option', { value: "" }, "Selecione o Cargo"),
                                        React.createElement('option', { value: "admin" }, "Administrador"),
                                        React.createElement('option', { value: "supervisor" }, "Supervisor"),
                                        React.createElement('option', { value: "user" }, "Usuário")
                                    ),
                                    React.createElement('div', { className: "pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700" },
                                        React.createElement(LucideIcon, { name: "ChevronDown", className: "h-4 w-4" })
                                    )
                                ),
                                React.createElement('button', { type: "submit", className: `w-full px-4 py-2 rounded-md font-semibold text-white transition duration-300 ease-in-out shadow-md flex items-center justify-center space-x-2 ${isLoading ? 'bg-gray-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700 transform hover:scale-105'}`, disabled: isLoading },
                                    isLoading ? (
                                        React.createElement('svg', { className: "animate-spin h-5 w-5 text-white", xmlns: "http://www.w3.org/2000/svg", fill: "none", viewBox: "0 0 24 24" },
                                            React.createElement('circle', { className: "opacity-25", cx: "12", cy: "12", r: "10", stroke: "currentColor", strokeWidth: "4" }),
                                            React.createElement('path', { className: "opacity-75", fill: "currentColor", d: "M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" })
                                        )
                                    ) : (
                                        React.createElement(LucideIcon, { name: "PlusCircle", className: "h-5 w-5" })
                                    ),
                                    React.createElement('span', null, "Adicionar Usuário")
                                )
                            )
                        ),
                        error && (
                            React.createElement('div', { className: "bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4", role: "alert" },
                                React.createElement('strong', { className: "font-bold" }, "Erro:"),
                                React.createElement('span', { className: "block sm:inline" }, " ", error)
                            )
                        ),
                        React.createElement('div', { className: "bg-gray-50 p-4 rounded-lg shadow-inner mb-6 max-h-96 overflow-y-auto" },
                            users.length === 0 && !isLoading ? (
                                React.createElement('p', { className: "text-center text-gray-500" }, "Nenhum usuário cadastrado.")
                            ) : (
                                React.createElement('ul', { className: "space-y-3" },
                                    users.map(user => (
                                        React.createElement('li', { key: user.id, className: "bg-white p-4 rounded-lg shadow flex flex-col sm:flex-row justify-between items-center transition-all duration-200 ease-in-out hover:shadow-md" },
                                            editingUser && editingUser.id === user.id ? (
                                                React.createElement(React.Fragment, null,
                                                    React.createElement('input', {
                                                        type: "text",
                                                        value: editingUser.username,
                                                        onChange: (e) => handleFieldChange(e, 'username'),
                                                        className: "flex-grow w-full sm:w-auto px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm mb-2 sm:mb-0 mr-0 sm:mr-2",
                                                        disabled: isLoading
                                                    }),
                                                    React.createElement('input', {
                                                        type: "password",
                                                        value: editingUser.password,
                                                        onChange: (e) => handleFieldChange(e, 'password'),
                                                        className: "flex-grow w-full sm:w-auto px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm mb-2 sm:mb-0 mr-0 sm:mr-2",
                                                        disabled: isLoading
                                                    }),
                                                    React.createElement('div', { className: "relative w-full sm:w-auto" },
                                                        React.createElement('select', {
                                                            value: editingUser.role,
                                                            onChange: (e) => handleFieldChange(e, 'role'),
                                                            className: "mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm appearance-none pr-8 transition duration-150 ease-in-out",
                                                            disabled: isLoading
                                                        },
                                                            React.createElement('option', { value: "admin" }, "Administrador"),
                                                            React.createElement('option', { value: "supervisor" }, "Supervisor"),
                                                            React.createElement('option', { value: "user" }, "Usuário")
                                                        ),
                                                        React.createElement('div', { className: "pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700" },
                                                            React.createElement(LucideIcon, { name: "ChevronDown", className: "h-4 w-4" })
                                                        )
                                                    ),
                                                    React.createElement('div', { className: "flex space-x-2 mt-2 sm:mt-0" },
                                                        React.createElement('button', { onClick: handleUpdateUser, className: `p-2 rounded-full text-white ${isLoading ? 'bg-gray-400' : 'bg-green-500 hover:bg-green-600'} transition-colors duration-200`, disabled: isLoading }, React.createElement(LucideIcon, { name: "Save", className: "h-5 w-5" })),
                                                        React.createElement('button', { onClick: handleCancelEdit, className: "p-2 rounded-full bg-gray-300 hover:bg-gray-400 transition-colors duration-200", disabled: isLoading }, React.createElement(LucideIcon, { name: "X", className: "h-5 w-5" }))
                                                    )
                                                )
                                            ) : (
                                                React.createElement(React.Fragment, null,
                                                    React.createElement('span', { className: "text-gray-700 font-medium flex-grow w-full sm:w-auto" }, `${user.username} (${user.role})`),
                                                    React.createElement('div', { className: "flex space-x-2 mt-2 sm:mt-0" },
                                                        React.createElement('button', { onClick: () => handleEditClick(user), className: "p-2 rounded-full bg-blue-500 text-white hover:bg-blue-600 transition-colors duration-200", disabled: isLoading }, React.createElement(LucideIcon, { name: "Edit", className: "h-5 w-5" })),
                                                        user.username !== userId && React.createElement('button', { onClick: () => confirmDeleteUser(user), className: "p-2 rounded-full bg-red-500 text-white hover:bg-red-600 transition-colors duration-200", disabled: isLoading }, React.createElement(LucideIcon, { name: "Trash2", className: "h-5 w-5" }))
                                                    )
                                                )
                                            )
                                        )
                                    ))
                                )
                            )
                        ),
                        showConfirmModal && React.createElement(ConfirmationModal, {
                            message: `Tem certeza que deseja excluir o usuário "${userToDelete?.username}"?`,
                            onConfirm: handleDeleteUser,
                            onCancel: () => setShowConfirmModal(false)
                        })
                    )
                );
            }

            function VehicleManagement({ showToast, userId, userRole }) {
                const [vehicles, setVehicles] = React.useState([]);
                const [isLoading, setIsLoading] = React.useState(false);
                const [error, setError] = React.useState(null);
                const [newVehicle, setNewVehicle] = React.useState({ plate: '', branch_id: '', type: '', model: '' });
                const [branches, setBranches] = React.useState([]);
                const [showConfirmModal, setShowConfirmModal] = React.useState(false);
                const [vehicleToDelete, setVehicleToDelete] = React.useState(null);
                const [editingVehicle, setEditingVehicle] = React.useState(null);
                const [originalVehicle, setOriginalVehicle] = React.useState(null);

                React.useEffect(() => {
                    fetchVehiclesAndBranches();
                }, [userId, userRole]);

                const fetchVehiclesAndBranches = async () => {
                    setIsLoading(true);
                    setError(null);
                    try {
                        let vehicleQuery = supabase.from('vehicles').select(`
                            *,
                            branch:branch_id (
                                name,
                                responsible
                            )
                        `).order('created_at', { ascending: false });

                        if (userRole === 'supervisor') {
                            vehicleQuery = vehicleQuery.in('branch_id', supabase.from('filiais').select('id').eq('responsible', userId));
                        }

                        const { data: vehiclesData, error: vehiclesError } = await vehicleQuery;
                        if (vehiclesError) throw vehiclesError;
                        setVehicles(vehiclesData);

                        let branchQuery = supabase.from('filiais').select('*').order('name', { ascending: true });
                        if (userRole === 'supervisor') {
                            branchQuery = branchQuery.eq('responsible', userId);
                        }
                        const { data: branchesData, error: branchesError } = await branchQuery;
                        if (branchesError) throw branchesError;
                        setBranches(branchesData);

                    } catch (e) {
                        console.error("Erro ao buscar veículos e filiais:", e);
                        setError("Erro ao carregar veículos ou filiais.");
                        showToast("Erro ao carregar veículos ou filiais.", "error");
                    } finally {
                        setIsLoading(false);
                    }
                };

                const handleAddVehicle = async (e) => {
                    e.preventDefault();
                    if (!newVehicle.plate || !newVehicle.branch_id || !newVehicle.type || !newVehicle.model) {
                        setError("Por favor, preencha todos os campos do veículo.");
                        showToast("Preencha todos os campos do veículo.", "error");
                        return;
                    }

                    setIsLoading(true);
                    setError(null);
                    try {
                        const { data: existingVehicles, error: checkError } = await supabase
                            .from('vehicles')
                            .select('id')
                            .ilike('plate', newVehicle.plate.trim());
                        if (checkError) throw checkError;
                        if (existingVehicles && existingVehicles.length > 0) {
                            setError("Já existe um veículo com esta placa. Por favor, escolha outra.");
                            showToast("Placa já existe.", "error");
                            setIsLoading(false);
                            return;
                        }

                        const { error: insertError } = await supabase
                            .from('vehicles')
                            .insert([
                                {
                                    plate: newVehicle.plate.trim().toUpperCase(),
                                    branch_id: newVehicle.branch_id,
                                    type: newVehicle.type,
                                    model: newVehicle.model,
                                    created_by_username: userId,
                                },
                            ]);
                        if (insertError) throw insertError;
                        showToast("Veículo adicionado com sucesso!", "success");
                        setNewVehicle({ plate: '', branch_id: '', type: '', model: '' });
                        fetchVehiclesAndBranches();
                    } catch (e) {
                        console.error("Erro ao adicionar veículo:", e);
                        setError("Erro ao adicionar veículo.");
                        showToast("Erro ao adicionar veículo.", "error");
                    } finally {
                        setIsLoading(false);
                    }
                };

                const handleEditClick = (vehicle) => {
                    setEditingVehicle({ ...vehicle });
                    setOriginalVehicle({ ...vehicle });
                };

                const handleCancelEdit = () => {
                    setEditingVehicle(null);
                    setOriginalVehicle(null);
                    setVehicles(prevVehicles => prevVehicles.map(v => v.id === originalVehicle.id ? originalVehicle : v ));
                };

                const handleUpdateVehicle = async () => {
                    if (!editingVehicle) return;
                    if (!editingVehicle.plate || !editingVehicle.branch_id || !editingVehicle.type || !editingVehicle.model) {
                        setError("Por favor, preencha todos os campos do veículo.");
                        showToast("Preencha todos os campos do veículo.", "error");
                        return;
                    }

                    setIsLoading(true);
                    setError(null);
                    try {
                        const { data: existingVehicles, error: checkError } = await supabase
                            .from('vehicles')
                            .select('id')
                            .ilike('plate', editingVehicle.plate.trim())
                            .neq('id', editingVehicle.id);
                        if (checkError) throw checkError;
                        if (existingVehicles && existingVehicles.length > 0) {
                            setError("Já existe outro veículo com esta placa. Por favor, escolha outra.");
                            showToast("Placa duplicada.", "error");
                            setIsLoading(false);
                            return;
                        }

                        const { error: updateError } = await supabase
                            .from('vehicles')
                            .update({
                                plate: editingVehicle.plate.trim().toUpperCase(),
                                branch_id: editingVehicle.branch_id,
                                type: editingVehicle.type,
                                model: editingVehicle.model,
                            })
                            .eq('id', editingVehicle.id);
                        if (updateError) throw updateError;
                        showToast("Veículo atualizado com sucesso!", "success");
                        setEditingVehicle(null);
                        setOriginalVehicle(null);
                        fetchVehiclesAndBranches();
                    } catch (e) {
                        console.error("Erro ao atualizar veículo:", e);
                        setError("Erro ao atualizar veículo.");
                        showToast("Erro ao atualizar veículo.", "error");
                    } finally {
                        setIsLoading(false);
                    }
                };

                const handleFieldChange = (e, fieldName) => {
                    setEditingVehicle(prev => ({ ...prev, [fieldName]: e.target.value }));
                };

                const confirmDeleteVehicle = (vehicle) => {
                    setVehicleToDelete(vehicle);
                    setShowConfirmModal(true);
                };

                const handleDeleteVehicle = async () => {
                    if (!vehicleToDelete) return;
                    setIsLoading(true);
                    setShowConfirmModal(false);
                    try {
                        const { error: deleteError } = await supabase
                            .from('vehicles')
                            .delete()
                            .eq('id', vehicleToDelete.id);
                        if (deleteError) throw deleteError;
                        showToast("Veículo excluído com sucesso!", "success");
                        fetchVehiclesAndBranches();
                    } catch (e) {
                        console.error("Erro ao excluir veículo:", e);
                        setError("Erro ao excluir veículo.", e);
                        showToast("Erro ao excluir veículo.", "error");
                    } finally {
                        setIsLoading(false);
                        setVehicleToDelete(null);
                    }
                };

                return (
                    React.createElement('div', { className: "bg-white p-6 rounded-xl shadow-lg" },
                        React.createElement('h2', { className: "text-2xl font-bold text-gray-800 mb-4 text-center" }, "Gerenciamento de Veículos"),
                        React.createElement('form', { onSubmit: handleAddVehicle, className: "grid grid-cols-1 md:grid-cols-5 gap-4 mb-6" },
                            React.createElement('input', { type: "text", value: newVehicle.plate, onChange: (e) => setNewVehicle({ ...newVehicle, plate: e.target.value }), className: "mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm", placeholder: "Placa", required: true, disabled: isLoading }),
                            React.createElement('div', { className: "relative" },
                                React.createElement('select', { value: newVehicle.branch_id, onChange: (e) => setNewVehicle({ ...newVehicle, branch_id: e.target.value }), className: "mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm appearance-none pr-8", required: true, disabled: isLoading },
                                    React.createElement('option', { value: "" }, "Selecione a Filial"),
                                    branches.map(branch =>
                                        React.createElement('option', { key: branch.id, value: branch.id }, branch.name)
                                    )
                                ),
                                React.createElement('div', { className: "pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700" },
                                    React.createElement(LucideIcon, { name: "ChevronDown", className: "h-4 w-4" })
                                )
                            ),
                            React.createElement('input', { type: "text", value: newVehicle.type, onChange: (e) => setNewVehicle({ ...newVehicle, type: e.target.value }), className: "mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm", placeholder: "Tipo (ex: Caminhão)", required: true, disabled: isLoading }),
                            React.createElement('input', { type: "text", value: newVehicle.model, onChange: (e) => setNewVehicle({ ...newVehicle, model: e.target.value }), className: "mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm", placeholder: "Modelo (ex: Volvo FH)", required: true, disabled: isLoading }),
                            React.createElement('button', { type: "submit", className: `w-full px-4 py-2 rounded-md font-semibold text-white transition duration-300 ease-in-out shadow-md flex items-center justify-center space-x-2 ${isLoading ? 'bg-gray-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700 transform hover:scale-105'}`, disabled: isLoading },
                                isLoading ? (
                                    React.createElement('svg', { className: "animate-spin h-5 w-5 text-white", xmlns: "http://www.w3.org/2000/svg", fill: "none", viewBox: "0 0 24 24" },
                                        React.createElement('circle', { className: "opacity-25", cx: "12", cy: "12", r: "10", stroke: "currentColor", strokeWidth: "4" }),
                                        React.createElement('path', { className: "opacity-75", fill: "currentColor", d: "M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" })
                                    )
                                ) : (
                                    React.createElement(LucideIcon, { name: "PlusCircle", className: "h-5 w-5" })
                                ),
                                React.createElement('span', null, "Adicionar Veículo")
                            )
                        ),
                        error && (
                            React.createElement('div', { className: "bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4", role: "alert" },
                                React.createElement('strong', { className: "font-bold" }, "Erro:"),
                                React.createElement('span', { className: "block sm:inline" }, " ", error)
                            )
                        ),
                        React.createElement('div', { className: "bg-gray-50 p-4 rounded-lg shadow-inner mb-6 max-h-96 overflow-y-auto" },
                            vehicles.length === 0 && !isLoading ? (
                                React.createElement('p', { className: "text-center text-gray-500" }, "Nenhum veículo cadastrado.")
                            ) : (
                                React.createElement('ul', { className: "space-y-3" },
                                    vehicles.map(vehicle => (
                                        React.createElement('li', { key: vehicle.id, className: "bg-white p-4 rounded-lg shadow flex flex-col sm:flex-row justify-between items-center transition-all duration-200 ease-in-out hover:shadow-md" },
                                            editingVehicle && editingVehicle.id === vehicle.id ? (
                                                React.createElement(React.Fragment, null,
                                                    React.createElement('input', {
                                                        type: "text",
                                                        value: editingVehicle.plate,
                                                        onChange: (e) => handleFieldChange(e, 'plate'),
                                                        className: "flex-grow w-full sm:w-auto px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm mb-2 sm:mb-0 mr-0 sm:mr-2",
                                                        disabled: isLoading
                                                    }),
                                                    React.createElement('div', { className: "relative w-full sm:w-auto" },
                                                        React.createElement('select', {
                                                            value: editingVehicle.branch_id,
                                                            onChange: (e) => handleFieldChange(e, 'branch_id'),
                                                            className: "mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm appearance-none pr-8 transition duration-150 ease-in-out",
                                                            disabled: isLoading
                                                        },
                                                            React.createElement('option', { value: "" }, "Selecione a Filial"),
                                                            branches.map(branch =>
                                                                React.createElement('option', { key: branch.id, value: branch.id }, branch.name)
                                                            )
                                                        ),
                                                        React.createElement('div', { className: "pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700" },
                                                            React.createElement(LucideIcon, { name: "ChevronDown", className: "h-4 w-4" })
                                                        )
                                                    ),
                                                    React.createElement('input', {
                                                        type: "text",
                                                        value: editingVehicle.type,
                                                        onChange: (e) => handleFieldChange(e, 'type'),
                                                        className: "flex-grow w-full sm:w-auto px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm mb-2 sm:mb-0 mr-0 sm:mr-2",
                                                        disabled: isLoading
                                                    }),
                                                    React.createElement('input', {
                                                        type: "text",
                                                        value: editingVehicle.model,
                                                        onChange: (e) => handleFieldChange(e, 'model'),
                                                        className: "flex-grow w-full sm:w-auto px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm mb-2 sm:mb-0 mr-0 sm:mr-2",
                                                        disabled: isLoading
                                                    }),
                                                    React.createElement('div', { className: "flex space-x-2 mt-2 sm:mt-0" },
                                                        (userRole === 'admin' || (userRole === 'supervisor' && userId === vehicle.branch.responsible)) &&
                                                            React.createElement('button', { onClick: handleUpdateVehicle, className: `p-2 rounded-full text-white ${isLoading ? 'bg-gray-400' : 'bg-green-500 hover:bg-green-600'} transition-colors duration-200`, disabled: isLoading }, React.createElement(LucideIcon, { name: "Save", className: "h-5 w-5" })),
                                                        React.createElement('button', { onClick: handleCancelEdit, className: "p-2 rounded-full bg-gray-300 hover:bg-gray-400 transition-colors duration-200", disabled: isLoading }, React.createElement(LucideIcon, { name: "X", className: "h-5 w-5" }))
                                                    )
                                                )
                                            ) : (
                                                React.createElement(React.Fragment, null,
                                                    React.createElement('span', { className: "text-gray-700 font-medium flex-grow w-full sm:w-auto" }, `${vehicle.plate} - ${vehicle.type} (${vehicle.model}) - Filial: ${vehicle.branch ? vehicle.branch.name : 'N/A'}`),
                                                    React.createElement('div', { className: "flex space-x-2 mt-2 sm:mt-0" },
                                                        (userRole === 'admin' || (userRole === 'supervisor' && userId === vehicle.branch.responsible)) &&
                                                            React.createElement('button', { onClick: () => handleEditClick(vehicle), className: "p-2 rounded-full bg-blue-500 text-white hover:bg-blue-600 transition-colors duration-200", disabled: isLoading }, React.createElement(LucideIcon, { name: "Edit", className: "h-5 w-5" })),
                                                        (userRole === 'admin' || (userRole === 'supervisor' && userId === vehicle.branch.responsible)) &&
                                                            React.createElement('button', { onClick: () => confirmDeleteVehicle(vehicle), className: "p-2 rounded-full bg-red-500 text-white hover:bg-red-600 transition-colors duration-200", disabled: isLoading }, React.createElement(LucideIcon, { name: "Trash2", className: "h-5 w-5" }))
                                                    )
                                                )
                                            )
                                        )
                                    ))
                                )
                            )
                        ),
                        showConfirmModal && React.createElement(ConfirmationModal, {
                            message: `Tem certeza que deseja excluir o veículo com a placa "${vehicleToDelete?.plate}"?`,
                            onConfirm: handleDeleteVehicle,
                            onCancel: () => setShowConfirmModal(false)
                        })
                    )
                );
            }

            function MaintenanceManagement({ showToast, userId, userRole }) {
                const [maintenances, setMaintenances] = React.useState([]);
                const [isLoading, setIsLoading] = React.useState(false);
                const [error, setError] = React.useState(null);
                const [newMaintenance, setNewMaintenance] = React.useState({ vehicle_id: '', description: '', cost: '', date: '' });
                const [vehicles, setVehicles] = React.useState([]);
                const [showConfirmModal, setShowConfirmModal] = React.useState(false);
                const [maintenanceToDelete, setMaintenanceToDelete] = React.useState(null);
                const [editingMaintenance, setEditingMaintenance] = React.useState(null);
                const [originalMaintenance, setOriginalMaintenance] = React.useState(null);

                React.useEffect(() => {
                    fetchMaintenancesAndVehicles();
                }, [userId, userRole]);

                const fetchMaintenancesAndVehicles = async () => {
                    setIsLoading(true);
                    setError(null);
                    try {
                        let maintenanceQuery = supabase.from('maintenances').select(`
                            *,
                            vehicle:vehicle_id (
                                plate,
                                branch:branch_id (
                                    responsible
                                )
                            )
                        `).order('date', { ascending: false });

                        if (userRole === 'supervisor') {
                            maintenanceQuery = maintenanceQuery.in('vehicle_id', supabase.from('vehicles').select('id').in('branch_id', supabase.from('filiais').select('id').eq('responsible', userId)));
                        }

                        const { data: maintenancesData, error: maintenancesError } = await maintenanceQuery;
                        if (maintenancesError) throw maintenancesError;
                        setMaintenances(maintenancesData);

                        let vehicleQuery = supabase.from('vehicles').select('*').order('plate', { ascending: true });
                        if (userRole === 'supervisor') {
                            vehicleQuery = vehicleQuery.in('branch_id', supabase.from('filiais').select('id').eq('responsible', userId));
                        }
                        const { data: vehiclesData, error: vehiclesError } = await vehicleQuery;
                        if (vehiclesError) throw vehiclesError;
                        setVehicles(vehiclesData);

                    } catch (e) {
                        console.error("Erro ao buscar manutenções e veículos:", e);
                        setError("Erro ao carregar manutenções ou veículos.");
                        showToast("Erro ao carregar manutenções ou veículos.", "error");
                    } finally {
                        setIsLoading(false);
                    }
                };

                const handleAddMaintenance = async (e) => {
                    e.preventDefault();
                    if (!newMaintenance.vehicle_id || !newMaintenance.description || !newMaintenance.cost || !newMaintenance.date) {
                        setError("Por favor, preencha todos os campos da manutenção.");
                        showToast("Preencha todos os campos da manutenção.", "error");
                        return;
                    }

                    setIsLoading(true);
                    setError(null);
                    try {
                        const { error: insertError } = await supabase
                            .from('maintenances')
                            .insert([
                                {
                                    vehicle_id: newMaintenance.vehicle_id,
                                    description: newMaintenance.description.trim(),
                                    cost: parseFloat(newMaintenance.cost),
                                    date: newMaintenance.date,
                                    recorded_by_username: userId,
                                },
                            ]);
                        if (insertError) throw insertError;
                        showToast("Manutenção adicionada com sucesso!", "success");
                        setNewMaintenance({ vehicle_id: '', description: '', cost: '', date: '' });
                        fetchMaintenancesAndVehicles();
                    } catch (e) {
                        console.error("Erro ao adicionar manutenção:", e);
                        setError("Erro ao adicionar manutenção.");
                        showToast("Erro ao adicionar manutenção.", "error");
                    } finally {
                        setIsLoading(false);
                    }
                };

                const handleEditClick = (maintenance) => {
                    setEditingMaintenance({ ...maintenance, date: maintenance.date.split('T')[0] });
                    setOriginalMaintenance({ ...maintenance });
                };

                const handleCancelEdit = () => {
                    setEditingMaintenance(null);
                    setOriginalMaintenance(null);
                    setMaintenances(prevMaintenances => prevMaintenances.map(m => m.id === originalMaintenance.id ? originalMaintenance : m ));
                };

                const handleUpdateMaintenance = async () => {
                    if (!editingMaintenance) return;
                    if (!editingMaintenance.vehicle_id || !editingMaintenance.description || !editingMaintenance.cost || !editingMaintenance.date) {
                        setError("Por favor, preencha todos os campos da manutenção.");
                        showToast("Preencha todos os campos da manutenção.", "error");
                        return;
                    }

                    setIsLoading(true);
                    setError(null);
                    try {
                        const { error: updateError } = await supabase
                            .from('maintenances')
                            .update({
                                vehicle_id: editingMaintenance.vehicle_id,
                                description: editingMaintenance.description.trim(),
                                cost: parseFloat(editingMaintenance.cost),
                                date: editingMaintenance.date,
                            })
                            .eq('id', editingMaintenance.id);
                        if (updateError) throw updateError;
                        showToast("Manutenção atualizada com sucesso!", "success");
                        setEditingMaintenance(null);
                        setOriginalMaintenance(null);
                        fetchMaintenancesAndVehicles();
                    } catch (e) {
                        console.error("Erro ao atualizar manutenção:", e);
                        setError("Erro ao atualizar manutenção.");
                        showToast("Erro ao atualizar manutenção.", "error");
                    } finally {
                        setIsLoading(false);
                    }
                };

                const handleFieldChange = (e, fieldName) => {
                    setEditingMaintenance(prev => ({ ...prev, [fieldName]: e.target.value }));
                };

                const confirmDeleteMaintenance = (maintenance) => {
                    setMaintenanceToDelete(maintenance);
                    setShowConfirmModal(true);
                };

                const handleDeleteMaintenance = async () => {
                    if (!maintenanceToDelete) return;
                    setIsLoading(true);
                    setShowConfirmModal(false);
                    try {
                        const { error: deleteError } = await supabase
                            .from('maintenances')
                            .delete()
                            .eq('id', maintenanceToDelete.id);
                        if (deleteError) throw deleteError;
                        showToast("Manutenção excluída com sucesso!", "success");
                        fetchMaintenancesAndVehicles();
                    } catch (e) {
                        console.error("Erro ao excluir manutenção:", e);
                        setError("Erro ao excluir manutenção.", e);
                        showToast("Erro ao excluir manutenção.", "error");
                    } finally {
                        setIsLoading(false);
                        setMaintenanceToDelete(null);
                    }
                };

                return (
                    React.createElement('div', { className: "bg-white p-6 rounded-xl shadow-lg" },
                        React.createElement('h2', { className: "text-2xl font-bold text-gray-800 mb-4 text-center" }, "Gerenciamento de Manutenções"),
                        React.createElement('form', { onSubmit: handleAddMaintenance, className: "grid grid-cols-1 md:grid-cols-5 gap-4 mb-6" },
                            React.createElement('div', { className: "relative" },
                                React.createElement('select', { value: newMaintenance.vehicle_id, onChange: (e) => setNewMaintenance({ ...newMaintenance, vehicle_id: e.target.value }), className: "mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm appearance-none pr-8", required: true, disabled: isLoading },
                                    React.createElement('option', { value: "" }, "Selecione o Veículo"),
                                    vehicles.map(vehicle =>
                                        React.createElement('option', { key: vehicle.id, value: vehicle.id }, vehicle.plate)
                                    )
                                ),
                                React.createElement('div', { className: "pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700" },
                                    React.createElement(LucideIcon, { name: "ChevronDown", className: "h-4 w-4" })
                                )
                            ),
                            React.createElement('input', { type: "text", value: newMaintenance.description, onChange: (e) => setNewMaintenance({ ...newMaintenance, description: e.target.value }), className: "mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm", placeholder: "Descrição", required: true, disabled: isLoading }),
                            React.createElement('input', { type: "number", value: newMaintenance.cost, onChange: (e) => setNewMaintenance({ ...newMaintenance, cost: e.target.value }), className: "mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm", placeholder: "Custo", required: true, disabled: isLoading }),
                            React.createElement('input', { type: "date", value: newMaintenance.date, onChange: (e) => setNewMaintenance({ ...newMaintenance, date: e.target.value }), className: "mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm", placeholder: "Data", required: true, disabled: isLoading }),
                            React.createElement('button', { type: "submit", className: `w-full px-4 py-2 rounded-md font-semibold text-white transition duration-300 ease-in-out shadow-md flex items-center justify-center space-x-2 ${isLoading ? 'bg-gray-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700 transform hover:scale-105'}`, disabled: isLoading },
                                isLoading ? (
                                    React.createElement('svg', { className: "animate-spin h-5 w-5 text-white", xmlns: "http://www.w3.org/2000/svg", fill: "none", viewBox: "0 0 24 24" },
                                        React.createElement('circle', { className: "opacity-25", cx: "12", cy="12", r="10", stroke="currentColor", strokeWidth="4" }),
                                        React.createElement('path', { className: "opacity-75", fill: "currentColor", d: "M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" })
                                    )
                                ) : (
                                    React.createElement(LucideIcon, { name: "PlusCircle", className: "h-5 w-5" })
                                ),
                                React.createElement('span', null, "Adicionar Manutenção")
                            )
                        ),
                        error && (
                            React.createElement('div', { className: "bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4", role: "alert" },
                                React.createElement('strong', { className: "font-bold" }, "Erro:"),
                                React.createElement('span', { className: "block sm:inline" }, " ", error)
                            )
                        ),
                        React.createElement('div', { className: "bg-gray-50 p-4 rounded-lg shadow-inner mb-6 max-h-96 overflow-y-auto" },
                            maintenances.length === 0 && !isLoading ? (
                                React.createElement('p', { className: "text-center text-gray-500" }, "Nenhuma manutenção cadastrada.")
                            ) : (
                                React.createElement('ul', { className: "space-y-3" },
                                    maintenances.map(maintenance => (
                                        React.createElement('li', { key: maintenance.id, className: "bg-white p-4 rounded-lg shadow flex flex-col sm:flex-row justify-between items-center transition-all duration-200 ease-in-out hover:shadow-md" },
                                            editingMaintenance && editingMaintenance.id === maintenance.id ? (
                                                React.createElement(React.Fragment, null,
                                                    React.createElement('div', { className: "relative w-full sm:w-auto" },
                                                        React.createElement('select', {
                                                            value: editingMaintenance.vehicle_id,
                                                            onChange: (e) => handleFieldChange(e, 'vehicle_id'),
                                                            className: "mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm appearance-none pr-8 transition duration-150 ease-in-out",
                                                            disabled: isLoading
                                                        },
                                                            vehicles.map(vehicle =>
                                                                React.createElement('option', { key: vehicle.id, value: vehicle.id }, vehicle.plate)
                                                            )
                                                        ),
                                                        React.createElement('div', { className: "pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700" },
                                                            React.createElement(LucideIcon, { name: "ChevronDown", className: "h-4 w-4" })
                                                        )
                                                    ),
                                                    React.createElement('input', {
                                                        type: "text",
                                                        value: editingMaintenance.description,
                                                        onChange: (e) => handleFieldChange(e, 'description'),
                                                        className: "flex-grow w-full sm:w-auto px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm mb-2 sm:mb-0 mr-0 sm:mr-2",
                                                        disabled: isLoading
                                                    }),
                                                    React.createElement('input', {
                                                        type: "number",
                                                        value: editingMaintenance.cost,
                                                        onChange: (e) => handleFieldChange(e, 'cost'),
                                                        className: "flex-grow w-full sm:w-auto px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm mb-2 sm:mb-0 mr-0 sm:mr-2",
                                                        disabled: isLoading
                                                    }),
                                                    React.createElement('input', {
                                                        type: "date",
                                                        value: editingMaintenance.date,
                                                        onChange: (e) => handleFieldChange(e, 'date'),
                                                        className: "flex-grow w-full sm:w-auto px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm mb-2 sm:mb-0 mr-0 sm:mr-2",
                                                        disabled: isLoading
                                                    }),
                                                    React.createElement('div', { className: "flex space-x-2 mt-2 sm:mt-0" },
                                                        (userRole === 'admin' || (userRole === 'supervisor' && userId === maintenance.vehicle.branch.responsible)) &&
                                                            React.createElement('button', { onClick: handleUpdateMaintenance, className: `p-2 rounded-full text-white ${isLoading ? 'bg-gray-400' : 'bg-green-500 hover:bg-green-600'} transition-colors duration-200`, disabled: isLoading }, React.createElement(LucideIcon, { name: "Save", className: "h-5 w-5" })),
                                                        React.createElement('button', { onClick: handleCancelEdit, className: "p-2 rounded-full bg-gray-300 hover:bg-gray-400 transition-colors duration-200", disabled: isLoading }, React.createElement(LucideIcon, { name: "X", className: "h-5 w-5" }))
                                                    )
                                                )
                                            ) : (
                                                React.createElement(React.Fragment, null,
                                                    React.createElement('span', { className: "text-gray-700 font-medium flex-grow w-full sm:w-auto" }, `Placa: ${maintenance.vehicle ? maintenance.vehicle.plate : 'N/A'} - Descrição: ${maintenance.description} - Custo: R$ ${maintenance.cost ? maintenance.cost.toFixed(2) : '0.00'} - Data: ${maintenance.date}`),
                                                    React.createElement('div', { className: "flex space-x-2 mt-2 sm:mt-0" },
                                                        (userRole === 'admin' || (userRole === 'supervisor' && maintenance.vehicle && userId === maintenance.vehicle.branch.responsible)) &&
                                                            React.createElement('button', { onClick: () => handleEditClick(maintenance), className: "p-2 rounded-full bg-blue-500 text-white hover:bg-blue-600 transition-colors duration-200", disabled: isLoading }, React.createElement(LucideIcon, { name: "Edit", className: "h-5 w-5" })),
                                                        (userRole === 'admin' || (userRole === 'supervisor' && maintenance.vehicle && userId === maintenance.vehicle.branch.responsible)) &&
                                                            React.createElement('button', { onClick: () => confirmDeleteMaintenance(maintenance), className: "p-2 rounded-full bg-red-500 text-white hover:bg-red-600 transition-colors duration-200", disabled: isLoading }, React.createElement(LucideIcon, { name: "Trash2", className: "h-5 w-5" }))
                                                    )
                                                )
                                            )
                                        )
                                    ))
                                )
                            )
                        ),
                        showConfirmModal && React.createElement(ConfirmationModal, {
                            message: `Tem certeza que deseja excluir a manutenção na data "${maintenanceToDelete?.date}" para o veículo "${maintenanceToDelete?.vehicle?.plate}"?`,
                            onConfirm: handleDeleteMaintenance,
                            onCancel: () => setShowConfirmModal(false)
                        })
                    )
                );
            }

            function ReportManagement({ showToast, userId, userRole }) {
                const [reportType, setReportType] = React.useState('');
                const [startDate, setStartDate] = React.useState('');
                const [endDate, setEndDate] = React.useState('');
                const [results, setResults] = React.useState([]);
                const [isLoading, setIsLoading] = React.useState(false);
                const [error, setError] = React.useState(null);

                const generateReport = async () => {
                    if (!reportType || !startDate || !endDate) {
                        setError("Por favor, selecione o tipo de relatório e o período.");
                        showToast("Selecione tipo e período do relatório.", "error");
                        return;
                    }
                    setIsLoading(true);
                    setError(null);
                    setResults([]);

                    try {
                        let data;
                        if (reportType === 'maintenances_by_vehicle') {
                            let query = supabase.from('maintenances').select(`
                                description,
                                cost,
                                date,
                                vehicle:vehicle_id (
                                    plate,
                                    type,
                                    model,
                                    branch:branch_id (
                                        name,
                                        responsible
                                    )
                                )
                            `)
                            .gte('date', startDate)
                            .lte('date', endDate)
                            .order('date', { ascending: false });

                            if (userRole === 'supervisor') {
                                query = query.in('vehicle_id', supabase.from('vehicles').select('id').in('branch_id', supabase.from('filiais').select('id').eq('responsible', userId)));
                            }
                            const { data: reportData, error: reportError } = await query;
                            if (reportError) throw reportError;
                            data = reportData.map(m => ({
                                Placa: m.vehicle?.plate || 'N/A',
                                Tipo: m.vehicle?.type || 'N/A',
                                Modelo: m.vehicle?.model || 'N/A',
                                Filial: m.vehicle?.branch?.name || 'N/A',
                                Responsável_Filial: m.vehicle?.branch?.responsible || 'N/A',
                                Descrição: m.description,
                                Custo: `R$ ${m.cost ? m.cost.toFixed(2) : '0.00'}`,
                                Data: m.date,
                            }));
                        } else if (reportType === 'vehicle_allocation') {
                            let query = supabase.from('vehicles').select(`
                                plate,
                                type,
                                model,
                                branch:branch_id (
                                    name,
                                    responsible
                                )
                            `);

                            if (userRole === 'supervisor') {
                                query = query.eq('branch_id', supabase.from('filiais').select('id').eq('responsible', userId));
                            }
                            const { data: reportData, error: reportError } = await query;
                            if (reportError) throw reportError;
                            data = reportData.map(v => ({
                                Placa: v.plate,
                                Tipo: v.type,
                                Modelo: v.model,
                                Filial: v.branch?.name || 'N/A',
                                Responsável_Filial: v.branch?.responsible || 'N/A',
                            }));
                        } else if (reportType === 'branch_details') {
                            if (userRole !== 'admin') {
                                setError("Apenas administradores podem gerar relatórios de detalhes de filiais.");
                                showToast("Acesso negado.", "error");
                                setIsLoading(false);
                                return;
                            }
                            const { data: reportData, error: reportError } = await supabase.from('filiais').select(`
                                name,
                                responsible,
                                created_at
                            `);
                            if (reportError) throw reportError;
                            data = reportData.map(b => ({
                                Nome: b.name,
                                Responsável: b.responsible,
                                Criado_Em: b.created_at,
                            }));
                        } else if (reportType === 'user_activity') {
                            if (userRole !== 'admin') {
                                setError("Apenas administradores podem gerar relatórios de atividade de usuário.");
                                showToast("Acesso negado.", "error");
                                setIsLoading(false);
                                return;
                            }
                            const { data: reportData, error: reportError } = await supabase.from('app_users').select(`
                                username,
                                role,
                                created_at
                            `);
                            if (reportError) throw reportError;
                            data = reportData.map(u => ({
                                Usuário: u.username,
                                Cargo: u.role,
                                Criado_Em: u.created_at,
                            }));
                        }
                        setResults(data);
                        showToast("Relatório gerado com sucesso!", "success");
                    } catch (e) {
                        console.error("Erro ao gerar relatório:", e);
                        setError("Erro ao gerar relatório.");
                        showToast("Erro ao gerar relatório.", "error");
                    } finally {
                        setIsLoading(false);
                    }
                };

                const convertToCSV = (arr) => {
                    const array = [Object.keys(arr[0])].concat(arr);
                    return array.map(it => {
                        return Object.values(it).toString();
                    }).join('\n');
                };

                const downloadCSV = () => {
                    if (results.length === 0) {
                        showToast("Não há dados para exportar.", "error");
                        return;
                    }
                    const csvString = convertToCSV(results);
                    const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.setAttribute('download', `${reportType}_report.csv`);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                };

                return (
                    React.createElement('div', { className: "bg-white p-6 rounded-xl shadow-lg" },
                        React.createElement('h2', { className: "text-2xl font-bold text-gray-800 mb-4 text-center" }, "Relatórios"),
                        React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-4 gap-4 mb-6" },
                            React.createElement('div', { className: "relative" },
                                React.createElement('select', { value: reportType, onChange: (e) => setReportType(e.target.value), className: "mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm appearance-none pr-8", disabled: isLoading },
                                    React.createElement('option', { value: "" }, "Selecione o Tipo de Relatório"),
                                    React.createElement('option', { value: "maintenances_by_vehicle" }, "Manutenções por Veículo"),
                                    React.createElement('option', { value: "vehicle_allocation" }, "Alocação de Veículos"),
                                    userRole === 'admin' && React.createElement('option', { value: "branch_details" }, "Detalhes de Filiais"),
                                    userRole === 'admin' && React.createElement('option', { value: "user_activity" }, "Atividade de Usuários")
                                ),
                                React.createElement('div', { className: "pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700" },
                                    React.createElement(LucideIcon, { name: "ChevronDown", className: "h-4 w-4" })
                                )
                            ),
                            React.createElement('input', { type: "date", value: startDate, onChange: (e) => setStartDate(e.target.value), className: "mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm", placeholder: "Data Início", required: true, disabled: isLoading }),
                            React.createElement('input', { type: "date", value: endDate, onChange: (e) => setEndDate(e.target.value), className: "mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm", placeholder: "Data Fim", required: true, disabled: isLoading }),
                            React.createElement('button', { onClick: generateReport, className: `w-full px-4 py-2 rounded-md font-semibold text-white transition duration-300 ease-in-out shadow-md flex items-center justify-center space-x-2 ${isLoading ? 'bg-gray-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700 transform hover:scale-105'}`, disabled: isLoading },
                                isLoading ? (
                                    React.createElement('svg', { className: "animate-spin h-5 w-5 text-white", xmlns: "http://www.w3.org/2000/svg", fill: "none", viewBox: "0 0 24 24" },
                                        React.createElement('circle', { className: "opacity-25", cx: "12", cy="12", r="10", stroke="currentColor", strokeWidth="4" }),
                                        React.createElement('path', { className: "opacity-75", fill="currentColor", d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" })
                                    )
                                ) : (
                                    React.createElement(LucideIcon, { name: "FileText", className: "h-5 w-5" })
                                ),
                                React.createElement('span', null, "Gerar Relatório")
                            )
                        ),
                        error && (
                            React.createElement('div', { className: "bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4", role: "alert" },
                                React.createElement('strong', { className: "font-bold" }, "Erro:"),
                                React.createElement('span', { className: "block sm:inline" }, " ", error)
                            )
                        ),
                        results.length > 0 && (
                            React.createElement('div', { className: "bg-gray-50 p-4 rounded-lg shadow-inner mb-6 max-h-96 overflow-y-auto" },
                                React.createElement('table', { className: "min-w-full divide-y divide-gray-200" },
                                    React.createElement('thead', { className: "bg-gray-50" },
                                        React.createElement('tr', null,
                                            Object.keys(results[0]).map(key =>
                                                React.createElement('th', { key: key, scope: "col", className: "px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" }, key)
                                            )
                                        )
                                    ),
                                    React.createElement('tbody', { className: "bg-white divide-y divide-gray-200" },
                                        results.map((row, index) =>
                                            React.createElement('tr', { key: index },
                                                Object.values(row).map((value, idx) =>
                                                    React.createElement('td', { key: idx, className: "px-6 py-4 whitespace-nowrap text-sm text-gray-900" }, value)
                                                )
                                            )
                                        )
                                    )
                                )
                            )
                        ),
                        results.length > 0 && (
                            React.createElement('button', { onClick: downloadCSV, className: `w-full px-4 py-2 rounded-md font-semibold text-white transition duration-300 ease-in-out shadow-md flex items-center justify-center space-x-2 ${isLoading ? 'bg-gray-400 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700 transform hover:scale-105'}`, disabled: isLoading },
                                React.createElement(LucideIcon, { name: "Save", className: "h-5 w-5" }),
                                React.createElement('span', null, "Exportar para CSV")
                            )
                        )
                    )
                );
            }

            function Dashboard({ userId, userRole, showToast }) {
                const [metrics, setMetrics] = React.useState({
                    totalBranches: 0,
                    totalVehicles: 0,
                    totalUsers: 0,
                    totalMaintenanceCost: 0
                });
                const [recentActivities, setRecentActivities] = React.useState([]);
                const [isLoading, setIsLoading] = React.useState(true);
                const [error, setError] = React.useState(null);

                React.useEffect(() => {
                    fetchDashboardData();
                }, [userId, userRole]);

                const fetchDashboardData = async () => {
                    setIsLoading(true);
                    setError(null);
                    try {
                        // Fetch total branches
                        let branchesQuery = supabase.from('filiais').select('id, responsible', { count: 'exact' });
                        if (userRole === 'supervisor') {
                            branchesQuery = branchesQuery.eq('responsible', userId);
                        }
                        const { count: totalBranchesCount, error: branchesCountError } = await branchesQuery;
                        if (branchesCountError) throw branchesCountError;

                        // Fetch total vehicles
                        let vehiclesQuery = supabase.from('vehicles').select('id, branch_id', { count: 'exact' });
                        if (userRole === 'supervisor') {
                            vehiclesQuery = vehiclesQuery.in('branch_id', supabase.from('filiais').select('id').eq('responsible', userId));
                        }
                        const { count: totalVehiclesCount, error: vehiclesCountError } = await vehiclesQuery;
                        if (vehiclesCountError) throw vehiclesCountError;

                        // Fetch total users (only for admin)
                        let totalUsersCount = 0;
                        if (userRole === 'admin') {
                            const { count, error: usersCountError } = await supabase.from('app_users').select('id', { count: 'exact' });
                            if (usersCountError) throw usersCountError;
                            totalUsersCount = count;
                        }

                        // Fetch total maintenance cost
                        let maintenanceCostQuery = supabase.from('maintenances').select('cost');
                        if (userRole === 'supervisor') {
                            maintenanceCostQuery = maintenanceCostQuery.in('vehicle_id', supabase.from('vehicles').select('id').in('branch_id', supabase.from('filiais').select('id').eq('responsible', userId)));
                        }
                        const { data: maintenancesData, error: maintenancesError } = await maintenanceCostQuery;
                        if (maintenancesError) throw maintenancesError;
                        const totalMaintenanceCost = maintenancesData.reduce((sum, m) => sum + m.cost, 0);

                        // Fetch recent activities (e.g., last 5 maintenances)
                        let recentMaintenanceQuery = supabase.from('maintenances').select(`
                            description,
                            date,
                            cost,
                            vehicle:vehicle_id (
                                plate,
                                branch:branch_id (
                                    name,
                                    responsible
                                )
                            )
                        `).order('created_at', { ascending: false }).limit(5);

                        if (userRole === 'supervisor') {
                            recentMaintenanceQuery = recentMaintenanceQuery.in('vehicle_id', supabase.from('vehicles').select('id').in('branch_id', supabase.from('filiais').select('id').eq('responsible', userId)));
                        }
                        const { data: recentActivitiesData, error: recentActivitiesError } = await recentMaintenanceQuery;
                        if (recentActivitiesError) throw recentActivitiesError;

                        setMetrics({
                            totalBranches: totalBranchesCount,
                            totalVehicles: totalVehiclesCount,
                            totalUsers: totalUsersCount,
                            totalMaintenanceCost: totalMaintenanceCost
                        });
                        setRecentActivities(recentActivitiesData);

                    } catch (e) {
                        console.error("Erro ao carregar dados do dashboard:", e);
                        setError("Erro ao carregar dados do dashboard.");
                        showToast("Erro ao carregar dados do dashboard.", "error");
                    } finally {
                        setIsLoading(false);
                    }
                };

                return (
                    React.createElement('div', { className: "bg-white p-6 rounded-xl shadow-lg" },
                        React.createElement('h2', { className: "text-2xl font-bold text-gray-800 mb-6 text-center" }, "Dashboard"),
                        isLoading ? (
                            React.createElement('div', { className: "flex justify-center items-center h-48" },
                                React.createElement('svg', { className: "animate-spin h-8 w-8 text-blue-600", xmlns: "http://www.w3.org/2000/svg", fill: "none", viewBox: "0 0 24 24" },
                                    React.createElement('circle', { className: "opacity-25", cx: "12", cy: "12", r: "10", stroke: "currentColor", strokeWidth: "4" }),
                                    React.createElement('path', { className: "opacity-75", fill: "currentColor", d: "M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" })
                                )
                            )
                        ) : error ? (
                            React.createElement('div', { className: "bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative", role: "alert" },
                                React.createElement('strong', { className: "font-bold" }, "Erro:"),
                                React.createElement('span', { className: "block sm:inline" }, " ", error)
                            )
                        ) : (
                            React.createElement(React.Fragment, null,
                                React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8" },
                                    React.createElement('div', { className: "bg-blue-500 text-white p-5 rounded-lg shadow-md flex items-center justify-between transform hover:scale-105 transition-transform duration-200" },
                                        React.createElement('div', null,
                                            React.createElement('p', { className: "text-lg font-semibold" }, "Total de Filiais"),
                                            React.createElement('p', { className: "text-3xl font-bold" }, metrics.totalBranches)
                                        ),
                                        React.createElement(LucideIcon, { name: "Building", className: "h-12 w-12 opacity-75" })
                                    ),
                                    React.createElement('div', { className: "bg-green-500 text-white p-5 rounded-lg shadow-md flex items-center justify-between transform hover:scale-105 transition-transform duration-200" },
                                        React.createElement('div', null,
                                            React.createElement('p', { className: "text-lg font-semibold" }, "Total de Veículos"),
                                            React.createElement('p', { className: "text-3xl font-bold" }, metrics.totalVehicles)
                                        ),
                                        React.createElement(LucideIcon, { name: "Truck", className: "h-12 w-12 opacity-75" })
                                    ),
                                    userRole === 'admin' && React.createElement('div', { className: "bg-purple-500 text-white p-5 rounded-lg shadow-md flex items-center justify-between transform hover:scale-105 transition-transform duration-200" },
                                        React.createElement('div', null,
                                            React.createElement('p', { className: "text-lg font-semibold" }, "Total de Usuários"),
                                            React.createElement('p', { className: "text-3xl font-bold" }, metrics.totalUsers)
                                        ),
                                        React.createElement(LucideIcon, { name: "Users", className: "h-12 w-12 opacity-75" })
                                    ),
                                    React.createElement('div', { className: "bg-red-500 text-white p-5 rounded-lg shadow-md flex items-center justify-between transform hover:scale-105 transition-transform duration-200" },
                                        React.createElement('div', null,
                                            React.createElement('p', { className: "text-lg font-semibold" }, "Custo Total Manutenção"),
                                            React.createElement('p', { className: "text-3xl font-bold" }, `R$ ${metrics.totalMaintenanceCost.toFixed(2)}`)
                                        ),
                                        React.createElement(LucideIcon, { name: "CalendarDays", className: "h-12 w-12 opacity-75" })
                                    )
                                ),
                                React.createElement('div', { className: "bg-gray-50 p-4 rounded-lg shadow-inner" },
                                    React.createElement('h3', { className: "text-xl font-bold text-gray-800 mb-4" }, "Atividades Recentes de Manutenção"),
                                    recentActivities.length === 0 ? (
                                        React.createElement('p', { className: "text-center text-gray-500" }, "Nenhuma atividade recente de manutenção.")
                                    ) : (
                                        React.createElement('ul', { className: "space-y-3" },
                                            recentActivities.map((activity, index) => (
                                                React.createElement('li', { key: index, className: "bg-white p-3 rounded-lg shadow flex items-center space-x-3" },
                                                    React.createElement(LucideIcon, { name: "FileText", className: "h-6 w-6 text-blue-500" }),
                                                    React.createElement('div', null,
                                                        React.createElement('p', { className: "text-gray-800 font-medium" }, `Veículo: ${activity.vehicle?.plate || 'N/A'} - ${activity.description}`),
                                                        React.createElement('p', { className: "text-gray-600 text-sm" }, `Custo: R$ ${activity.cost.toFixed(2)} - Data: ${activity.date} - Filial: ${activity.vehicle?.branch?.name || 'N/A'}`)
                                                    )
                                                )
                                            ))
                                        )
                                    )
                                )
                            )
                        )
                    )
                );
            }

            function App() {
                const [loggedIn, setLoggedIn] = React.useState(false);
                const [userRole, setUserRole] = React.useState(null);
                const [userId, setUserId] = React.useState(null);
                const [activeMenu, setActiveMenu] = React.useState('dashboard');
                const [isMobileMenuOpen, setIsMobileMenuOpen] = React.useState(false);
                const [toast, setToast] = React.useState(null);

                React.useEffect(() => {
                    const storedRole = localStorage.getItem('userRole');
                    const storedUserId = localStorage.getItem('userId');
                    if (storedRole && storedUserId) {
                        setUserRole(storedRole);
                        setUserId(storedUserId);
                        setLoggedIn(true);
                    }
                }, []);

                const handleLogin = (role, id) => {
                    setUserRole(role);
                    setUserId(id);
                    setLoggedIn(true);
                    setActiveMenu('dashboard');
                    showToast("Login bem-sucedido!", "success");
                };

                const handleLogout = () => {
                    localStorage.removeItem('userRole');
                    localStorage.removeItem('userId');
                    setUserRole(null);
                    setUserId(null);
                    setLoggedIn(false);
                    showToast("Você foi desconectado.", "success");
                };

                const showToast = (message, type) => {
                    setToast({ message, type });
                };

                const closeToast = () => {
                    setToast(null);
                };

                if (!loggedIn) {
                    return React.createElement(LoginPage, { onLogin: handleLogin });
                }

                return (
                    React.createElement('div', { className: "flex h-screen bg-gray-100" },
                        React.createElement('div', { className: `fixed inset-y-0 left-0 transform ${isMobileMenuOpen ? 'translate-x-0' : '-translate-x-full'} md:relative md:translate-x-0 transition duration-200 ease-in-out bg-gray-800 text-white w-64 p-5 flex flex-col z-40` },
                            React.createElement('div', { className: "flex items-center justify-between mb-8" },
                                React.createElement('h1', { className: "text-3xl font-bold text-blue-400" }, "PlacaApp"),
                                React.createElement('button', { className: "md:hidden text-white", onClick: () => setIsMobileMenuOpen(false) },
                                    React.createElement(LucideIcon, { name: "X", className: "h-6 w-6" })
                                )
                            ),
                            React.createElement('nav', { className: "flex-grow" },
                                React.createElement('ul', { className: "space-y-3" },
                                    React.createElement('li', null,
                                        React.createElement('a', { href: "#", onClick: () => { setActiveMenu('dashboard'); setIsMobileMenuOpen(false); }, className: `flex items-center space-x-3 p-3 rounded-lg transition duration-200 hover:bg-gray-700 ${activeMenu === 'dashboard' ? 'bg-blue-600' : ''}` },
                                            React.createElement(LucideIcon, { name: "LayoutDashboard", className: "h-6 w-6" }),
                                            React.createElement('span', { className: "font-medium" }, "Dashboard")
                                        )
                                    ),
                                    (userRole === 'admin' || userRole === 'supervisor') &&
                                    React.createElement('li', null,
                                        React.createElement('a', { href: "#", onClick: () => { setActiveMenu('branch'); setIsMobileMenuOpen(false); }, className: `flex items-center space-x-3 p-3 rounded-lg transition duration-200 hover:bg-gray-700 ${activeMenu === 'branch' ? 'bg-blue-600' : ''}` },
                                            React.createElement(LucideIcon, { name: "Factory", className: "h-6 w-6" }),
                                            React.createElement('span', { className: "font-medium" }, "Filiais")
                                        )
                                    ),
                                    (userRole === 'admin' || userRole === 'supervisor' || userRole === 'user') &&
                                    React.createElement('li', null,
                                        React.createElement('a', { href: "#", onClick: () => { setActiveMenu('vehicle'); setIsMobileMenuOpen(false); }, className: `flex items-center space-x-3 p-3 rounded-lg transition duration-200 hover:bg-gray-700 ${activeMenu === 'vehicle' ? 'bg-blue-600' : ''}` },
                                            React.createElement(LucideIcon, { name: "Truck", className: "h-6 w-6" }),
                                            React.createElement('span', { className: "font-medium" }, "Veículos")
                                        )
                                    ),
                                    (userRole === 'admin' || userRole === 'supervisor' || userRole === 'user') &&
                                    React.createElement('li', null,
                                        React.createElement('a', { href: "#", onClick: () => { setActiveMenu('maintenance'); setIsMobileMenuOpen(false); }, className: `flex items-center space-x-3 p-3 rounded-lg transition duration-200 hover:bg-gray-700 ${activeMenu === 'maintenance' ? 'bg-blue-600' : ''}` },
                                            React.createElement(LucideIcon, { name: "CalendarDays", className: "h-6 w-6" }),
                                            React.createElement('span', { className: "font-medium" }, "Manutenções")
                                        )
                                    ),
                                    (userRole === 'admin' || userRole === 'supervisor') &&
                                    React.createElement('li', null,
                                        React.createElement('a', { href: "#", onClick: () => { setActiveMenu('user'); setIsMobileMenuOpen(false); }, className: `flex items-center space-x-3 p-3 rounded-lg transition duration-200 hover:bg-gray-700 ${activeMenu === 'user' ? 'bg-blue-600' : ''}` },
                                            React.createElement(LucideIcon, { name: "User", className: "h-6 w-6" }),
                                            React.createElement('span', { className: "font-medium" }, "Usuários")
                                        )
                                    ),
                                    (userRole === 'admin' || userRole === 'supervisor' || userRole === 'user') &&
                                    React.createElement('li', null,
                                        React.createElement('a', { href: "#", onClick: () => { setActiveMenu('report'); setIsMobileMenuOpen(false); }, className: `flex items-center space-x-3 p-3 rounded-lg transition duration-200 hover:bg-gray-700 ${activeMenu === 'report' ? 'bg-blue-600' : ''}` },
                                            React.createElement(LucideIcon, { name: "FileText", className: "h-6 w-6" }),
                                            React.createElement('span', { className: "font-medium" }, "Relatórios")
                                        )
                                    )
                                )
                            ),
                            React.createElement('div', { className: "mt-auto" },
                                React.createElement('button', { onClick: handleLogout, className: "flex items-center space-x-3 p-3 rounded-lg transition duration-200 hover:bg-gray-700 w-full" },
                                    React.createElement(LucideIcon, { name: "LogOut", className: "h-6 w-6" }),
                                    React.createElement('span', { className: "font-medium" }, "Sair")
                                )
                            )
                        ),
                        React.createElement('div', { className: "flex-1 flex flex-col overflow-hidden" },
                            React.createElement('header', { className: "flex items-center justify-between p-4 bg-white border-b border-gray-200 shadow-sm md:hidden" },
                                React.createElement('button', { className: "text-gray-600", onClick: () => setIsMobileMenuOpen(true) },
                                    React.createElement(LucideIcon, { name: "Menu", className: "h-6 w-6" })
                                ),
                                React.createElement('h1', { className: "text-2xl font-bold text-gray-800" }, "PlacaApp"),
                                React.createElement('div', { className: "w-6" })
                            ),
                            React.createElement('main', { className: "flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6" },
                                activeMenu === 'dashboard' && React.createElement(Dashboard, { userId: userId, userRole: userRole, showToast: showToast }),
                                activeMenu === 'branch' && React.createElement(BranchManagement, { userId: userId, userRole: userRole, showToast: showToast }),
                                activeMenu === 'vehicle' && React.createElement(VehicleManagement, { userId: userId, userRole: userRole, showToast: showToast }),
                                activeMenu === 'maintenance' && React.createElement(MaintenanceManagement, { userId: userId, userRole: userRole, showToast: showToast }),
                                activeMenu === 'user' && React.createElement(UserManagement, { userId: userId, userRole: userRole, showToast: showToast }),
                                activeMenu === 'report' && React.createElement(ReportManagement, { userId: userId, userRole: userRole, showToast: showToast })
                            )
                        ),
                        toast && React.createElement(Toast, { message: toast.message, type: toast.type, onClose: closeToast })
                    )
                );
            }
        };
    </script>
</body>
</html>
