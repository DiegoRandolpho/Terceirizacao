<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebApp Interno - TercSistemas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>
    <style>:root{--sidebar-width:250px;--navbar-height:60px;--primary-color:#007bff;--secondary-color:#6c757d;--success-color:#28a745;--danger-color:#dc3545;--info-color:#17a2b8;--bg-light:#f8f9fa;--bg-body:#e9ecef;}body{font-family:'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;background-color:var(--bg-body);display:flex;min-height:100vh;overflow-x:hidden;}#navbar{height:var(--navbar-height);background-color:#fff;border-bottom:1px solid #e0e0e0;box-shadow:0 2px 5px rgba(0,0,0,0.05);width:calc(100% - var(--sidebar-width));position:fixed;top:0;left:var(--sidebar-width);z-index:1000;transition:left .3s ease,width .3s ease;}body.sidebar-collapsed #navbar{width:100%;left:0;}.navbar .navbar-brand{font-weight:700;color:var(--primary-color);font-size:1.8rem;}.navbar .nav-link{display:flex;align-items:center;gap:8px;color:var(--secondary-color);}.navbar .nav-link:hover{color:var(--primary-color);}#sidebar{width:var(--sidebar-width);background-color:#2c3e50;color:#ecf0f1;position:fixed;height:100%;top:0;left:0;z-index:1001;padding-top:var(--navbar-height);box-shadow:2px 0 5px rgba(0,0,0,.1);transition:left .3s ease;overflow-y:auto;flex-shrink:0;}body.sidebar-collapsed #sidebar{left:-var(--sidebar-width);}#sidebar .sidebar-header{padding:15px;text-align:center;background-color:#34495e;position:absolute;top:0;left:0;width:100%;height:var(--navbar-height);display:flex;align-items:center;justify-content:center;font-size:1.8rem;font-weight:bold;}#sidebar .sidebar-header img{display:none;}#sidebar .sidebar-header span{color:#fff;}#sidebar .nav-item{border-bottom:1px solid rgba(255,255,255,.08);}#sidebar .nav-link{color:#ecf0f1;padding:15px 20px;display:flex;align-items:center;gap:15px;font-size:1.1rem;transition:background-color .2s ease,color .2s ease;}#sidebar .nav-link:hover,#sidebar .nav-link.active{background-color:#1abc9c;color:#fff;border-radius:0;}#sidebar .nav-link i{font-size:1.3rem;}#contentWrapper{margin-left:var(--sidebar-width);padding-top:var(--navbar-height);flex-grow:1;width:calc(100% - var(--sidebar-width));transition:margin-left .3s ease,width .3s ease;}body.sidebar-collapsed #contentWrapper{margin-left:0;width:100%;}#mainContent{padding:25px;min-height:calc(100vh - var(--navbar-height));}.form-section,.dashboard-section{background-color:#fff;padding:30px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.05);margin-bottom:25px;}h2{font-size:1.8rem;font-weight:600;margin-bottom:30px;text-align:center;color:var(--primary-color);}.form-label{font-weight:600;color:#495057;margin-bottom:8px;}.form-control,.form-select{border-radius:.375rem;border:1px solid #ced4da;padding:.75rem 1rem;transition:border-color .15s ease-in-out,box-shadow .15s ease-in-out;}.form-control:focus,.form-select:focus{border-color:#80bdff;outline:0;box-shadow:0 0 0 .25rem rgba(0,123,255,.25);}.btn{border-radius:.375rem;padding:.75rem 1.25rem;font-weight:600;transition:all .2s ease;}.btn-primary{background-color:var(--primary-color);border-color:var(--primary-color);}.btn-primary:hover{background-color:#0056b3;border-color:#0056b3;}.btn-success{background-color:var(--success-color);border-color:var(--success-color);}.btn-success:hover{background-color:#218838;border-color:#218838;}.btn-danger{background-color:var(--danger-color);border-color:var(--danger-color);}.btn-danger:hover{background-color:#c82333;border-color:#c82333;}.btn-info{background-color:var(--info-color);border-color:var(--info-color);}.btn-info:hover{background-color:#138496;border-color:#138496;}.btn-secondary{background-color:var(--secondary-color);border-color:var(--secondary-color);}.btn-secondary:hover{background-color:#5a6268;border-color:#5a6268;}.message{margin-top:20px;padding:15px;border-radius:8px;font-weight:bold;text-align:center;font-size:1rem;border:1px solid transparent;}.message.alert-success{background-color:#d4edda;color:#155724;border-color:#c3e6cb;}.message.alert-danger{background-color:#f8d7da;color:#721c24;border-color:#f5c6cb;}.message.alert-info{background-color:#d1ecf1;color:#0c5460;border-color:#bee5eb;}.table{margin-top:25px;border-radius:8px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,.05);}.table thead th{background-color:#e9ecef;color:#495057;font-weight:600;padding:15px;border-bottom:2px solid #dee2e6;}.table tbody td{padding:12px;vertical-align:middle;border-bottom:1px solid #e0e0e0;}.table tbody tr:last-child td{border-bottom:none;}.table tbody tr:hover{background-color:#f5f5f5;}.hidden{display:none!important;}.navbar-toggler{border:none;padding:0;font-size:1.5rem;color:var(--secondary-color);display:none;}@media (max-width:768px){.navbar-toggler{display:block;}}:focus{box-shadow:none;}@media (max-width:768px){:root{--sidebar-width:220px;}body #sidebar{left:-var(--sidebar-width);box-shadow:2px 0 10px rgba(0,0,0,.2);}body.sidebar-expanded #sidebar{left:0;}body #navbar,body #contentWrapper{width:100%!important;margin-left:0!important;left:0!important;}}body.logged-out #sidebar,body.logged-out .navbar-top-elements{display:none!important;}body.logged-out #navbar{width:100%!important;left:0!important;}body.logged-out #contentWrapper{margin-left:0!important;width:100%!important;}#kanbanBoard{gap:15px;align-items:flex-start;min-height:400px;}.kanban-column{background-color:#ebecf0;border-radius:8px;padding:15px;min-width:280px;max-width:300px;flex-shrink:0;display:flex;flex-direction:column;box-shadow:0 1px 3px rgba(0,0,0,.1);max-height:calc(100vh - var(--navbar-height) - 160px);overflow-y:auto;}.kanban-column-header{font-weight:bold;font-size:1.1rem;margin-bottom:15px;color:#495057;display:flex;justify-content:space-between;align-items:center;}.kanban-card{background-color:#fff;border-radius:6px;padding:12px;margin-bottom:10px;box-shadow:0 1px 2px rgba(0,0,0,.08);cursor:grab;transition:background-color .2s ease;}.kanban-card:hover{background-color:#f5f5f5;}.kanban-card-title{font-weight:600;font-size:1rem;margin-bottom:5px;color:var(--primary-color);}.kanban-card-meta{font-size:.85rem;color:#6c757d;margin-bottom:3px;}.kanban-card-date{font-size:.8em;color:#888;text-align:right;margin-top:8px;}.kanban-empty-message{text-align:center;color:#6c757d;font-style:italic;padding:20px 0;}.no-data{text-align:center;color:#6c757d;padding:20px;font-size:1.1rem;font-weight:500;}.select2-container--bootstrap-5 .select2-selection{min-height:calc(2.25em + .75rem + 2px);padding:.375rem .75rem;border:1px solid #ced4da;border-radius:.375rem;display:flex;align-items:center;}.select2-container--bootstrap-5.select2-container--focus .select2-selection,.select2-container--bootstrap-5.select2-container--open .select2-selection{border-color:#80bdff;outline:0;box-shadow:0 0 0 .25rem rgba(0,123,255,.25);}.select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__choice{background-color:var(--primary-color);color:#fff;border:1px solid var(--primary-color);border-radius:.2rem;padding:.2rem .5rem;margin-top:.25rem;margin-right:.25rem;}.select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__choice__remove{color:rgba(255,255,255,.7);float:right;margin-left:.2rem;}.select2-container--bootstrap-5 .select2-dropdown{border-color:#ced4da;border-radius:.375rem;box-shadow:0 .5rem 1rem rgba(0,0,0,.15);}.select2-container--bootstrap-5 .select2-results__option--highlighted.select2-results__option--selectable{background-color:var(--primary-color);color:#fff;}.select2-container--bootstrap-5 .select2-results__option--selected{background-color:#e9ecef;color:#495057;}</style>
</head>
<body class="logged-out sidebar-collapsed">
    <nav class="navbar navbar-expand-lg" id="navbar">
        <div class="container-fluid">
            <button class="btn btn-light d-none d-lg-block me-3" type="button" id="desktopSidebarToggleBtn" title="Ocultar/Exibir Menu">
                <i class="bi bi-list"></i>
            </button>
            <button class="navbar-toggler me-3 d-lg-none" type="button" id="mobileSidebarToggleBtn">
                <i class="bi bi-list"></i>
            </button>
            <a class="navbar-brand" href="#">TercSistemas</a>
            <div class="ms-auto d-flex align-items-center navbar-top-elements">
                <a class="nav-link me-3" href="#"><i class="bi bi-cloud-fill"></i></a>
            </div>
        </div>
    </nav>
    <aside id="sidebar" class="d-flex flex-column">
        <div class="sidebar-header d-lg-none"><span>TercSistemas</span></div>
        <ul class="nav flex-column mt-3">
            <li class="nav-item">
                <a class="nav-link active" href="#" data-screen="mainDashboardScreen" id="sidebarDashboardLink">
                    <i class="bi bi-speedometer2"></i> Dashboard
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-bs-toggle="collapse" data-bs-target="#cadastroSubmenu" aria-expanded="false">
                    <i class="bi bi-plus-circle"></i> Cadastro <i class="bi bi-chevron-down ms-auto"></i>
                </a>
                <div class="collapse" id="cadastroSubmenu">
                    <ul class="nav flex-column ms-3">
                        <li class="nav-item" id="cadastroUsuariosNavItem"><a class="nav-link" href="#" data-screen="cadastroUsuariosScreen" id="showCadastroUsuarios"><i class="bi bi-person-fill-add"></i> Usuários</a></li>
                        <li class="nav-item"><a class="nav-link" href="#" data-screen="cadastroFiliaisScreen" id="showCadastroFiliais"><i class="bi bi-shop"></i> Filiais</a></li>
                        <li class="nav-item"><a class="nav-link" href="#" data-screen="cadastroEquipamentosScreen" id="showCadastroEquipamentos"><i class="bi bi-tools"></i> Equipamentos</a></li>
                    </ul>
                </div>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-bs-toggle="collapse" data-bs-target="#operacionalSubmenu" aria-expanded="false">
                    <i class="bi bi-gear"></i> Operacional <i class="bi bi-chevron-down ms-auto"></i>
                </a>
                <div class="collapse" id="operacionalSubmenu">
                    <ul class="nav flex-column ms-3">
                        <li class="nav-item"><a class="nav-link" href="#" data-screen="trocaFilialScreen" id="showTrocaFilial"><i class="bi bi-arrow-left-right"></i> Troca de Filial</a></li>
                    </ul>
                </div>
            </li>
            <li class="nav-item mt-auto">
                <a class="nav-link" href="#" id="sidebarLogoutLink">
                    <i class="bi bi-box-arrow-right"></i> Sair
                </a>
            </li>
        </ul>
    </aside>
    <div id="contentWrapper" class="flex-grow-1">
        <main id="mainContent" class="d-flex flex-column h-100">
            <div id="loginScreen" class="d-flex justify-content-center align-items-center flex-grow-1">
                <div class="card shadow-sm p-4" style="width: 100%; max-width: 400px;">
                    <h2 class="card-title text-center mb-4">Login - TercSistemas</h2>
                    <form id="loginForm">
                        <div class="mb-3">
                            <label for="email" class="form-label">Email:</label>
                            <input type="email" id="email" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">Senha:</label>
                            <input type="password" id="password" class="form-control" required>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg">Entrar</button>
                        </div>
                    </form>
                    <div id="loginMessage" class="message mt-3"></div>
                </div>
            </div>
            <div id="mainDashboardScreen" class="hidden flex-grow-1">
                <h1 class="mb-4">Dashboard de Equipamentos Ativos</h1>
                <div class="dashboard-controls-kanban">
                    <div class="d-flex flex-wrap align-items-center mb-4 gap-3">
                        <div class="input-group flex-grow-1 me-md-2">
                            <span class="input-group-text"><i class="bi bi-calendar-range"></i></span>
                            <input type="date" class="form-control" id="filterStartDate">
                            <span class="input-group-text"><i class="bi bi-arrow-right"></i></span>
                            <input type="date" class="form-control" id="filterEndDate">
                        </div>
                        <div class="input-group flex-grow-1">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                            <input type="text" class="form-control" id="filterSearchInput" placeholder="Pesquisar placa, tipo ou filial...">
                            <button class="btn btn-outline-secondary" type="button" id="clearSearchBtn"><i class="bi bi-x-lg"></i></button>
                        </div>
                        <div class="input-group flex-grow-1">
                            <span class="input-group-text"><i class="bi bi-person"></i></span>
                            <select id="selectResponsavel" class="form-select">
                                <option value="">Todos os Responsáveis</option>
                            </select>
                        </div>
                        <div class="input-group flex-grow-1">
                            <span class="input-group-text"><i class="bi bi-shop"></i></span>
                            <select id="selectFiliais" class="form-select" multiple data-placeholder="Selecione as Filiais"></select>
                        </div>
                        <button class="btn btn-primary" id="filterDashboardBtn"><i class="bi bi-funnel"></i> Aplicar Filtros</button>
                    </div>
                </div>
                <div id="kanbanBoard" class="d-flex flex-nowrap overflow-auto py-3">
                    <p id="kanbanMessage" class="no-data text-center w-100">NENHUM RESULTADO ENCONTRADO COM O FILTRO SELECIONADO!</p>
                </div>
            </div>
            <div id="cadastroUsuariosScreen" class="hidden form-section">
                <button id="backToMainDashboardFromUsuarios" class="btn btn-secondary mb-3">&larr; Voltar</button>
                <h2>Cadastro de Usuários</h2>
                <form id="usuarioForm">
                    <div class="mb-3">
                        <label for="nomeUsuario" class="form-label">Nome Completo:</label>
                        <input type="text" id="nomeUsuario" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="emailUsuario" class="form-label">Email:</label>
                        <input type="email" id="emailUsuario" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="senhaUsuario" class="form-label">Senha:</label>
                        <input type="password" id="senhaUsuario" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="categoriaUsuario" class="form-label">Categoria:</label>
                        <select id="categoriaUsuario" class="form-select" required>
                            <option value="">Selecione...</option>
                            <option value="admin">Administrador</option>
                            <option value="operador">Operador</option>
                            <option value="visualizador">Visualizador</option>
                        </select>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">Cadastrar Usuário</button>
                    </div>
                </form>
                <div id="usuarioMessage" class="message"></div>
                <hr class="my-4">
                <div class="usuario-consulta-section">
                    <h3 class="mb-3"><i class="bi bi-search me-2"></i> Consulta de Usuários</h3>
                    <div class="input-group mb-3">
                        <input type="text" id="usuarioSearchInput" class="form-control" placeholder="Pesquisar por Nome ou Email">
                        <button class="btn btn-outline-secondary" type="button" id="usuarioSearchBtn"><i class="bi bi-search"></i> Buscar</button>
                        <button class="btn btn-outline-danger" type="button" id="usuarioClearSearchBtn"><i class="bi bi-x-lg"></i> Limpar</button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Email</th>
                                    <th>Categoria</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="usuariosTableBody"></tbody>
                        </table>
                    </div>
                    <div id="usuarioConsultaMessage" class="message mt-3"></div>
                </div>
            </div>
            <div id="cadastroFiliaisScreen" class="hidden form-section">
                <button id="backToMainDashboardFromFiliais" class="btn btn-secondary mb-3">&larr; Voltar</button>
                <h2>Cadastro de Filiais</h2>
                <form id="filialForm">
                    <div class="mb-3">
                        <label for="nomeFilial" class="form-label">Nome da Filial:</label>
                        <input type="text" id="nomeFilial" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="responsavelEmail" class="form-label">Responsável (Email ou Nome):</label>
                        <input type="text" id="responsavelEmail" placeholder="Email ou nome do responsável" class="form-control" required>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">Cadastrar Filial</button>
                    </div>
                </form>
                <div id="filialMessage" class="message"></div>
                <hr class="my-4">
                <div class="filial-consulta-section">
                    <h3 class="mb-3"><i class="bi bi-search me-2"></i> Consulta de Filiais</h3>
                    <div class="input-group mb-3">
                        <input type="text" id="filialSearchInput" class="form-control" placeholder="Pesquisar por Filial ou Responsável">
                        <button class="btn btn-outline-secondary" type="button" id="filialSearchBtn"><i class="bi bi-search"></i> Buscar</button>
                        <button class="btn btn-outline-danger" type="button" id="filialClearSearchBtn"><i class="bi bi-x-lg"></i> Limpar</button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Filial</th>
                                    <th>Responsável</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="filiaisTableBody"></tbody>
                        </table>
                    </div>
                    <div id="filialConsultaMessage" class="message mt-3"></div>
                </div>
            </div>
            <div id="cadastroEquipamentosScreen" class="hidden form-section">
                <button id="backToMainDashboardFromEquipamentos" class="btn btn-secondary mb-3">&larr; Voltar</button>
                <h2>Cadastro de Equipamentos</h2>
                <form id="equipamentoForm">
                    <div class="mb-3">
                        <label for="placa" class="form-label">Placa do Equipamento:</label>
                        <input type="text" id="placa" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="tipoEquipamento" class="form-label">Tipo de Equipamento:</label>
                        <select id="tipoEquipamento" class="form-select" required>
                            <option value="">Selecione...</option>
                            <option value="Bomba Lança">Bomba Lança</option>
                            <option value="Bomba Estacionária">Bomba Estacionária</option>
                            <option value="Betoneira">Betoneira</option>
                        </select>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">Cadastrar Equipamento</button>
                    </div>
                </form>
                <div id="equipamentoMessage" class="message"></div>
                <hr class="my-4">
                <div class="equipamento-consulta-section">
                    <h3 class="mb-3"><i class="bi bi-search me-2"></i> Consulta de Equipamentos</h3>
                    <div class="input-group mb-3">
                        <input type="text" id="equipamentoSearchInput" class="form-control" placeholder="Pesquisar por Placa ou Tipo">
                        <button class="btn btn-outline-secondary" type="button" id="equipamentoSearchBtn"><i class="bi bi-search"></i> Buscar</button>
                        <button class="btn btn-outline-danger" type="button" id="equipamentoClearSearchBtn"><i class="bi bi-x-lg"></i> Limpar</button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Placa</th>
                                    <th>Tipo</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="equipamentosTableBody"></tbody>
                        </table>
                    </div>
                    <div id="equipamentoConsultaMessage" class="message mt-3"></div>
                </div>
            </div>
            <div id="trocaFilialScreen" class="hidden form-section">
                <button id="backToMainDashboardFromTroca" class="btn btn-secondary mb-3">&larr; Voltar</button>
                <h2>Troca de Filial Fixa de Equipamento</h2>
                <form id="trocaFilialForm">
                    <div class="mb-3">
                        <label for="placaEquipamento" class="form-label">Placa do Equipamento:</label>
                        <input type="text" id="placaEquipamento" list="equipamentosList" class="form-control" required>
                        <datalist id="equipamentosList"></datalist>
                    </div>
                    <div class="mb-3">
                        <label for="novaFilial" class="form-label">Nova Filial:</label>
                        <select id="novaFilial" class="form-select" required>
                            <option value="">Selecione...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="dataExecucao" class="form-label">Data de Execução:</label>
                        <input type="date" id="dataExecucao" class="form-control" required>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">Registrar Troca</button>
                    </div>
                </form>
                <div id="trocaFilialMessage" class="message"></div>
            </div>
        </main>
    </div>
    <div class="modal fade" id="editFilialResponsavelModal" tabindex="-1" aria-labelledby="editFilialResponsavelModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editFilialResponsavelModalLabel">Editar Responsável da Filial: <span id="modalFilialNome"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="modalFilialId">
                    <div class="mb-3">
                        <label for="modalResponsavelEmail" class="form-label">Novo Responsável (Email ou Nome):</label>
                        <input type="text" id="modalResponsavelEmail" class="form-control" placeholder="Email ou nome do novo responsável" required>
                        <small id="modalResponsavelHelper" class="form-text text-muted">Digite o email ou o nome do usuário.</small>
                    </div>
                    <div id="modalEditFilialMessage" class="message mt-3"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="saveFilialResponsavelBtn">Salvar Alterações</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="editEquipamentoModal" tabindex="-1" aria-labelledby="editEquipamentoModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editEquipamentoModalLabel">Editar Equipamento: <span id="modalEquipamentoPlaca"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="modalEquipamentoId">
                    <div class="mb-3">
                        <label for="modalEquipamentoTipo" class="form-label">Tipo de Equipamento:</label>
                        <select id="modalEquipamentoTipo" class="form-select" required>
                            <option value="">Selecione...</option>
                            <option value="Bomba Lança">Bomba Lança</option>
                            <option value="Bomba Estacionária">Bomba Estacionária</option>
                            <option value="Betoneira">Betoneira</option>
                        </select>
                    </div>
                    <div id="modalEditEquipamentoMessage" class="message mt-3"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="saveEquipamentoBtn">Salvar Alterações</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="editUsuarioModal" tabindex="-1" aria-labelledby="editUsuarioModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editUsuarioModalLabel">Editar Usuário: <span id="modalUsuarioNomeAtual"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="modalUsuarioId">
                    <div class="mb-3">
                        <label for="modalUsuarioNome" class="form-label">Nome:</label>
                        <input type="text" id="modalUsuarioNome" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="modalUsuarioEmail" class="form-label">Email:</label>
                        <input type="email" id="modalUsuarioEmail" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="modalUsuarioCategoria" class="form-label">Categoria:</label>
                        <select id="modalUsuarioCategoria" class="form-select" required>
                            <option value="">Selecione...</option>
                            <option value="admin">Administrador</option>
                            <option value="operador">Operador</option>
                            <option value="visualizador">Visualizador</option>
                        </select>
                    </div>
                    <hr>
                    <div class="mb-3">
                        <label for="modalUsuarioNovaSenha" class="form-label">Nova Senha (opcional):</label>
                        <input type="password" id="modalUsuarioNovaSenha" class="form-control">
                        <small class="form-text text-muted">Deixe em branco para não alterar a senha.</small>
                    </div>
                    <div class="mb-3">
                        <label for="modalUsuarioConfirmaSenha" class="form-label">Confirmar Nova Senha:</label>
                        <input type="password" id="modalUsuarioConfirmaSenha" class="form-control">
                    </div>
                    <div id="modalEditUsuarioMessage" class="message mt-3"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="saveUsuarioBtn">Salvar Alterações</button>
                </div>
            </div>
        </div>
    </div>
    <a href="https://wa.me/5522992075244?text=Ol%C3%A1%2C%20gostaria%20de%20mais%20informa%C3%A7%C3%B5es%21" class="btn btn-primary rounded-pill shadow-lg d-flex align-items-center py-2 px-3" style="position: fixed; bottom: 20px; right: 20px; z-index: 1060;" target="_blank">
        <i class="bi bi-question-circle-fill me-2 fs-5"></i> Precisando de ajuda? Clique aqui
    </a>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/i18n/pt-BR.js"></script>
    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.43.5';
        // As chaves do Supabase foram revertidas para os valores originais para resolver o TypeError.
        // Para uma melhor prática em produção, configure-as como variáveis de ambiente no Vercel.
        const supabaseUrl = "https://jtikvjomzduvjrrrsfeg.supabase.co";
        const supabaseAnonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp0aWt2am9temR1dmpycnJzZmVnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxMjU3NjcsImV4cCI6MjA2ODcwMTc2N30.2SCuJprMLJROxV6r6z1xKaVnnvy-q0Edwb0DrmcNeEg";

        export const supabase = createClient(supabaseUrl, supabaseAnonKey);

        function showScreen(screenId) {
            const screens = ['loginScreen', 'mainDashboardScreen', 'cadastroUsuariosScreen', 'cadastroFiliaisScreen', 'cadastroEquipamentosScreen', 'trocaFilialScreen'];
            screens.forEach(id => { const screenElement = document.getElementById(id); if (screenElement) screenElement.classList.add('hidden'); });
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) targetScreen.classList.remove('hidden');
            document.querySelectorAll('.message').forEach(el => { el.textContent = ''; el.classList.remove('alert-success', 'alert-danger', 'alert-info'); });
            document.querySelectorAll('#sidebar .nav-link').forEach(link => { link.classList.remove('active'); });
            document.querySelectorAll('.collapse.show').forEach(collapseEl => {
                const bsCollapse = bootstrap.Collapse.getInstance(collapseEl);
                if (bsCollapse) {
                    const toggleLink = document.querySelector(`[data-bs-target="#${collapseEl.id}"]`);
                    if (!toggleLink || !toggleLink.contains(document.querySelector(`[data-screen="${screenId}"]`))) {
                        bsCollapse.hide();
                    }
                }
            });
            const clickedLink = document.querySelector(`[data-screen="${screenId}"]`);
            if (clickedLink) {
                clickedLink.classList.add('active');
                const parentCollapse = clickedLink.closest('.collapse');
                if (parentCollapse) {
                    const bsCollapse = bootstrap.Collapse.getInstance(parentCollapse);
                    if (bsCollapse && !parentCollapse.classList.contains('show')) {
                        bsCollapse.show();
                    }
                }
            }
        }

        const loginForm = document.getElementById('loginForm');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const loginMessage = document.getElementById('loginMessage');
        const mobileSidebarToggleBtn = document.getElementById('mobileSidebarToggleBtn');
        const desktopSidebarToggleBtn = document.getElementById('desktopSidebarToggleBtn');
        const sidebar = document.getElementById('sidebar');

        async function signIn(email, password) {
            const { data, error } = await supabase.auth.signInWithPassword({ email, password });
            if (error) {
                console.error('Erro no login:', error.message);
                loginMessage.textContent = `Erro no login: ${error.message}`;
                loginMessage.classList.add('alert-danger');
                return null;
            }
            console.log('Login bem-sucedido:', data);
            loginMessage.textContent = 'Login bem-sucedido!';
            loginMessage.classList.remove('alert-danger');
            loginMessage.classList.add('alert-success');
            return data.user;
        }

        async function signOut() {
            const { error } = await supabase.auth.signOut();
            if (error) {
                console.error('Erro ao fazer logout:', error.message);
                return false;
            }
            console.log('Logout bem-sucedido.');
            document.body.classList.add('logged-out');
            document.body.classList.remove('sidebar-expanded', 'sidebar-collapsed');
            showScreen('loginScreen');
            return true;
        }

        async function checkAuthAndRedirect() {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                document.body.classList.remove('logged-out');
                document.body.classList.add('sidebar-collapsed'); // ou 'sidebar-expanded' se preferir iniciar aberta
                showScreen('mainDashboardScreen');
            } else {
                document.body.classList.add('logged-out');
                showScreen('loginScreen');
            }
        }

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = await signIn(emailInput.value, passwordInput.value);
            if (user) {
                checkAuthAndRedirect();
            }
        });

        document.getElementById('sidebarLogoutLink').addEventListener('click', async (e) => {
            e.preventDefault();
            await signOut();
        });

        document.querySelectorAll('#sidebar .nav-link[data-screen]').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                showScreen(this.dataset.screen);
                // No mobile, colapsa a sidebar após clicar em um link
                if (window.innerWidth <= 768) {
                    document.body.classList.remove('sidebar-expanded');
                }
            });
        });

        // Botão de alternar sidebar (desktop)
        if (desktopSidebarToggleBtn) {
            desktopSidebarToggleBtn.addEventListener('click', () => {
                document.body.classList.toggle('sidebar-collapsed');
            });
        }

        // Botão de alternar sidebar (mobile)
        if (mobileSidebarToggleBtn) {
            mobileSidebarToggleBtn.addEventListener('click', () => {
                document.body.classList.toggle('sidebar-expanded');
            });
        }

        // Adiciona funcionalidade para os botões de voltar para o Dashboard Principal
        document.getElementById('backToMainDashboardFromUsuarios').addEventListener('click', () => showScreen('mainDashboardScreen'));
        document.getElementById('backToMainDashboardFromFiliais').addEventListener('click', () => showScreen('mainDashboardScreen'));
        document.getElementById('backToMainDashboardFromEquipamentos').addEventListener('click', () => showScreen('mainDashboardScreen'));
        document.getElementById('backToMainDashboardFromTroca').addEventListener('click', () => showScreen('mainDashboardScreen'));

        // --- Gerenciamento de Usuários ---
        const usuarioForm = document.getElementById('usuarioForm');
        const nomeUsuarioInput = document.getElementById('nomeUsuario');
        const emailUsuarioInput = document.getElementById('emailUsuario');
        const senhaUsuarioInput = document.getElementById('senhaUsuario');
        const categoriaUsuarioSelect = document.getElementById('categoriaUsuario');
        const usuarioMessage = document.getElementById('usuarioMessage');
        const usuariosTableBody = document.getElementById('usuariosTableBody');
        const usuarioSearchInput = document.getElementById('usuarioSearchInput');
        const usuarioSearchBtn = document.getElementById('usuarioSearchBtn');
        const usuarioClearSearchBtn = document.getElementById('usuarioClearSearchBtn');
        const usuarioConsultaMessage = document.getElementById('usuarioConsultaMessage');

        // Modal de Edição de Usuário
        const editUsuarioModal = new bootstrap.Modal(document.getElementById('editUsuarioModal'));
        const modalUsuarioId = document.getElementById('modalUsuarioId');
        const modalUsuarioNomeAtual = document.getElementById('modalUsuarioNomeAtual');
        const modalUsuarioNome = document.getElementById('modalUsuarioNome');
        const modalUsuarioEmail = document.getElementById('modalUsuarioEmail');
        const modalUsuarioCategoria = document.getElementById('modalUsuarioCategoria');
        const modalUsuarioNovaSenha = document.getElementById('modalUsuarioNovaSenha');
        const modalUsuarioConfirmaSenha = document.getElementById('modalUsuarioConfirmaSenha');
        const modalEditUsuarioMessage = document.getElementById('modalEditUsuarioMessage');
        const saveUsuarioBtn = document.getElementById('saveUsuarioBtn');

        async function createUsuario(nome, email, senha, categoria) {
            const { data, error } = await supabase.from('usuarios').insert([{ nome, email, senha, categoria }]);
            if (error) throw error;
            return data;
        }

        async function getUsuarios(searchTerm = '') {
            let query = supabase.from('usuarios').select('*').order('nome', { ascending: true });
            if (searchTerm) {
                query = query.or(`nome.ilike.%${searchTerm}%,email.ilike.%${searchTerm}%`);
            }
            const { data, error } = await query;
            if (error) throw error;
            return data;
        }

        async function updateUsuario(id, nome, email, categoria, novaSenha = null) {
            const updateData = { nome, email, categoria };
            if (novaSenha) {
                updateData.senha = novaSenha; // Nota: A senha deve ser hashada antes de ser salva em um ambiente real
            }
            const { data, error } = await supabase.from('usuarios').update(updateData).eq('id', id);
            if (error) throw error;
            return data;
        }

        async function deleteUsuario(id) {
            const { data, error } = await supabase.from('usuarios').delete().eq('id', id);
            if (error) throw error;
            return data;
        }

        async function loadUsuarios(searchTerm = '') {
            try {
                const usuarios = await getUsuarios(searchTerm);
                usuariosTableBody.innerHTML = '';
                if (usuarios.length === 0) {
                    usuarioConsultaMessage.textContent = "Nenhum usuário encontrado.";
                    usuarioConsultaMessage.classList.remove('hidden', 'alert-success', 'alert-danger');
                    usuarioConsultaMessage.classList.add('alert-info');
                    return;
                } else {
                    usuarioConsultaMessage.textContent = '';
                    usuarioConsultaMessage.classList.add('hidden');
                }
                usuarios.forEach(usuario => {
                    const row = usuariosTableBody.insertRow();
                    row.innerHTML = `
                        <td>${usuario.nome}</td>
                        <td>${usuario.email}</td>
                        <td>${usuario.categoria}</td>
                        <td>
                            <button class="btn btn-sm btn-info edit-usuario-btn" data-id="${usuario.id}" data-nome="${usuario.nome}" data-email="${usuario.email}" data-categoria="${usuario.categoria}"><i class="bi bi-pencil-fill"></i></button>
                            <button class="btn btn-sm btn-danger delete-usuario-btn" data-id="${usuario.id}"><i class="bi bi-trash-fill"></i></button>
                        </td>
                    `;
                });
                attachUsuarioEventListeners();
            } catch (error) {
                console.error('Erro ao carregar usuários:', error.message);
                usuarioConsultaMessage.textContent = `Erro ao carregar usuários: ${error.message}`;
                usuarioConsultaMessage.classList.remove('hidden', 'alert-success', 'alert-info');
                usuarioConsultaMessage.classList.add('alert-danger');
            }
        }

        function attachUsuarioEventListeners() {
            document.querySelectorAll('.edit-usuario-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.currentTarget.dataset.id;
                    const nome = e.currentTarget.dataset.nome;
                    const email = e.currentTarget.dataset.email;
                    const categoria = e.currentTarget.dataset.categoria;

                    modalUsuarioId.value = id;
                    modalUsuarioNomeAtual.textContent = nome;
                    modalUsuarioNome.value = nome;
                    modalUsuarioEmail.value = email;
                    modalUsuarioCategoria.value = categoria;
                    modalUsuarioNovaSenha.value = '';
                    modalUsuarioConfirmaSenha.value = '';
                    modalEditUsuarioMessage.textContent = '';
                    modalEditUsuarioMessage.classList.add('hidden');
                    editUsuarioModal.show();
                });
            });

            document.querySelectorAll('.delete-usuario-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const id = e.currentTarget.dataset.id;
                    if (confirm('Tem certeza que deseja deletar este usuário?')) {
                        try {
                            await deleteUsuario(id);
                            usuarioMessage.textContent = 'Usuário deletado com sucesso!';
                            usuarioMessage.classList.remove('alert-danger');
                            usuarioMessage.classList.add('alert-success');
                            loadUsuarios();
                        } catch (error) {
                            console.error('Erro ao deletar usuário:', error.message);
                            usuarioMessage.textContent = `Erro ao deletar usuário: ${error.message}`;
                            usuarioMessage.classList.remove('alert-success');
                            usuarioMessage.classList.add('alert-danger');
                        }
                    }
                });
            });
        }

        usuarioForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                await createUsuario(nomeUsuarioInput.value, emailUsuarioInput.value, senhaUsuarioInput.value, categoriaUsuarioSelect.value);
                usuarioMessage.textContent = 'Usuário cadastrado com sucesso!';
                usuarioMessage.classList.remove('alert-danger');
                usuarioMessage.classList.add('alert-success');
                usuarioForm.reset();
                loadUsuarios();
            } catch (error) {
                console.error('Erro ao cadastrar usuário:', error.message);
                usuarioMessage.textContent = `Erro ao cadastrar usuário: ${error.message}`;
                usuarioMessage.classList.remove('alert-success');
                usuarioMessage.classList.add('alert-danger');
            }
        });

        usuarioSearchBtn.addEventListener('click', () => loadUsuarios(usuarioSearchInput.value));
        usuarioClearSearchBtn.addEventListener('click', () => {
            usuarioSearchInput.value = '';
            loadUsuarios();
        });

        saveUsuarioBtn.addEventListener('click', async () => {
            const id = modalUsuarioId.value;
            const nome = modalUsuarioNome.value;
            const email = modalUsuarioEmail.value;
            const categoria = modalUsuarioCategoria.value;
            const novaSenha = modalUsuarioNovaSenha.value;
            const confirmaSenha = modalUsuarioConfirmaSenha.value;

            if (novaSenha && novaSenha !== confirmaSenha) {
                modalEditUsuarioMessage.textContent = 'A nova senha e a confirmação de senha não coincidem.';
                modalEditUsuarioMessage.classList.remove('hidden', 'alert-success', 'alert-info');
                modalEditUsuarioMessage.classList.add('alert-danger');
                return;
            }

            try {
                await updateUsuario(id, nome, email, categoria, novaSenha || null);
                modalEditUsuarioMessage.textContent = 'Usuário atualizado com sucesso!';
                modalEditUsuarioMessage.classList.remove('alert-danger');
                modalEditUsuarioMessage.classList.add('alert-success');
                editUsuarioModal.hide();
                loadUsuarios();
            } catch (error) {
                console.error('Erro ao atualizar usuário:', error.message);
                modalEditUsuarioMessage.textContent = `Erro ao atualizar usuário: ${error.message}`;
                modalEditUsuarioMessage.classList.remove('alert-success');
                modalEditUsuarioMessage.classList.add('alert-danger');
            }
        });

        // --- Gerenciamento de Filiais ---
        const filialForm = document.getElementById('filialForm');
        const nomeFilialInput = document.getElementById('nomeFilial');
        const responsavelEmailInput = document.getElementById('responsavelEmail');
        const filialMessage = document.getElementById('filialMessage');
        const filiaisTableBody = document.getElementById('filiaisTableBody');
        const filialSearchInput = document.getElementById('filialSearchInput');
        const filialSearchBtn = document.getElementById('filialSearchBtn');
        const filialClearSearchBtn = document.getElementById('filialClearSearchBtn');
        const filialConsultaMessage = document.getElementById('filialConsultaMessage');
        const selectFiliais = document.getElementById('selectFiliais');

        // Modal de Edição de Filial
        const editFilialResponsavelModal = new bootstrap.Modal(document.getElementById('editFilialResponsavelModal'));
        const modalFilialId = document.getElementById('modalFilialId');
        const modalFilialNome = document.getElementById('modalFilialNome');
        const modalResponsavelEmail = document.getElementById('modalResponsavelEmail');
        const modalEditFilialMessage = document.getElementById('modalEditFilialMessage');
        const saveFilialResponsavelBtn = document.getElementById('saveFilialResponsavelBtn');

        async function createFilial(nome, responsavelEmail) {
            const { data, error } = await supabase.from('filiais').insert([{ nome, responsavel_email: responsavelEmail }]);
            if (error) throw error;
            return data;
        }

        async function getFiliais(searchTerm = '') {
            let query = supabase.from('filiais').select('*').order('nome', { ascending: true });
            if (searchTerm) {
                query = query.or(`nome.ilike.%${searchTerm}%,responsavel_email.ilike.%${searchTerm}%`);
            }
            const { data, error } = await query;
            if (error) throw error;
            return data;
        }

        async function updateFilialResponsavel(id, responsavelEmail) {
            const { data, error } = await supabase.from('filiais').update({ responsavel_email: responsavelEmail }).eq('id', id);
            if (error) throw error;
            return data;
        }

        async function deleteFilial(id) {
            const { data, error } = await supabase.from('filiais').delete().eq('id', id);
            if (error) throw error;
            return data;
        }

        async function loadFiliais(searchTerm = '') {
            try {
                const filiais = await getFiliais(searchTerm);
                filiaisTableBody.innerHTML = '';
                if (filiais.length === 0) {
                    filialConsultaMessage.textContent = "Nenhuma filial encontrada.";
                    filialConsultaMessage.classList.remove('hidden', 'alert-success', 'alert-danger');
                    filialConsultaMessage.classList.add('alert-info');
                    return;
                } else {
                    filialConsultaMessage.textContent = '';
                    filialConsultaMessage.classList.add('hidden');
                }
                filiais.forEach(filial => {
                    const row = filiaisTableBody.insertRow();
                    row.innerHTML = `
                        <td>${filial.nome}</td>
                        <td>${filial.responsavel_email || 'N/A'}</td>
                        <td>
                            <button class="btn btn-sm btn-info edit-filial-btn" data-id="${filial.id}" data-nome="${filial.nome}" data-responsavel="${filial.responsavel_email || ''}"><i class="bi bi-pencil-fill"></i></button>
                            <button class="btn btn-sm btn-danger delete-filial-btn" data-id="${filial.id}"><i class="bi bi-trash-fill"></i></button>
                        </td>
                    `;
                });
                attachFilialEventListeners();
            } catch (error) {
                console.error('Erro ao carregar filiais:', error.message);
                filialConsultaMessage.textContent = `Erro ao carregar filiais: ${error.message}`;
                filialConsultaMessage.classList.remove('hidden', 'alert-success', 'alert-info');
                filialConsultaMessage.classList.add('alert-danger');
            }
        }

        function attachFilialEventListeners() {
            document.querySelectorAll('.edit-filial-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.currentTarget.dataset.id;
                    const nome = e.currentTarget.dataset.nome;
                    const responsavel = e.currentTarget.dataset.responsavel;

                    modalFilialId.value = id;
                    modalFilialNome.textContent = nome;
                    modalResponsavelEmail.value = responsavel;
                    modalEditFilialMessage.textContent = '';
                    modalEditFilialMessage.classList.add('hidden');
                    editFilialResponsavelModal.show();
                });
            });

            document.querySelectorAll('.delete-filial-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const id = e.currentTarget.dataset.id;
                    if (confirm('Tem certeza que deseja deletar esta filial?')) {
                        try {
                            await deleteFilial(id);
                            filialMessage.textContent = 'Filial deletada com sucesso!';
                            filialMessage.classList.remove('alert-danger');
                            filialMessage.classList.add('alert-success');
                            loadFiliais();
                        } catch (error) {
                            console.error('Erro ao deletar filial:', error.message);
                            filialMessage.textContent = `Erro ao deletar filial: ${error.message}`;
                            filialMessage.classList.remove('alert-success');
                            filialMessage.classList.add('alert-danger');
                        }
                    }
                });
            });
        }

        filialForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                await createFilial(nomeFilialInput.value, responsavelEmailInput.value);
                filialMessage.textContent = 'Filial cadastrada com sucesso!';
                filialMessage.classList.remove('alert-danger');
                filialMessage.classList.add('alert-success');
                filialForm.reset();
                loadFiliais();
            } catch (error) {
                console.error('Erro ao cadastrar filial:', error.message);
                filialMessage.textContent = `Erro ao cadastrar filial: ${error.message}`;
                filialMessage.classList.remove('alert-success');
                filialMessage.classList.add('alert-danger');
            }
        });

        filialSearchBtn.addEventListener('click', () => loadFiliais(filialSearchInput.value));
        filialClearSearchBtn.addEventListener('click', () => {
            filialSearchInput.value = '';
            loadFiliais();
        });

        saveFilialResponsavelBtn.addEventListener('click', async () => {
            const id = modalFilialId.value;
            const responsavel = modalResponsavelEmail.value;
            try {
                await updateFilialResponsavel(id, responsavel);
                modalEditFilialMessage.textContent = 'Responsável da filial atualizado com sucesso!';
                modalEditFilialMessage.classList.remove('alert-danger');
                modalEditFilialMessage.classList.add('alert-success');
                editFilialResponsavelModal.hide();
                loadFiliais();
            } catch (error) {
                console.error('Erro ao atualizar responsável da filial:', error.message);
                modalEditFilialMessage.textContent = `Erro ao atualizar responsável: ${error.message}`;
                modalEditFilialMessage.classList.remove('alert-success');
                modalEditFilialMessage.classList.add('alert-danger');
            }
        });

        // --- Gerenciamento de Equipamentos ---
        const equipamentoForm = document.getElementById('equipamentoForm');
        const placaInput = document.getElementById('placa');
        const tipoEquipamentoSelect = document.getElementById('tipoEquipamento');
        const equipamentoMessage = document.getElementById('equipamentoMessage');
        const equipamentosTableBody = document.getElementById('equipamentosTableBody');
        const equipamentoSearchInput = document.getElementById('equipamentoSearchInput');
        const equipamentoSearchBtn = document.getElementById('equipamentoSearchBtn');
        const equipamentoClearSearchBtn = document.getElementById('equipamentoClearSearchBtn');
        const equipamentoConsultaMessage = document.getElementById('equipamentoConsultaMessage');
        const equipamentosListDatalist = document.getElementById('equipamentosList');

        // Modal de Edição de Equipamento
        const editEquipamentoModal = new bootstrap.Modal(document.getElementById('editEquipamentoModal'));
        const modalEquipamentoId = document.getElementById('modalEquipamentoId');
        const modalEquipamentoPlaca = document.getElementById('modalEquipamentoPlaca');
        const modalEquipamentoTipo = document.getElementById('modalEquipamentoTipo');
        const modalEditEquipamentoMessage = document.getElementById('modalEditEquipamentoMessage');
        const saveEquipamentoBtn = document.getElementById('saveEquipamentoBtn');

        async function createEquipamento(placa, tipo) {
            const { data, error } = await supabase.from('equipamentos').insert([{ placa, tipo }]);
            if (error) throw error;
            return data;
        }

        async function getEquipamentos(searchTerm = '') {
            let query = supabase.from('equipamentos').select('*').order('placa', { ascending: true });
            if (searchTerm) {
                query = query.or(`placa.ilike.%${searchTerm}%,tipo.ilike.%${searchTerm}%`);
            }
            const { data, error } = await query;
            if (error) throw error;
            return data;
        }

        async function updateEquipamento(id, tipo) {
            const { data, error } = await supabase.from('equipamentos').update({ tipo }).eq('id', id);
            if (error) throw error;
            return data;
        }

        async function deleteEquipamento(id) {
            const { data, error } = await supabase.from('equipamentos').delete().eq('id', id);
            if (error) throw error;
            return data;
        }

        async function loadEquipamentos(searchTerm = '') {
            try {
                const equipamentos = await getEquipamentos(searchTerm);
                equipamentosTableBody.innerHTML = '';
                equipamentosListDatalist.innerHTML = ''; // Limpa o datalist
                if (equipamentos.length === 0) {
                    equipamentoConsultaMessage.textContent = "Nenhum equipamento encontrado.";
                    equipamentoConsultaMessage.classList.remove('hidden', 'alert-success', 'alert-danger');
                    equipamentoConsultaMessage.classList.add('alert-info');
                    return;
                } else {
                    equipamentoConsultaMessage.textContent = '';
                    equipamentoConsultaMessage.classList.add('hidden');
                }
                equipamentos.forEach(eq => {
                    const row = equipamentosTableBody.insertRow();
                    row.innerHTML = `
                        <td>${eq.placa}</td>
                        <td>${eq.tipo}</td>
                        <td>
                            <button class="btn btn-sm btn-info edit-equipamento-btn" data-id="${eq.id}" data-placa="${eq.placa}" data-tipo="${eq.tipo}"><i class="bi bi-pencil-fill"></i></button>
                            <button class="btn btn-sm btn-danger delete-equipamento-btn" data-id="${eq.id}"><i class="bi bi-trash-fill"></i></button>
                        </td>
                    `;
                    // Adiciona ao datalist
                    const option = document.createElement('option');
                    option.value = eq.placa;
                    equipamentosListDatalist.appendChild(option);
                });
                attachEquipamentoEventListeners();
            } catch (error) {
                console.error('Erro ao carregar equipamentos:', error.message);
                equipamentoConsultaMessage.textContent = `Erro ao carregar equipamentos: ${error.message}`;
                equipamentoConsultaMessage.classList.remove('hidden', 'alert-success', 'alert-info');
                equipamentoConsultaMessage.classList.add('alert-danger');
            }
        }

        function attachEquipamentoEventListeners() {
            document.querySelectorAll('.edit-equipamento-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.currentTarget.dataset.id;
                    const placa = e.currentTarget.dataset.placa;
                    const tipo = e.currentTarget.dataset.tipo;

                    modalEquipamentoId.value = id;
                    modalEquipamentoPlaca.textContent = placa;
                    modalEquipamentoTipo.value = tipo;
                    modalEditEquipamentoMessage.textContent = '';
                    modalEditEquipamentoMessage.classList.add('hidden');
                    editEquipamentoModal.show();
                });
            });

            document.querySelectorAll('.delete-equipamento-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const id = e.currentTarget.dataset.id;
                    if (confirm('Tem certeza que deseja deletar este equipamento?')) {
                        try {
                            await deleteEquipamento(id);
                            equipamentoMessage.textContent = 'Equipamento deletado com sucesso!';
                            equipamentoMessage.classList.remove('alert-danger');
                            equipamentoMessage.classList.add('alert-success');
                            loadEquipamentos();
                        } catch (error) {
                            console.error('Erro ao deletar equipamento:', error.message);
                            equipamentoMessage.textContent = `Erro ao deletar equipamento: ${error.message}`;
                            equipamentoMessage.classList.remove('alert-success');
                            equipamentoMessage.classList.add('alert-danger');
                        }
                    }
                });
            });
        }

        equipamentoForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                await createEquipamento(placaInput.value, tipoEquipamentoSelect.value);
                equipamentoMessage.textContent = 'Equipamento cadastrado com sucesso!';
                equipamentoMessage.classList.remove('alert-danger');
                equipamentoMessage.classList.add('alert-success');
                equipamentoForm.reset();
                loadEquipamentos();
            } catch (error) {
                console.error('Erro ao cadastrar equipamento:', error.message);
                equipamentoMessage.textContent = `Erro ao cadastrar equipamento: ${error.message}`;
                equipamentoMessage.classList.remove('alert-success');
                equipamentoMessage.classList.add('alert-danger');
            }
        });

        equipamentoSearchBtn.addEventListener('click', () => loadEquipamentos(equipamentoSearchInput.value));
        equipamentoClearSearchBtn.addEventListener('click', () => {
            equipamentoSearchInput.value = '';
            loadEquipamentos();
        });

        saveEquipamentoBtn.addEventListener('click', async () => {
            const id = modalEquipamentoId.value;
            const tipo = modalEquipamentoTipo.value;
            try {
                await updateEquipamento(id, tipo);
                modalEditEquipamentoMessage.textContent = 'Equipamento atualizado com sucesso!';
                modalEditEquipamentoMessage.classList.remove('alert-danger');
                modalEditEquipamentoMessage.classList.add('alert-success');
                editEquipamentoModal.hide();
                loadEquipamentos();
            } catch (error) {
                console.error('Erro ao atualizar equipamento:', error.message);
                modalEditEquipamentoMessage.textContent = `Erro ao atualizar equipamento: ${error.message}`;
                modalEditEquipamentoMessage.classList.remove('alert-success');
                modalEditEquipamentoMessage.classList.add('alert-danger');
            }
        });

        // --- Gerenciamento de Troca de Filial ---
        const trocaFilialForm = document.getElementById('trocaFilialForm');
        const placaEquipamentoInput = document.getElementById('placaEquipamento');
        const novaFilialSelect = document.getElementById('novaFilial');
        const dataExecucaoInput = document.getElementById('dataExecucao');
        const trocaFilialMessage = document.getElementById('trocaFilialMessage');

        async function registerTrocaFilial(placa, novaFilialId, dataExecucao) {
            const { data: equipamentos, error: eqError } = await supabase.from('equipamentos').select('id, filial_atual_id').eq('placa', placa).single();
            if (eqError || !equipamentos) throw new Error('Equipamento não encontrado.');

            const equipamentoId = equipamentos.id;
            const filialAnteriorId = equipamentos.filial_atual_id;

            // Insere o histórico da troca
            const { error: histError } = await supabase.from('historico_trocas_filial').insert([{
                equipamento_id: equipamentoId,
                filial_anterior_id: filialAnteriorId,
                filial_nova_id: novaFilialId,
                data_execucao: dataExecucao
            }]);
            if (histError) throw histError;

            // Atualiza a filial_atual_id no equipamento
            const { error: updateError } = await supabase.from('equipamentos').update({ filial_atual_id: novaFilialId }).eq('id', equipamentoId);
            if (updateError) throw updateError;

            return true;
        }

        async function loadFiliaisIntoSelect(selectElement) {
            try {
                const filiais = await getFiliais();
                selectElement.innerHTML = '<option value="">Selecione...</option>';
                filiais.forEach(filial => {
                    const option = document.createElement('option');
                    option.value = filial.id;
                    option.textContent = filial.nome;
                    selectElement.appendChild(option);
                });
            } catch (error) {
                console.error('Erro ao carregar filiais para seleção:', error.message);
            }
        }

        trocaFilialForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                await registerTrocaFilial(placaEquipamentoInput.value, novaFilialSelect.value, dataExecucaoInput.value);
                trocaFilialMessage.textContent = 'Troca de filial registrada com sucesso!';
                trocaFilialMessage.classList.remove('alert-danger');
                trocaFilialMessage.classList.add('alert-success');
                trocaFilialForm.reset();
            } catch (error) {
                console.error('Erro ao registrar troca de filial:', error.message);
                trocaFilialMessage.textContent = `Erro ao registrar troca de filial: ${error.message}`;
                trocaFilialMessage.classList.remove('alert-success');
                trocaFilialMessage.classList.add('alert-danger');
            }
        });

        // --- Dashboard Kanban ---
        const kanbanBoard = document.getElementById('kanbanBoard');
        const kanbanMessage = document.getElementById('kanbanMessage');
        const filterStartDate = document.getElementById('filterStartDate');
        const filterEndDate = document.getElementById('filterEndDate');
        const filterSearchInput = document.getElementById('filterSearchInput');
        const selectResponsavel = document.getElementById('selectResponsavel');
        const filterDashboardBtn = document.getElementById('filterDashboardBtn');
        const clearSearchBtn = document.getElementById('clearSearchBtn');

        async function getEquipamentosForDashboard(startDate = null, endDate = null, searchTerm = '', responsavelId = null, filialIds = []) {
            let query = supabase
                .from('equipamentos')
                .select(`
                    *,
                    filial_atual:filiais!inner(nome, responsavel_email),
                    historico_trocas_filial(data_execucao, filial_nova:filiais!inner(nome))
                `)
                .neq('filial_atual_id', null) // Apenas equipamentos com filial definida
                .order('placa', { ascending: true });

            if (startDate) query = query.gte('created_at', startDate);
            if (endDate) query = query.lte('created_at', endDate);
            if (searchTerm) {
                query = query.or(`placa.ilike.%${searchTerm}%,tipo.ilike.%${searchTerm}%,filial_atual.nome.ilike.%${searchTerm}%`);
            }
            if (responsavelId) {
                query = query.eq('filial_atual.responsavel_email', responsavelId);
            }
            if (filialIds && filialIds.length > 0) {
                query = query.in('filial_atual_id', filialIds);
            }

            const { data, error } = await query;
            if (error) throw error;
            return data;
        }

        async function loadResponsaveisForFilter(selectElement) {
            try {
                const { data, error } = await supabase.from('usuarios').select('email, nome').order('nome');
                if (error) throw error;
                selectElement.innerHTML = '<option value="">Todos os Responsáveis</option>';
                data.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.email;
                    option.textContent = user.nome;
                    selectElement.appendChild(option);
                });
            } catch (error) {
                console.error('Erro ao carregar responsáveis para filtro:', error.message);
            }
        }

        async function loadFiliaisIntoSelect2(selectElement) {
            $(selectElement).select2({
                placeholder: $(selectElement).data('placeholder'),
                allowClear: true,
                language: "pt-BR",
                theme: "bootstrap-5",
                dropdownParent: $(selectElement).parent(),
                ajax: {
                    url: 'https://jtikvjomzduvjrrrsfeg.supabase.co/rest/v1/filiais?select=id,nome&order=nome.asc',
                    dataType: 'json',
                    delay: 250,
                    headers: {
                        'apikey': supabaseAnonKey,
                        'Authorization': `Bearer ${supabaseAnonKey}`
                    },
                    data: function(params) {
                        return {
                            nome: `ilike.%${params.term}%`, // search term
                            offset: (params.page || 1) - 1,
                            limit: 10 // page size
                        };
                    },
                    processResults: function(data, params) {
                        params.page = params.page || 1;
                        return {
                            results: data.map(filial => ({ id: filial.id, text: filial.nome })),
                            pagination: {
                                more: (params.page * 10) < data.length // assuming total count is not returned directly
                            }
                        };
                    },
                    cache: true
                },
                minimumInputLength: 0
            });
        }

        async function loadEquipamentosDashboard() {
            try {
                const start = filterStartDate.value;
                const end = filterEndDate.value;
                const search = filterSearchInput.value;
                const responsavel = selectResponsavel.value;
                const selectedFilialIds = $(selectFiliais).val();

                kanbanBoard.innerHTML = '';
                kanbanMessage.textContent = 'Carregando dados...';
                kanbanMessage.classList.remove('hidden');

                const equipamentos = await getEquipamentosForDashboard(start, end, search, responsavel, selectedFilialIds);

                if (equipamentos.length === 0) {
                    kanbanMessage.textContent = "NENHUM RESULTADO ENCONTRADO COM O FILTRO SELECIONADO!";
                    kanbanMessage.classList.remove('hidden', 'alert-success', 'alert-danger');
                    kanbanMessage.classList.add('no-data');
                    return;
                } else {
                    kanbanMessage.classList.add('hidden');
                }

                // Agrupar equipamentos por filial
                const equipamentosPorFilial = equipamentos.reduce((acc, eq) => {
                    const filialNome = eq.filial_atual ? eq.filial_atual.nome : 'Sem Filial Atribuída';
                    if (!acc[filialNome]) {
                        acc[filialNome] = [];
                    }
                    acc[filialNome].push(eq);
                    return acc;
                }, {});

                Object.keys(equipamentosPorFilial).forEach(filialNome => {
                    const columnDiv = document.createElement('div');
                    columnDiv.classList.add('kanban-column', 'col');
                    columnDiv.innerHTML = `<div class="kanban-column-header">${filialNome} (${equipamentosPorFilial[filialNome].length})</div>`;

                    equipamentosPorFilial[filialNome].forEach(eq => {
                        // Ordenar o histórico para pegar a última troca para "Desde"
                        const historicoOrdenado = eq.historico_trocas_filial.sort((a, b) => new Date(b.data_execucao) - new Date(a.data_execucao));
                        const dataInicio = historicoOrdenado.length > 0 ? historicoOrdenado[0].data_execucao : eq.created_at;

                        const cardDiv = document.createElement('div');
                        cardDiv.classList.add('kanban-card');
                        cardDiv.innerHTML = `
                            <div class="kanban-card-title">${eq.placa}</div>
                            <div class="kanban-card-meta">Tipo: ${eq.tipo}</div>
                            <div class="kanban-card-meta">Responsável: ${eq.filial_atual.responsavel_email || 'N/A'}</div>
                            <div class="kanban-card-date">Desde: ${new Date(dataInicio).toLocaleDateString('pt-BR')}</div>
                        `;
                        columnDiv.appendChild(cardDiv);
                    });
                    kanbanBoard.appendChild(columnDiv);
                });

            } catch (error) {
                console.error('Erro ao carregar dashboard (Kanban):', error.message);
                kanbanBoard.innerHTML = ''; // Limpa o board
                kanbanMessage.textContent = `Erro ao carregar dados do dashboard: ${error.message}`;
                kanbanMessage.classList.remove('hidden'); // Mostra a mensagem de erro
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            checkAuthAndRedirect();

            // Configuração do Select2 para o filtro de filiais
            if (selectFiliais) {
                loadFiliaisIntoSelect2(selectFiliais);
            }

            // Funções de carregamento para telas específicas (chamadas ao mostrar a tela)
            document.getElementById('sidebarDashboardLink').addEventListener('click', () => loadEquipamentosDashboard());
            document.getElementById('showCadastroUsuarios').addEventListener('click', () => loadUsuarios());
            document.getElementById('showCadastroFiliais').addEventListener('click', () => loadFiliais());
            document.getElementById('showCadastroEquipamentos').addEventListener('click', () => loadEquipamentos());
            document.getElementById('showTrocaFilial').addEventListener('click', () => {
                loadEquipamentos(); // Para o datalist
                loadFiliaisIntoSelect(novaFilialSelect);
            });

            if (filterDashboardBtn) {
                filterDashboardBtn.addEventListener('click', loadEquipamentosDashboard);
            }
            if (clearSearchBtn) {
                clearSearchBtn.addEventListener('click', () => {
                    filterSearchInput.value = '';
                    loadEquipamentosDashboard();
                });
            }

            if (selectResponsavel) {
                loadResponsaveisForFilter(selectResponsavel);
            }
        });
    </script>
</body>
</html>
