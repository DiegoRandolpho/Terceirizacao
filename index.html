<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebApp Interno - TercSistemas</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

    <style>
        :root {
            --sidebar-width: 250px;
            --navbar-height: 60px;
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            --bg-light: #f8f9fa;
            --bg-body: #e9ecef; /* Um cinza mais claro para o fundo */
        }

        body {
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-body);
            display: flex; /* Para o layout principal (flexbox para sidebar e contentWrapper) */
            min-height: 100vh;
            overflow-x: hidden; /* Evita scroll horizontal indesejado */
        }

        /* --- Navbar (Topo) --- */
        #navbar {
            height: var(--navbar-height);
            background-color: #fff;
            border-bottom: 1px solid #e0e0e0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            /* Ajusta a largura e posição para sidebar aberta */
            width: calc(100% - var(--sidebar-width));
            position: fixed; /* Fixa a navbar no topo */
            top: 0;
            left: var(--sidebar-width); /* Inicia com o espaço da sidebar */
            z-index: 1000;
            /* Acima do conteúdo, abaixo da sidebar (em z-index) */
            transition: left 0.3s ease, width 0.3s ease;
            /* Transição suave para movimentação */
        }

        /* Ajuste da navbar quando sidebar está recolhida (desktop) */
        body.sidebar-collapsed #navbar {
            width: 100%; /* Ocupa toda a largura */
            left: 0; /* Alinha à esquerda */
        }

        .navbar .navbar-brand {
            font-weight: 700;
            color: var(--primary-color);
            font-size: 1.8rem; /* Aumentado um pouco */
        }

        .navbar .nav-link {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--secondary-color);
        }
        .navbar .nav-link:hover {
            color: var(--primary-color);
        }

        /* --- Sidebar (Esquerda) --- */
        #sidebar {
            width: var(--sidebar-width);
            background-color: #2c3e50; /* Darker blue-gray */
            color: #ecf0f1; /* Light text */
            position: fixed; /* Fixa a sidebar na tela */
            height: 100%;
            top: 0;
            left: 0; /* Posição inicial da sidebar */
            z-index: 1001; /* Acima da navbar e do conteúdo */
            padding-top: var(--navbar-height); /* Espaço para logo/header no topo */
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            transition: left 0.3s ease; /* Transição apenas para 'left' */
            overflow-y: auto; /* Scrollable sidebar */
            flex-shrink: 0; /* Impede que a sidebar diminua em layouts flex */
        }

        /* Sidebar recolhida (desktop) */
        body.sidebar-collapsed #sidebar {
            left: -var(--sidebar-width); /* Esconde completamente à esquerda */
        }

        #sidebar .sidebar-header {
            padding: 15px;
            text-align: center;
            background-color: #34495e; /* Slightly lighter header */
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: var(--navbar-height);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem; /* Aumentado um pouco */
            font-weight: bold;
        }
        #sidebar .sidebar-header img { /* Removido para remover logo */
            display: none;
        }
        #sidebar .sidebar-header span {
            color: #fff;
        }

        #sidebar .nav-item {
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }

        #sidebar .nav-link {
            color: #ecf0f1;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 1.1rem;
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        #sidebar .nav-link:hover,
        #sidebar .nav-link.active {
            background-color: #1abc9c; /* Emerald green for active/hover */
            color: #fff;
            border-radius: 0;
        }

        #sidebar .nav-link i {
            font-size: 1.3rem;
        }

        /* --- Main Content Area --- */
        #contentWrapper {
            margin-left: var(--sidebar-width); /* Espaço inicial para a sidebar */
            padding-top: var(--navbar-height); /* Espaço para a navbar */
            flex-grow: 1; /* Ocupa o restante do espaço horizontal */
            width: calc(100% - var(--sidebar-width)); /* Ajusta a largura */
            transition: margin-left 0.3s ease, width 0.3s ease;
        }

        /* Conteúdo ocupa toda a largura quando sidebar recolhida (desktop) */
        body.sidebar-collapsed #contentWrapper {
            margin-left: 0; /* Remove margem */
            width: 100%; /* Ocupa toda a largura */
        }

        #mainContent {
            padding: 25px;
            min-height: calc(100vh - var(--navbar-height)); /* Garante que o conteúdo tenha pelo menos a altura da tela menos a navbar */
        }

        /* --- Formulários e Tabelas --- */
        .form-section, .dashboard-section {
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 25px;
        }

        h2 {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 30px;
            text-align: center;
            color: var(--primary-color);
        }

        .form-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
        }

        .form-control, .form-select {
            border-radius: 0.375rem;
            border: 1px solid #ced4da;
            padding: 0.75rem 1rem;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        .form-control:focus, .form-select:focus {
            border-color: #80bdff;
            outline: 0;
            box-shadow: 0 0 0 0.25rem rgba(0, 123, 255, 0.25);
        }

        .btn {
            border-radius: 0.375rem;
            padding: 0.75rem 1.25rem;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        .btn-primary { background-color: var(--primary-color); border-color: var(--primary-color); }
        .btn-primary:hover { background-color: #0056b3; border-color: #0056b3; }
        .btn-success { background-color: var(--success-color); border-color: var(--success-color); }
        .btn-success:hover { background-color: #218838; border-color: #218838; }
        .btn-danger { background-color: var(--danger-color); border-color: var(--danger-color); }
        .btn-danger:hover { background-color: #c82333; border-color: #c82333; }
        .btn-info { background-color: var(--info-color); border-color: var(--info-color); }
        .btn-info:hover { background-color: #138496; border-color: #138496; }
        .btn-secondary { background-color: var(--secondary-color); border-color: var(--secondary-color); }
        .btn-secondary:hover { background-color: #5a6268; border-color: #5a6268; }


        .message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            font-weight: bold;
            text-align: center;
            font-size: 1rem;
            border: 1px solid transparent; /* Adiciona borda para clareza */
        }
        .message.alert-success { background-color: #d4edda; color: #155724; border-color: #c3e6cb; }
        .message.alert-danger { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; }
        .message.alert-info { background-color: #d1ecf1; color: #0c5460; border-color: #bee5eb; }


        .table {
            margin-top: 25px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .table thead th {
            background-color: #e9ecef; /* Light background for table header */
            color: #495057;
            font-weight: 600;
            padding: 15px;
            border-bottom: 2px solid #dee2e6;
        }
        .table tbody td {
            padding: 12px;
            vertical-align: middle;
            border-bottom: 1px solid #e0e0e0;
        }
        .table tbody tr:last-child td {
            border-bottom: none;
        }
        .table tbody tr:hover {
            background-color: #f5f5f5;
        }

        .hidden {
            display: none !important;
        }

        /* --- Navbar Toggle para Sidebar (Ajuste para visibilidade) --- */
        .navbar-toggler {
            border: none;
            padding: 0;
            font-size: 1.5rem;
            color: var(--secondary-color);
            display: none; /* Esconde por padrão em desktop */
        }
        @media (max-width: 768px) {
            .navbar-toggler {
                display: block; /* Mostra em mobile */
            }
        }
        .navbar-toggler:focus {
            box-shadow: none;
        }

        /* Ajustes Responsivos */
        @media (max-width: 768px) {
            :root {
                --sidebar-width: 220px;
            }
            /* Sidebar em mobile: inicia escondida à esquerda, quando expandida, desliza para 0 */
            body #sidebar {
                left: -var(--sidebar-width);
                box-shadow: 2px 0 10px rgba(0,0,0,0.2); /* Sombra para destacar que está "por cima" */
            }
            body.sidebar-expanded #sidebar {
                left: 0;
            }
            /* Navbar e Content Wrapper sempre ocupam 100% da largura em mobile */
            body #navbar, body #contentWrapper {
                width: 100% !important;
                margin-left: 0 !important;
                left: 0 !important;
            }
        }

        /* --- Estado de "não logado" --- */
        body.logged-out #sidebar,
        body.logged-out .navbar-top-elements { /* Nova classe para os elementos da navbar a serem escondidos */
            display: none !important;
        }

        body.logged-out #navbar { /* Garante que a navbar ocupe toda a largura */
            width: 100% !important;
            left: 0 !important;
        }
        body.logged-out #contentWrapper { /* Garante que o conteúdo ocupe toda a largura */
            margin-left: 0 !important;
            width: 100% !important;
        }

        /* --- Kanban Board Styles --- */
        #kanbanBoard {
            gap: 15px; /* Espaçamento entre as colunas */
            align-items: flex-start; /* Alinha as colunas ao topo */
            min-height: 400px; /* Altura mínima para o board */
        }

        .kanban-column {
            background-color: #ebecf0; /* Cor de fundo da coluna (cinza claro do Trello) */
            border-radius: 8px;
            padding: 15px;
            min-width: 280px; /* Largura mínima para cada coluna */
            max-width: 300px; /* Largura máxima para cada coluna */
            flex-shrink: 0; /* Impede que a coluna encolha */
            display: flex;
            flex-direction: column;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            max-height: calc(100vh - var(--navbar-height) - 160px); /* Ajusta altura para caber na tela */
            overflow-y: auto; /* Scroll para colunas longas */
        }

        .kanban-column-header {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: #495057;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .kanban-card {
            background-color: #fff;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.08);
            cursor: grab;
            transition: background-color 0.2s ease;
        }

        .kanban-card:hover {
            background-color: #f5f5f5;
        }

        .kanban-card-title {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 5px;
            color: var(--primary-color);
        }

        .kanban-card-meta {
            font-size: 0.85rem;
            color: #6c757d;
            margin-bottom: 3px;
        }

        .kanban-card-date {
            font-size: 0.8em;
            color: #888;
            text-align: right;
            margin-top: 8px;
        }

        .kanban-empty-message {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 20px 0;
        }
        .no-data {
            text-align: center;
            color: #6c757d;
            padding: 20px;
            font-size: 1.1rem;
            font-weight: 500;
        }

        /* Estilos para Select2 */
        .select2-container--bootstrap-5 .select2-selection {
            min-height: calc(2.25em + 0.75rem + 2px); /* Adjusted for Bootstrap 5 form-control height */
            padding: 0.375rem 0.75rem;
            border: 1px solid #ced4da;
            border-radius: 0.375rem;
            display: flex; /* Align items correctly for tags */
            align-items: center;
        }
        .select2-container--bootstrap-5.select2-container--focus .select2-selection,
        .select2-container--bootstrap-5.select2-container--open .select2-selection {
            border-color: #80bdff;
            outline: 0;
            box-shadow: 0 0 0 0.25rem rgba(0, 123, 255, 0.25);
        }
        .select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__choice {
            background-color: var(--primary-color);
            color: #fff;
            border: 1px solid var(--primary-color);
            border-radius: 0.2rem;
            padding: 0.2rem 0.5rem;
            margin-top: 0.25rem;
            margin-right: 0.25rem;
        }
        .select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__choice__remove {
            color: rgba(255,255,255,0.7);
            float: right;
            margin-left: 0.2rem;
        }
        .select2-container--bootstrap-5 .select2-dropdown {
            border-color: #ced4da;
            border-radius: 0.375rem;
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
        }
        .select2-container--bootstrap-5 .select2-results__option--highlighted.select2-results__option--selectable {
            background-color: var(--primary-color);
            color: #fff;
        }
        .select2-container--bootstrap-5 .select2-results__option--selected {
            background-color: #e9ecef; /* Light gray for selected in dropdown */
            color: #495057;
        }

    </style>
</head>
<body class="logged-out sidebar-collapsed">
    <nav class="navbar navbar-expand-lg" id="navbar">
        <div class="container-fluid">
            <button class="btn btn-light d-none d-lg-block me-3" type="button" id="desktopSidebarToggleBtn" title="Ocultar/Exibir Menu">
                <i class="bi bi-list"></i>
            </button>
            <button class="navbar-toggler me-3 d-lg-none" type="button" id="mobileSidebarToggleBtn">
                <i class="bi bi-list"></i>
            </button>

            <a class="navbar-brand" href="#">
                TercSistemas
            </a>
            <div class="ms-auto d-flex align-items-center navbar-top-elements">
                <a class="nav-link me-3" href="#"><i class="bi bi-cloud-fill"></i></a>
            </div>
        </div>
    </nav>

    <aside id="sidebar" class="d-flex flex-column">
        <div class="sidebar-header d-lg-none">
            <span>TercSistemas</span>
        </div>
        <ul class="nav flex-column mt-3">
            <li class="nav-item">
                <a class="nav-link active" href="#" data-screen="mainDashboardScreen" id="sidebarDashboardLink">
                    <i class="bi bi-speedometer2"></i> Dashboard
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-bs-toggle="collapse" data-bs-target="#cadastroSubmenu" aria-expanded="false">
                    <i class="bi bi-plus-circle"></i> Cadastro <i class="bi bi-chevron-down ms-auto"></i>
                </a>
                <div class="collapse" id="cadastroSubmenu">
                    <ul class="nav flex-column ms-3">
                        <li class="nav-item" id="cadastroUsuariosNavItem"><a class="nav-link" href="#" data-screen="cadastroUsuariosScreen" id="showCadastroUsuarios"><i class="bi bi-person-fill-add"></i> Usuários</a></li>
                        <li class="nav-item"><a class="nav-link" href="#" data-screen="cadastroFiliaisScreen" id="showCadastroFiliais"><i class="bi bi-shop"></i> Filiais</a></li>
                        <li class="nav-item"><a class="nav-link" href="#" data-screen="cadastroEquipamentosScreen" id="showCadastroEquipamentos"><i class="bi bi-tools"></i> Equipamentos</a></li>
                    </ul>
                </div>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-bs-toggle="collapse" data-bs-target="#operacionalSubmenu" aria-expanded="false">
                    <i class="bi bi-gear"></i> Operacional <i class="bi bi-chevron-down ms-auto"></i>
                </a>
                <div class="collapse" id="operacionalSubmenu">
                    <ul class="nav flex-column ms-3">
                        <li class="nav-item"><a class="nav-link" href="#" data-screen="trocaFilialScreen" id="showTrocaFilial"><i class="bi bi-arrow-left-right"></i> Troca de Filial</a></li>
                    </ul>
                </div>
            </li>
            <li class="nav-item mt-auto">
                <a class="nav-link" href="#" id="sidebarLogoutLink">
                    <i class="bi bi-box-arrow-right"></i> Sair
                </a>
            </li>
        </ul>
    </aside>

    <div id="contentWrapper" class="flex-grow-1">
        <main id="mainContent" class="d-flex flex-column h-100">

            <div id="loginScreen" class="d-flex justify-content-center align-items-center flex-grow-1">
                <div class="card shadow-sm p-4" style="width: 100%; max-width: 400px;">
                    <h2 class="card-title text-center mb-4">Login - TercSistemas</h2>
                    <form id="loginForm">
                        <div class="mb-3">
                            <label for="email" class="form-label">Email:</label>
                            <input type="email" id="email" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">Senha:</label>
                            <input type="password" id="password" class="form-control" required>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg">Entrar</button>
                        </div>
                    </form>
                    <div id="loginMessage" class="message mt-3"></div>
                </div>
            </div>

            <div id="mainDashboardScreen" class="hidden flex-grow-1">
                <h1 class="mb-4">Dashboard de Equipamentos Ativos</h1>

                <div class="dashboard-controls-kanban">
                    <div class="d-flex flex-wrap align-items-center mb-4 gap-3">
                        <div class="input-group flex-grow-1 me-md-2">
                            <span class="input-group-text"><i class="bi bi-calendar-range"></i></span>
                            <input type="date" class="form-control" id="filterStartDate">
                            <span class="input-group-text"><i class="bi bi-arrow-right"></i></span>
                            <input type="date" class="form-control" id="filterEndDate">
                        </div>
                        <div class="input-group flex-grow-1">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                            <input type="text" class="form-control" id="filterSearchInput" placeholder="Pesquisar placa, tipo ou filial...">
                            <button class="btn btn-outline-secondary" type="button" id="clearSearchBtn"><i class="bi bi-x-lg"></i></button>
                        </div>
                        <div class="input-group flex-grow-1">
                            <span class="input-group-text"><i class="bi bi-person"></i></span>
                            <select id="selectResponsavel" class="form-select">
                                <option value="">Todos os Responsáveis</option>
                            </select>
                        </div>
                        <div class="input-group flex-grow-1">
                            <span class="input-group-text"><i class="bi bi-shop"></i></span>
                            <select id="selectFiliais" class="form-select" multiple data-placeholder="Selecione as Filiais">
                            </select>
                        </div>
                        <button class="btn btn-primary" id="filterDashboardBtn"><i class="bi bi-funnel"></i> Aplicar Filtros</button>
                    </div>
                </div>

                <div id="kanbanBoard" class="d-flex flex-nowrap overflow-auto py-3">
                    <p id="kanbanMessage" class="no-data text-center w-100">NENHUM RESULTADO ENCONTRADO COM O FILTRO SELECIONADO!</p>
                </div>
            </div>

            <div id="cadastroUsuariosScreen" class="hidden form-section">
                <button id="backToMainDashboardFromUsuarios" class="btn btn-secondary mb-3">&larr; Voltar</button>
                <h2>Cadastro de Usuários</h2>
                <form id="usuarioForm">
                    <div class="mb-3">
                        <label for="nomeUsuario" class="form-label">Nome Completo:</label>
                        <input type="text" id="nomeUsuario" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="emailUsuario" class="form-label">Email:</label>
                        <input type="email" id="emailUsuario" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="senhaUsuario" class="form-label">Senha:</label>
                        <input type="password" id="senhaUsuario" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="categoriaUsuario" class="form-label">Categoria:</label>
                        <select id="categoriaUsuario" class="form-select" required>
                            <option value="">Selecione...</option>
                            <option value="admin">Administrador</option>
                            <option value="operador">Operador</option>
                            <option value="visualizador">Visualizador</option>
                        </select>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">Cadastrar Usuário</button>
                    </div>
                </form>
                <div id="usuarioMessage" class="message"></div>

                <hr class="my-4">

                <div class="usuario-consulta-section">
                    <h3 class="mb-3"><i class="bi bi-search me-2"></i> Consulta de Usuários</h3>
                    <div class="input-group mb-3">
                        <input type="text" id="usuarioSearchInput" class="form-control" placeholder="Pesquisar por Nome ou Email">
                        <button class="btn btn-outline-secondary" type="button" id="usuarioSearchBtn"><i class="bi bi-search"></i> Buscar</button>
                        <button class="btn btn-outline-danger" type="button" id="usuarioClearSearchBtn"><i class="bi bi-x-lg"></i> Limpar</button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Email</th>
                                    <th>Categoria</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="usuariosTableBody">
                            </tbody>
                        </table>
                    </div>
                    <div id="usuarioConsultaMessage" class="message mt-3"></div>
                </div>
            </div>


            <div id="cadastroFiliaisScreen" class="hidden form-section">
                <button id="backToMainDashboardFromFiliais" class="btn btn-secondary mb-3">&larr; Voltar</button>
                <h2>Cadastro de Filiais</h2>
                <form id="filialForm">
                    <div class="mb-3">
                        <label for="nomeFilial" class="form-label">Nome da Filial:</label>
                        <input type="text" id="nomeFilial" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="responsavelEmail" class="form-label">Responsável (Email ou Nome):</label>
                        <input type="text" id="responsavelEmail" placeholder="Email ou nome do responsável" class="form-control" required>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">Cadastrar Filial</button>
                    </div>
                </form>
                <div id="filialMessage" class="message"></div>

                <hr class="my-4">

                <div class="filial-consulta-section">
                    <h3 class="mb-3"><i class="bi bi-search me-2"></i> Consulta de Filiais</h3>
                    <div class="input-group mb-3">
                        <input type="text" id="filialSearchInput" class="form-control" placeholder="Pesquisar por Filial ou Responsável">
                        <button class="btn btn-outline-secondary" type="button" id="filialSearchBtn"><i class="bi bi-search"></i> Buscar</button>
                        <button class="btn btn-outline-danger" type="button" id="filialClearSearchBtn"><i class="bi bi-x-lg"></i> Limpar</button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Filial</th>
                                    <th>Responsável</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="filiaisTableBody">
                            </tbody>
                        </table>
                    </div>
                    <div id="filialConsultaMessage" class="message mt-3"></div>
                </div>
            </div>

            <div id="cadastroEquipamentosScreen" class="hidden form-section">
                <button id="backToMainDashboardFromEquipamentos" class="btn btn-secondary mb-3">&larr; Voltar</button>
                <h2>Cadastro de Equipamentos</h2>
                <form id="equipamentoForm">
                    <div class="mb-3">
                        <label for="placa" class="form-label">Placa do Equipamento:</label>
                        <input type="text" id="placa" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="tipoEquipamento" class="form-label">Tipo de Equipamento:</label>
                        <select id="tipoEquipamento" class="form-select" required>
                            <option value="">Selecione...</option>
                            <option value="Bomba Lança">Bomba Lança</option>
                            <option value="Bomba Estacionária">Bomba Estacionária</option>
                            <option value="Betoneira">Betoneira</option>
                        </select>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">Cadastrar Equipamento</button>
                    </div>
                </form>
                <div id="equipamentoMessage" class="message"></div>

                <hr class="my-4">

                <div class="equipamento-consulta-section">
                    <h3 class="mb-3"><i class="bi bi-search me-2"></i> Consulta de Equipamentos</h3>
                    <div class="input-group mb-3">
                        <input type="text" id="equipamentoSearchInput" class="form-control" placeholder="Pesquisar por Placa ou Tipo">
                        <button class="btn btn-outline-secondary" type="button" id="equipamentoSearchBtn"><i class="bi bi-search"></i> Buscar</button>
                        <button class="btn btn-outline-danger" type="button" id="equipamentoClearSearchBtn"><i class="bi bi-x-lg"></i> Limpar</button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Placa</th>
                                    <th>Tipo</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="equipamentosTableBody">
                            </tbody>
                        </table>
                    </div>
                    <div id="equipamentoConsultaMessage" class="message mt-3"></div>
                </div>
            </div>

            <div id="trocaFilialScreen" class="hidden form-section">
                <button id="backToMainDashboardFromTroca" class="btn btn-secondary mb-3">&larr; Voltar</button>
                <h2>Troca de Filial Fixa de Equipamento</h2>
                <form id="trocaFilialForm">
                    <div class="mb-3">
                        <label for="placaEquipamento" class="form-label">Placa do Equipamento:</label>
                        <input type="text" id="placaEquipamento" list="equipamentosList" class="form-control" required>
                        <datalist id="equipamentosList"></datalist>
                    </div>
                    <div class="mb-3">
                        <label for="novaFilial" class="form-label">Nova Filial:</label>
                        <select id="novaFilial" class="form-select" required>
                            <option value="">Selecione...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="dataExecucao" class="form-label">Data de Execução:</label>
                        <input type="date" id="dataExecucao" class="form-control" required>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">Registrar Troca</button>
                    </div>
                </form>
                <div id="trocaFilialMessage" class="message"></div>
            </div>

        </main>
    </div>

    <div class="modal fade" id="editFilialResponsavelModal" tabindex="-1" aria-labelledby="editFilialResponsavelModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editFilialResponsavelModalLabel">Editar Responsável da Filial: <span id="modalFilialNome"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="modalFilialId">
                    <div class="mb-3">
                        <label for="modalResponsavelEmail" class="form-label">Novo Responsável (Email ou Nome):</label>
                        <input type="text" id="modalResponsavelEmail" class="form-control" placeholder="Email ou nome do novo responsável" required>
                        <small id="modalResponsavelHelper" class="form-text text-muted">Digite o email ou o nome do usuário.</small>
                    </div>
                    <div id="modalEditFilialMessage" class="message mt-3"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="saveFilialResponsavelBtn">Salvar Alterações</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editEquipamentoModal" tabindex="-1" aria-labelledby="editEquipamentoModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editEquipamentoModalLabel">Editar Equipamento: <span id="modalEquipamentoPlaca"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="modalEquipamentoId">
                    <div class="mb-3">
                        <label for="modalEquipamentoTipo" class="form-label">Tipo de Equipamento:</label>
                        <select id="modalEquipamentoTipo" class="form-select" required>
                            <option value="">Selecione...</option>
                            <option value="Bomba Lança">Bomba Lança</option>
                            <option value="Bomba Estacionária">Bomba Estacionária</option>
                            <option value="Betoneira">Betoneira</option>
                        </select>
                    </div>
                    <div id="modalEditEquipamentoMessage" class="message mt-3"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="saveEquipamentoBtn">Salvar Alterações</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editUsuarioModal" tabindex="-1" aria-labelledby="editUsuarioModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editUsuarioModalLabel">Editar Usuário: <span id="modalUsuarioNomeAtual"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="modalUsuarioId">
                    <div class="mb-3">
                        <label for="modalUsuarioNome" class="form-label">Nome:</label>
                        <input type="text" id="modalUsuarioNome" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="modalUsuarioEmail" class="form-label">Email:</label>
                        <input type="email" id="modalUsuarioEmail" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="modalUsuarioCategoria" class="form-label">Categoria:</label>
                        <select id="modalUsuarioCategoria" class="form-select" required>
                            <option value="">Selecione...</option>
                            <option value="admin">Administrador</option>
                            <option value="operador">Operador</option>
                            <option value="visualizador">Visualizador</option>
                        </select>
                    </div>
                    <hr>
                    <div class="mb-3">
                        <label for="modalUsuarioNovaSenha" class="form-label">Nova Senha (opcional):</label>
                        <input type="password" id="modalUsuarioNovaSenha" class="form-control">
                        <small class="form-text text-muted">Deixe em branco para não alterar a senha.</small>
                    </div>
                    <div class="mb-3">
                        <label for="modalUsuarioConfirmaSenha" class="form-label">Confirmar Nova Senha:</label>
                        <input type="password" id="modalUsuarioConfirmaSenha" class="form-control">
                    </div>
                    <div id="modalEditUsuarioMessage" class="message mt-3"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="saveUsuarioBtn">Salvar Alterações</button>
                </div>
            </div>
        </div>
    </div>

    <a href="https://wa.me/5522992075244?text=Ol%C3%A1%2C%20gostaria%20de%20mais%20informa%C3%A7%C3%B5es%21" class="btn btn-primary rounded-pill shadow-lg d-flex align-items-center py-2 px-3" style="position: fixed; bottom: 20px; right: 20px; z-index: 1060;" target="_blank">
        <i class="bi bi-question-circle-fill me-2 fs-5"></i> Precisando de ajuda? Clique aqui
    </a>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.10-rc.0/dist/js/i18n/pt-BR.js"></script>

    <script type="module">
        // public/index.html
        // Supabase Client (consolidado)
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.43.5';

        // ATENÇÃO: Substitua pelos seus dados reais do Supabase
        // O URL do seu projeto Supabase (encontrado em Project Settings -> API)
        const supabaseUrl = "https://jtikvjomzduvjrrrsfeg.supabase.co"; // SEU URL REAL AQUI
        // A sua chave "anon" ou "public" do Supabase (encontrada em Project Settings -> API)
        const supabaseAnonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiIomp0aWt2am9temR1dmpycnJzZmVnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxMjU3NjcsImV4cCI6MjA2ODcwMTc2N30.2SCuJprMLJROx... "; // SUA CHAVE ANON REAL AQUI

        const supabase = createClient(supabaseUrl, supabaseAnonKey);

        // Função para exibir telas
        function showScreen(screenId) {
            document.querySelectorAll('#mainContent > div').forEach(screen => {
                screen.classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');

            // Gerencia classes de corpo para layout
            if (screenId === 'loginScreen') {
                document.body.classList.add('logged-out');
            } else {
                document.body.classList.remove('logged-out');
            }
            // Garante que a sidebar esteja recolhida no mobile ao trocar de tela
            document.body.classList.remove('sidebar-expanded');
        }

        // Variáveis globais para os elementos de filtro do dashboard
        const filterStartDateInput = document.getElementById('filterStartDate');
        const filterEndDateInput = document.getElementById('filterEndDate');
        const filterSearchInput = document.getElementById('filterSearchInput');
        const selectResponsavel = document.getElementById('selectResponsavel');
        const selectFiliais = document.getElementById('selectFiliais');
        const filterDashboardBtn = document.getElementById('filterDashboardBtn');
        const clearSearchBtn = document.getElementById('clearSearchBtn');
        const kanbanMessage = document.getElementById('kanbanMessage');

        // Adicione isso logo após todas as declarações globais:
        async function loadEquipamentosDashboard() {
            const kanbanBoard = document.getElementById('kanbanBoard');
            kanbanBoard.innerHTML = ''; // limpa conteúdo anterior
            const kanbanMessage = document.getElementById('kanbanMessage');
            kanbanMessage.style.display = 'none';

            try {
                // Consulta: equipamentos com filial associada
                const { data: equipamentos, error } = await supabase
                    .from('equipamentos')
                    .select(`
                        id,
                        placa,
                        tipo,
                        filial:filial_id (
                            id,
                            nome_filial
                        )
                    `);

                if (error) throw error;

                if (!equipamentos || equipamentos.length === 0) {
                    kanbanMessage.style.display = 'block';
                    return;
                }

                // Agrupar por filial
                const colunas = {};
                equipamentos.forEach(equip => {
                    const nomeFilial = equip.filial?.nome_filial || 'Sem Filial';
                    if (!colunas[nomeFilial]) colunas[nomeFilial] = [];
                    colunas[nomeFilial].push(equip);
                });

                // Criar colunas do Kanban
                for (const [filial, equipamentos] of Object.entries(colunas)) {
                    const coluna = document.createElement('div');
                    coluna.className = 'kanban-column';

                    const cabecalho = document.createElement('div');
                    cabecalho.className = 'kanban-column-header';
                    cabecalho.textContent = filial;
                    coluna.appendChild(cabecalho);

                    equipamentos.forEach(eq => {
                        const card = document.createElement('div');
                        card.className = 'kanban-card';

                        const titulo = document.createElement('div');
                        titulo.className = 'kanban-card-title';
                        titulo.textContent = eq.placa;
                        card.appendChild(titulo);

                        const meta = document.createElement('div');
                        meta.className = 'kanban-card-meta';
                        meta.textContent = eq.tipo;
                        card.appendChild(meta);

                        coluna.appendChild(card);
                    });

                    kanbanBoard.appendChild(coluna);
                }

            } catch (err) {
                console.error('Erro ao carregar Kanban:', err.message);
                kanbanMessage.textContent = 'Erro ao carregar o dashboard';
                kanbanMessage.style.display = 'block';
            }
        }

        // Funções para carregar dados nos Select2
        async function loadFiliaisIntoSelect2() {
            try {
                const { data, error } = await supabase
                    .from('filiais')
                    .select('id, nome_filial')
                    .order('nome_filial', { ascending: true });

                if (error) throw error;

                const filiais = data.map(filial => ({
                    id: filial.id,
                    text: filial.nome_filial
                }));

                // Inicializa Select2
                $('#selectFiliais').empty().select2({
                    data: filiais,
                    theme: "bootstrap-5",
                    width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style',
                    placeholder: $(this).data('placeholder'),
                    allowClear: true,
                    dropdownParent: $('#mainDashboardScreen') // Garante que o dropdown aparece corretamente
                });

            } catch (error) {
                console.error('Erro ao carregar filiais para Select2:', error.message);
            }
        }

        async function loadResponsaveisForFilter(selectElement) {
            try {
                const { data, error } = await supabase
                    .from('usuarios')
                    .select('id, nome')
                    .in('categoria', ['admin', 'operador']) // Apenas admin e operador podem ser responsáveis
                    .order('nome', { ascending: true });

                if (error) throw error;

                // Limpa opções existentes, exceto a primeira (Todos)
                $(selectElement).find('option:not(:first)').remove();

                data.forEach(responsavel => {
                    const option = document.createElement('option');
                    option.value = responsavel.id;
                    option.textContent = responsavel.nome;
                    selectElement.appendChild(option);
                });
            } catch (error) {
                console.error('Erro ao carregar responsáveis:', error.message);
            }
        }

        // Função de login
        async function login(email, password) {
            const { data, error } = await supabase.auth.signInWithPassword({
                email: email,
                password: password,
            });

            if (error) {
                console.error("Erro de login:", error.message);
                return { success: false, message: error.message };
            }
            return { success: true, user: data.user };
        }

        // Função de logout
        async function logout() {
            const { error } = await supabase.auth.signOut();
            if (error) {
                console.error("Erro ao fazer logout:", error.message);
                return { success: false, message: error.message };
            }
            return { success: true };
        }

        // Função para obter o usuário logado
        async function getUser() {
            const { data: { user } } = await supabase.auth.getUser();
            return user;
        }

        // Gerenciamento de Autenticação e UI
        supabase.auth.onAuthStateChange(async (event, session) => {
            console.log("Auth state changed:", event, session);
            if (event === 'SIGNED_IN' && session) {
                showScreen('mainDashboardScreen');
                // Chama as funções de carregamento de dados para o dashboard
                await loadFiliaisIntoSelect2();
                await loadResponsaveisForFilter(selectResponsavel);
                await loadEquipamentosDashboard(); // Carrega o dashboard após o login
            } else if (event === 'SIGNED_OUT') {
                showScreen('loginScreen');
            }
        });

        // Event Listeners Globais
        document.addEventListener('DOMContentLoaded', async () => {
            // Verifica o estado da sessão ao carregar a página
            const user = await getUser();
            if (user) {
                showScreen('mainDashboardScreen');
                await loadFiliaisIntoSelect2();
                await loadResponsaveisForFilter(selectResponsavel);
                await loadEquipamentosDashboard(); // Carrega o dashboard se já estiver logado
            } else {
                showScreen('loginScreen');
            }

            // --- Gerenciamento de Telas ---
            document.querySelectorAll('a[data-screen]').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    showScreen(e.target.dataset.screen);
                });
            });

            // Voltar para o Dashboard principal
            document.querySelectorAll('[id^="backToMainDashboard"]').forEach(btn => {
                btn.addEventListener('click', () => showScreen('mainDashboardScreen'));
            });

            // --- Login ---
            const loginForm = document.getElementById('loginForm');
            const loginMessage = document.getElementById('loginMessage');

            if (loginForm) {
                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = document.getElementById('email').value;
                    const password = document.getElementById('password').value;

                    loginMessage.classList.remove('alert-success', 'alert-danger');
                    loginMessage.textContent = '';

                    const result = await login(email, password);
                    if (result.success) {
                        loginMessage.classList.add('alert-success');
                        loginMessage.textContent = 'Login bem-sucedido!';
                        // Redirecionamento é feito pelo onAuthStateChange
                    } else {
                        loginMessage.classList.add('alert-danger');
                        loginMessage.textContent = `Erro no login: ${result.message}`;
                    }
                });
            }

            // --- Logout ---
            const sidebarLogoutLink = document.getElementById('sidebarLogoutLink');
            if (sidebarLogoutLink) {
                sidebarLogoutLink.addEventListener('click', async (e) => {
                    e.preventDefault();
                    const result = await logout();
                    if (result.success) {
                        console.log("Logout bem-sucedido.");
                        // Redirecionamento é feito pelo onAuthStateChange
                    } else {
                        alert(`Erro ao fazer logout: ${result.message}`);
                    }
                });
            }

            // --- Toggle Sidebar (Desktop) ---
            const desktopSidebarToggleBtn = document.getElementById('desktopSidebarToggleBtn');
            if (desktopSidebarToggleBtn) {
                desktopSidebarToggleBtn.addEventListener('click', () => {
                    document.body.classList.toggle('sidebar-collapsed');
                });
            }

            // --- Toggle Sidebar (Mobile) ---
            const mobileSidebarToggleBtn = document.getElementById('mobileSidebarToggleBtn');
            if (mobileSidebarToggleBtn) {
                mobileSidebarToggleBtn.addEventListener('click', () => {
                    document.body.classList.toggle('sidebar-expanded');
                });
            }

            // --- Cadastro de Usuários ---
            const usuarioForm = document.getElementById('usuarioForm');
            const usuarioMessage = document.getElementById('usuarioMessage');
            const usuariosTableBody = document.getElementById('usuariosTableBody');
            const usuarioSearchInput = document.getElementById('usuarioSearchInput');
            const usuarioSearchBtn = document.getElementById('usuarioSearchBtn');
            const usuarioClearSearchBtn = document.getElementById('usuarioClearSearchBtn');
            const usuarioConsultaMessage = document.getElementById('usuarioConsultaMessage');
            const cadastroUsuariosNavItem = document.getElementById('cadastroUsuariosNavItem'); // Referência ao item do menu

            // Esconde o item de menu "Usuários" se o usuário não for admin
            const user = await getUser();
            if (user && user.user_metadata?.categoria !== 'admin') {
                if (cadastroUsuariosNavItem) {
                    cadastroUsuariosNavItem.classList.add('hidden');
                }
            } else {
                if (cadastroUsuariosNavItem) {
                    cadastroUsuariosNavItem.classList.remove('hidden');
                }
            }


            async function loadUsuarios(searchTerm = '') {
                usuarioConsultaMessage.classList.add('hidden');
                usuariosTableBody.innerHTML = '';
                try {
                    let query = supabase.from('usuarios').select('*').order('nome', { ascending: true });

                    if (searchTerm) {
                        query = query.or(`nome.ilike.%${searchTerm}%,email.ilike.%${searchTerm}%`);
                    }

                    const { data: usuarios, error } = await query;

                    if (error) throw error;

                    if (usuarios.length === 0) {
                        usuarioConsultaMessage.classList.remove('hidden');
                        usuarioConsultaMessage.textContent = 'Nenhum usuário encontrado.';
                        return;
                    }

                    usuarios.forEach(usuario => {
                        const row = usuariosTableBody.insertRow();
                        row.innerHTML = `
                            <td>${usuario.nome}</td>
                            <td>${usuario.email}</td>
                            <td>${usuario.categoria}</td>
                            <td>
                                <button class="btn btn-sm btn-info edit-usuario-btn" data-id="${usuario.id}" data-bs-toggle="modal" data-bs-target="#editUsuarioModal">
                                    <i class="bi bi-pencil-square"></i>
                                </button>
                                <button class="btn btn-sm btn-danger delete-usuario-btn" data-id="${usuario.id}">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        `;
                    });

                    // Adiciona listeners para os botões de editar e excluir
                    usuariosTableBody.querySelectorAll('.edit-usuario-btn').forEach(button => {
                        button.addEventListener('click', async (e) => {
                            const id = e.currentTarget.dataset.id;
                            await loadUsuarioForEdit(id);
                        });
                    });

                    usuariosTableBody.querySelectorAll('.delete-usuario-btn').forEach(button => {
                        button.addEventListener('click', async (e) => {
                            const id = e.currentTarget.dataset.id;
                            if (confirm('Tem certeza que deseja excluir este usuário?')) {
                                await deleteUsuario(id);
                            }
                        });
                    });

                } catch (error) {
                    console.error('Erro ao carregar usuários:', error.message);
                    usuarioConsultaMessage.classList.remove('hidden');
                    usuarioConsultaMessage.textContent = `Erro ao carregar usuários: ${error.message}`;
                }
            }

            if (usuarioForm) {
                usuarioForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    usuarioMessage.classList.remove('alert-success', 'alert-danger');
                    usuarioMessage.textContent = '';

                    const nome = document.getElementById('nomeUsuario').value;
                    const email = document.getElementById('emailUsuario').value;
                    const senha = document.getElementById('senhaUsuario').value;
                    const categoria = document.getElementById('categoriaUsuario').value;

                    try {
                        const { data, error } = await supabase.auth.signUp({
                            email: email,
                            password: senha,
                            options: {
                                data: {
                                    nome: nome,
                                    categoria: categoria
                                }
                            }
                        });

                        if (error) throw error;

                        // Se o cadastro na autenticação for bem-sucedido, adicione ao perfil customizado
                        const { error: insertError } = await supabase
                            .from('usuarios')
                            .insert([
                                { id: data.user.id, nome: nome, email: email, categoria: categoria }
                            ]);

                        if (insertError) throw insertError;

                        usuarioMessage.classList.add('alert-success');
                        usuarioMessage.textContent = 'Usuário cadastrado com sucesso!';
                        usuarioForm.reset();
                        loadUsuarios(); // Recarrega a tabela
                    } catch (error) {
                        console.error('Erro ao cadastrar usuário:', error.message);
                        usuarioMessage.classList.add('alert-danger');
                        usuarioMessage.textContent = `Erro ao cadastrar usuário: ${error.message}`;
                    }
                });
            }

            if (usuarioSearchBtn) {
                usuarioSearchBtn.addEventListener('click', () => {
                    loadUsuarios(usuarioSearchInput.value);
                });
            }

            if (usuarioClearSearchBtn) {
                usuarioClearSearchBtn.addEventListener('click', () => {
                    usuarioSearchInput.value = '';
                    loadUsuarios();
                });
            }

            // Modal de Edição de Usuário
            const editUsuarioModal = document.getElementById('editUsuarioModal');
            const modalUsuarioNomeAtual = document.getElementById('modalUsuarioNomeAtual');
            const modalUsuarioId = document.getElementById('modalUsuarioId');
            const modalUsuarioNome = document.getElementById('modalUsuarioNome');
            const modalUsuarioEmail = document.getElementById('modalUsuarioEmail');
            const modalUsuarioCategoria = document.getElementById('modalUsuarioCategoria');
            const modalUsuarioNovaSenha = document.getElementById('modalUsuarioNovaSenha');
            const modalUsuarioConfirmaSenha = document.getElementById('modalUsuarioConfirmaSenha');
            const modalEditUsuarioMessage = document.getElementById('modalEditUsuarioMessage');
            const saveUsuarioBtn = document.getElementById('saveUsuarioBtn');


            async function loadUsuarioForEdit(id) {
                modalEditUsuarioMessage.classList.add('hidden');
                modalEditUsuarioMessage.textContent = '';
                modalUsuarioNovaSenha.value = ''; // Limpa a senha ao abrir
                modalUsuarioConfirmaSenha.value = '';

                try {
                    const { data: usuario, error } = await supabase
                        .from('usuarios')
                        .select('*')
                        .eq('id', id)
                        .single();

                    if (error) throw error;

                    modalUsuarioId.value = usuario.id;
                    modalUsuarioNomeAtual.textContent = usuario.nome;
                    modalUsuarioNome.value = usuario.nome;
                    modalUsuarioEmail.value = usuario.email;
                    modalUsuarioCategoria.value = usuario.categoria;

                } catch (error) {
                    console.error('Erro ao carregar usuário para edição:', error.message);
                    modalEditUsuarioMessage.classList.remove('hidden');
                    modalEditUsuarioMessage.classList.add('alert-danger');
                    modalEditUsuarioMessage.textContent = `Erro ao carregar dados do usuário: ${error.message}`;
                }
            }

            if (saveUsuarioBtn) {
                saveUsuarioBtn.addEventListener('click', async () => {
                    modalEditUsuarioMessage.classList.remove('alert-success', 'alert-danger');
                    modalEditUsuarioMessage.textContent = '';

                    const id = modalUsuarioId.value;
                    const nome = modalUsuarioNome.value;
                    const email = modalUsuarioEmail.value;
                    const categoria = modalUsuarioCategoria.value;
                    const novaSenha = modalUsuarioNovaSenha.value;
                    const confirmaSenha = modalUsuarioConfirmaSenha.value;

                    if (novaSenha && novaSenha !== confirmaSenha) {
                        modalEditUsuarioMessage.classList.remove('hidden');
                        modalEditUsuarioMessage.classList.add('alert-danger');
                        modalEditUsuarioMessage.textContent = 'A nova senha e a confirmação de senha não coincidem.';
                        return;
                    }

                    try {
                        // Atualizar perfil customizado
                        const { error: updateProfileError } = await supabase
                            .from('usuarios')
                            .update({ nome: nome, email: email, categoria: categoria })
                            .eq('id', id);

                        if (updateProfileError) throw updateProfileError;

                        // Atualizar autenticação (email e senha)
                        const updates = {};
                        if (email !== user.email) { // Atualiza email apenas se mudou
                            updates.email = email;
                        }
                        if (novaSenha) { // Atualiza senha apenas se foi fornecida
                            updates.password = novaSenha;
                        }

                        if (Object.keys(updates).length > 0) {
                            const { error: authUpdateError } = await supabase.auth.updateUser(updates);
                            if (authUpdateError) throw authUpdateError;
                        }

                        modalEditUsuarioMessage.classList.remove('hidden');
                        modalEditUsuarioMessage.classList.add('alert-success');
                        modalEditUsuarioMessage.textContent = 'Usuário atualizado com sucesso!';
                        $('#editUsuarioModal').modal('hide'); // Fecha o modal
                        loadUsuarios(); // Recarrega a tabela
                    } catch (error) {
                        console.error('Erro ao atualizar usuário:', error.message);
                        modalEditUsuarioMessage.classList.remove('hidden');
                        modalEditUsuarioMessage.classList.add('alert-danger');
                        modalEditUsuarioMessage.textContent = `Erro ao atualizar usuário: ${error.message}`;
                    }
                });
            }

            async function deleteUsuario(id) {
                try {
                    // Primeiro, exclui da tabela de usuários (perfil customizado)
                    const { error: deleteProfileError } = await supabase
                        .from('usuarios')
                        .delete()
                        .eq('id', id);

                    if (deleteProfileError) throw deleteProfileError;

                    // Opcional: Se desejar excluir o usuário da autenticação do Supabase também
                    // const { error: deleteAuthError } = await supabase.auth.admin.deleteUser(id);
                    // if (deleteAuthError) throw deleteAuthError;
                    // Note: Excluir da auth.users requer chave de serviço/admin, que não é recomendável no cliente.
                    // Para um app real, isso seria feito via função edge ou backend seguro.

                    alert('Usuário excluído com sucesso!');
                    loadUsuarios(); // Recarrega a tabela
                } catch (error) {
                    console.error('Erro ao excluir usuário:', error.message);
                    alert(`Erro ao excluir usuário: ${error.message}`);
                }
            }


            // Inicializa a carga de usuários quando a tela é mostrada
            document.getElementById('showCadastroUsuarios').addEventListener('click', () => {
                loadUsuarios();
            });


            // --- Cadastro de Filiais ---
            const filialForm = document.getElementById('filialForm');
            const filialMessage = document.getElementById('filialMessage');
            const filiaisTableBody = document.getElementById('filiaisTableBody');
            const filialSearchInput = document.getElementById('filialSearchInput');
            const filialSearchBtn = document.getElementById('filialSearchBtn');
            const filialClearSearchBtn = document.getElementById('filialClearSearchBtn');
            const filialConsultaMessage = document.getElementById('filialConsultaMessage');


            async function loadFiliais(searchTerm = '') {
                filialConsultaMessage.classList.add('hidden');
                filiaisTableBody.innerHTML = '';
                try {
                    let query = supabase.from('filiais').select(`
                        id,
                        nome_filial,
                        responsavel:responsavel_id (
                            id,
                            nome,
                            email
                        )
                    `).order('nome_filial', { ascending: true });

                    if (searchTerm) {
                        query = query.or(`nome_filial.ilike.%${searchTerm}%,responsavel.nome.ilike.%${searchTerm}%,responsavel.email.ilike.%${searchTerm}%`);
                    }

                    const { data: filiais, error } = await query;

                    if (error) throw error;

                    if (filiais.length === 0) {
                        filialConsultaMessage.classList.remove('hidden');
                        filialConsultaMessage.textContent = 'Nenhuma filial encontrada.';
                        return;
                    }

                    filiais.forEach(filial => {
                        const row = filiaisTableBody.insertRow();
                        const responsavelNome = filial.responsavel ? filial.responsavel.nome : 'N/A';
                        row.innerHTML = `
                            <td>${filial.nome_filial}</td>
                            <td>${responsavelNome}</td>
                            <td>
                                <button class="btn btn-sm btn-info edit-filial-btn" data-id="${filial.id}" data-bs-toggle="modal" data-bs-target="#editFilialResponsavelModal">
                                    <i class="bi bi-pencil-square"></i>
                                </button>
                                <button class="btn btn-sm btn-danger delete-filial-btn" data-id="${filial.id}">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        `;
                    });

                    // Adiciona listeners para os botões de editar e excluir
                    filiaisTableBody.querySelectorAll('.edit-filial-btn').forEach(button => {
                        button.addEventListener('click', async (e) => {
                            const id = e.currentTarget.dataset.id;
                            await loadFilialForEdit(id);
                        });
                    });

                    filiaisTableBody.querySelectorAll('.delete-filial-btn').forEach(button => {
                        button.addEventListener('click', async (e) => {
                            const id = e.currentTarget.dataset.id;
                            if (confirm('Tem certeza que deseja excluir esta filial?')) {
                                await deleteFilial(id);
                            }
                        });
                    });

                } catch (error) {
                    console.error('Erro ao carregar filiais:', error.message);
                    filialConsultaMessage.classList.remove('hidden');
                    filialConsultaMessage.textContent = `Erro ao carregar filiais: ${error.message}`;
                }
            }

            if (filialForm) {
                filialForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    filialMessage.classList.remove('alert-success', 'alert-danger');
                    filialMessage.textContent = '';

                    const nomeFilial = document.getElementById('nomeFilial').value;
                    const responsavelInput = document.getElementById('responsavelEmail').value;

                    try {
                        // Buscar ID do responsável (assumindo que responsavelInput pode ser email ou nome)
                        let responsavelId = null;
                        if (responsavelInput) {
                            const { data: responsavelUser, error: responsavelError } = await supabase
                                .from('usuarios')
                                .select('id')
                                .or(`email.eq.${responsavelInput},nome.ilike.${responsavelInput}`)
                                .single();

                            if (responsavelError && responsavelError.code !== 'PGRST116') { // PGRST116 = No rows found
                                throw responsavelError;
                            }
                            if (responsavelUser) {
                                responsavelId = responsavelUser.id;
                            } else {
                                throw new Error('Responsável não encontrado. Verifique o email ou nome.');
                            }
                        }

                        const { error } = await supabase
                            .from('filiais')
                            .insert([
                                { nome_filial: nomeFilial, responsavel_id: responsavelId }
                            ]);

                        if (error) throw error;

                        filialMessage.classList.add('alert-success');
                        filialMessage.textContent = 'Filial cadastrada com sucesso!';
                        filialForm.reset();
                        loadFiliais(); // Recarrega a tabela
                        loadFiliaisIntoSelect2(); // Recarrega o select do dashboard
                    } catch (error) {
                        console.error('Erro ao cadastrar filial:', error.message);
                        filialMessage.classList.add('alert-danger');
                        filialMessage.textContent = `Erro ao cadastrar filial: ${error.message}`;
                    }
                });
            }

            if (filialSearchBtn) {
                filialSearchBtn.addEventListener('click', () => {
                    loadFiliais(filialSearchInput.value);
                });
            }

            if (filialClearSearchBtn) {
                filialClearSearchBtn.addEventListener('click', () => {
                    filialSearchInput.value = '';
                    loadFiliais();
                });
            }

            // Modal de Edição de Filial
            const editFilialResponsavelModal = document.getElementById('editFilialResponsavelModal');
            const modalFilialNome = document.getElementById('modalFilialNome');
            const modalFilialId = document.getElementById('modalFilialId');
            const modalResponsavelEmail = document.getElementById('modalResponsavelEmail');
            const modalEditFilialMessage = document.getElementById('modalEditFilialMessage');
            const saveFilialResponsavelBtn = document.getElementById('saveFilialResponsavelBtn');

            async function loadFilialForEdit(id) {
                modalEditFilialMessage.classList.add('hidden');
                modalEditFilialMessage.textContent = '';
                modalResponsavelEmail.value = ''; // Limpa o campo ao abrir

                try {
                    const { data: filial, error } = await supabase
                        .from('filiais')
                        .select(`
                            id,
                            nome_filial,
                            responsavel:responsavel_id (
                                nome,
                                email
                            )
                        `)
                        .eq('id', id)
                        .single();

                    if (error) throw error;

                    modalFilialId.value = filial.id;
                    modalFilialNome.textContent = filial.nome_filial;
                    modalResponsavelEmail.value = filial.responsavel ? filial.responsavel.email : ''; // Preenche com email do responsável

                } catch (error) {
                    console.error('Erro ao carregar filial para edição:', error.message);
                    modalEditFilialMessage.classList.remove('hidden');
                    modalEditFilialMessage.classList.add('alert-danger');
                    modalEditFilialMessage.textContent = `Erro ao carregar dados da filial: ${error.message}`;
                }
            }

            if (saveFilialResponsavelBtn) {
                saveFilialResponsavelBtn.addEventListener('click', async () => {
                    modalEditFilialMessage.classList.remove('alert-success', 'alert-danger');
                    modalEditFilialMessage.textContent = '';

                    const id = modalFilialId.value;
                    const novoResponsavelInput = modalResponsavelEmail.value;
                    let responsavelId = null;

                    try {
                        if (novoResponsavelInput) {
                            const { data: responsavelUser, error: responsavelError } = await supabase
                                .from('usuarios')
                                .select('id')
                                .or(`email.eq.${novoResponsavelInput},nome.ilike.${novoResponsavelInput}`)
                                .single();

                            if (responsavelError && responsavelError.code !== 'PGRST116') {
                                throw responsavelError;
                            }
                            if (responsavelUser) {
                                responsavelId = responsavelUser.id;
                            } else {
                                throw new Error('Novo responsável não encontrado. Verifique o email ou nome.');
                            }
                        }

                        const { error } = await supabase
                            .from('filiais')
                            .update({ responsavel_id: responsavelId })
                            .eq('id', id);

                        if (error) throw error;

                        modalEditFilialMessage.classList.remove('hidden');
                        modalEditFilialMessage.classList.add('alert-success');
                        modalEditFilialMessage.textContent = 'Filial atualizada com sucesso!';
                        $('#editFilialResponsavelModal').modal('hide'); // Fecha o modal
                        loadFiliais(); // Recarrega a tabela
                        loadResponsaveisForFilter(selectResponsavel); // Recarrega select de responsáveis no dashboard
                    } catch (error) {
                        console.error('Erro ao atualizar filial:', error.message);
                        modalEditFilialMessage.classList.remove('hidden');
                        modalEditFilialMessage.classList.add('alert-danger');
                        modalEditFilialMessage.textContent = `Erro ao atualizar filial: ${error.message}`;
                    }
                });
            }

            async function deleteFilial(id) {
                try {
                    const { error } = await supabase
                        .from('filiais')
                        .delete()
                        .eq('id', id);

                    if (error) throw error;

                    alert('Filial excluída com sucesso!');
                    loadFiliais(); // Recarrega a tabela
                    loadFiliaisIntoSelect2(); // Recarrega o select do dashboard
                } catch (error) {
                    console.error('Erro ao excluir filial:', error.message);
                    alert(`Erro ao excluir filial: ${error.message}`);
                }
            }

            // Inicializa a carga de filiais quando a tela é mostrada
            document.getElementById('showCadastroFiliais').addEventListener('click', () => {
                loadFiliais();
            });

            // --- Cadastro de Equipamentos ---
            const equipamentoForm = document.getElementById('equipamentoForm');
            const equipamentoMessage = document.getElementById('equipamentoMessage');
            const equipamentosTableBody = document.getElementById('equipamentosTableBody');
            const equipamentoSearchInput = document.getElementById('equipamentoSearchInput');
            const equipamentoSearchBtn = document.getElementById('equipamentoSearchBtn');
            const equipamentoClearSearchBtn = document.getElementById('equipamentoClearSearchBtn');
            const equipamentoConsultaMessage = document.getElementById('equipamentoConsultaMessage');

            async function loadEquipamentos(searchTerm = '') {
                equipamentoConsultaMessage.classList.add('hidden');
                equipamentosTableBody.innerHTML = '';
                try {
                    let query = supabase.from('equipamentos').select(`
                        id,
                        placa,
                        tipo,
                        filial:filial_id (
                            nome_filial
                        )
                    `).order('placa', { ascending: true });

                    if (searchTerm) {
                        query = query.or(`placa.ilike.%${searchTerm}%,tipo.ilike.%${searchTerm}%,filial.nome_filial.ilike.%${searchTerm}%`);
                    }

                    const { data: equipamentos, error } = await query;

                    if (error) throw error;

                    if (equipamentos.length === 0) {
                        equipamentoConsultaMessage.classList.remove('hidden');
                        equipamentoConsultaMessage.textContent = 'Nenhum equipamento encontrado.';
                        return;
                    }

                    equipamentos.forEach(equipamento => {
                        const row = equipamentosTableBody.insertRow();
                        const nomeFilial = equipamento.filial ? equipamento.filial.nome_filial : 'N/A';
                        row.innerHTML = `
                            <td>${equipamento.placa}</td>
                            <td>${equipamento.tipo}</td>
                            <td>
                                <button class="btn btn-sm btn-info edit-equipamento-btn" data-id="${equipamento.id}" data-bs-toggle="modal" data-bs-target="#editEquipamentoModal">
                                    <i class="bi bi-pencil-square"></i>
                                </button>
                                <button class="btn btn-sm btn-danger delete-equipamento-btn" data-id="${equipamento.id}">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        `;
                    });

                    equipamentosTableBody.querySelectorAll('.edit-equipamento-btn').forEach(button => {
                        button.addEventListener('click', async (e) => {
                            const id = e.currentTarget.dataset.id;
                            await loadEquipamentoForEdit(id);
                        });
                    });

                    equipamentosTableBody.querySelectorAll('.delete-equipamento-btn').forEach(button => {
                        button.addEventListener('click', async (e) => {
                            const id = e.currentTarget.dataset.id;
                            if (confirm('Tem certeza que deseja excluir este equipamento?')) {
                                await deleteEquipamento(id);
                            }
                        });
                    });

                } catch (error) {
                    console.error('Erro ao carregar equipamentos:', error.message);
                    equipamentoConsultaMessage.classList.remove('hidden');
                    equipamentoConsultaMessage.textContent = `Erro ao carregar equipamentos: ${error.message}`;
                }
            }

            if (equipamentoForm) {
                equipamentoForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    equipamentoMessage.classList.remove('alert-success', 'alert-danger');
                    equipamentoMessage.textContent = '';

                    const placa = document.getElementById('placa').value;
                    const tipo = document.getElementById('tipoEquipamento').value;

                    try {
                        const { error } = await supabase
                            .from('equipamentos')
                            .insert([
                                { placa: placa, tipo: tipo }
                            ]);

                        if (error) throw error;

                        equipamentoMessage.classList.add('alert-success');
                        equipamentoMessage.textContent = 'Equipamento cadastrado com sucesso!';
                        equipamentoForm.reset();
                        loadEquipamentos(); // Recarrega a tabela
                    } catch (error) {
                        console.error('Erro ao cadastrar equipamento:', error.message);
                        equipamentoMessage.classList.add('alert-danger');
                        equipamentoMessage.textContent = `Erro ao cadastrar equipamento: ${error.message}`;
                    }
                });
            }

            if (equipamentoSearchBtn) {
                equipamentoSearchBtn.addEventListener('click', () => {
                    loadEquipamentos(equipamentoSearchInput.value);
                });
            }

            if (equipamentoClearSearchBtn) {
                equipamentoClearSearchBtn.addEventListener('click', () => {
                    equipamentoSearchInput.value = '';
                    loadEquipamentos();
                });
            }

            // Modal de Edição de Equipamento
            const editEquipamentoModal = document.getElementById('editEquipamentoModal');
            const modalEquipamentoPlaca = document.getElementById('modalEquipamentoPlaca');
            const modalEquipamentoId = document.getElementById('modalEquipamentoId');
            const modalEquipamentoTipo = document.getElementById('modalEquipamentoTipo');
            const modalEditEquipamentoMessage = document.getElementById('modalEditEquipamentoMessage');
            const saveEquipamentoBtn = document.getElementById('saveEquipamentoBtn');

            async function loadEquipamentoForEdit(id) {
                modalEditEquipamentoMessage.classList.add('hidden');
                modalEditEquipamentoMessage.textContent = '';

                try {
                    const { data: equipamento, error } = await supabase
                        .from('equipamentos')
                        .select('*')
                        .eq('id', id)
                        .single();

                    if (error) throw error;

                    modalEquipamentoId.value = equipamento.id;
                    modalEquipamentoPlaca.textContent = equipamento.placa;
                    modalEquipamentoTipo.value = equipamento.tipo;

                } catch (error) {
                    console.error('Erro ao carregar equipamento para edição:', error.message);
                    modalEditEquipamentoMessage.classList.remove('hidden');
                    modalEditEquipamentoMessage.classList.add('alert-danger');
                    modalEditEquipamentoMessage.textContent = `Erro ao carregar dados do equipamento: ${error.message}`;
                }
            }

            if (saveEquipamentoBtn) {
                saveEquipamentoBtn.addEventListener('click', async () => {
                    modalEditEquipamentoMessage.classList.remove('alert-success', 'alert-danger');
                    modalEditEquipamentoMessage.textContent = '';

                    const id = modalEquipamentoId.value;
                    const tipo = modalEquipamentoTipo.value;

                    try {
                        const { error } = await supabase
                            .from('equipamentos')
                            .update({ tipo: tipo })
                            .eq('id', id);

                        if (error) throw error;

                        modalEditEquipamentoMessage.classList.remove('hidden');
                        modalEditEquipamentoMessage.classList.add('alert-success');
                        modalEditEquipamentoMessage.textContent = 'Equipamento atualizado com sucesso!';
                        $('#editEquipamentoModal').modal('hide'); // Fecha o modal
                        loadEquipamentos(); // Recarrega a tabela
                        loadEquipamentosDashboard(); // Recarrega o dashboard
                    } catch (error) {
                        console.error('Erro ao atualizar equipamento:', error.message);
                        modalEditEquipamentoMessage.classList.remove('hidden');
                        modalEditEquipamentoMessage.classList.add('alert-danger');
                        modalEditEquipamentoMessage.textContent = `Erro ao atualizar equipamento: ${error.message}`;
                    }
                });
            }

            async function deleteEquipamento(id) {
                try {
                    const { error } = await supabase
                        .from('equipamentos')
                        .delete()
                        .eq('id', id);

                    if (error) throw error;

                    alert('Equipamento excluído com sucesso!');
                    loadEquipamentos(); // Recarrega a tabela
                    loadEquipamentosDashboard(); // Recarrega o dashboard
                } catch (error) {
                    console.error('Erro ao excluir equipamento:', error.message);
                    alert(`Erro ao excluir equipamento: ${error.message}`);
                }
            }

            // Inicializa a carga de equipamentos quando a tela é mostrada
            document.getElementById('showCadastroEquipamentos').addEventListener('click', () => {
                loadEquipamentos();
            });


            // --- Troca de Filial (Operacional) ---
            const trocaFilialForm = document.getElementById('trocaFilialForm');
            const placaEquipamentoInput = document.getElementById('placaEquipamento');
            const equipamentosDatalist = document.getElementById('equipamentosList');
            const novaFilialSelect = document.getElementById('novaFilial');
            const dataExecucaoInput = document.getElementById('dataExecucao');
            const trocaFilialMessage = document.getElementById('trocaFilialMessage');


            async function loadEquipamentosForDatalist() {
                try {
                    const { data: equipamentos, error } = await supabase
                        .from('equipamentos')
                        .select('placa')
                        .order('placa', { ascending: true });

                    if (error) throw error;

                    equipamentosDatalist.innerHTML = ''; // Limpa as opções existentes
                    equipamentos.forEach(equipamento => {
                        const option = document.createElement('option');
                        option.value = equipamento.placa;
                        equipamentosDatalist.appendChild(option);
                    });
                } catch (error) {
                    console.error('Erro ao carregar placas de equipamentos para datalist:', error.message);
                }
            }

            async function loadFiliaisForTroca() {
                try {
                    const { data: filiais, error } = await supabase
                        .from('filiais')
                        .select('id, nome_filial')
                        .order('nome_filial', { ascending: true });

                    if (error) throw error;

                    novaFilialSelect.innerHTML = '<option value="">Selecione...</option>'; // Limpa e adiciona default
                    filiais.forEach(filial => {
                        const option = document.createElement('option');
                        option.value = filial.id;
                        option.textContent = filial.nome_filial;
                        novaFilialSelect.appendChild(option);
                    });
                } catch (error) {
                    console.error('Erro ao carregar filiais para troca:', error.message);
                }
            }

            if (trocaFilialForm) {
                trocaFilialForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    trocaFilialMessage.classList.remove('alert-success', 'alert-danger');
                    trocaFilialMessage.textContent = '';

                    const placa = placaEquipamentoInput.value;
                    const novaFilialId = novaFilialSelect.value;
                    const dataExecucao = dataExecucaoInput.value;

                    try {
                        // 1. Encontrar o ID do equipamento pela placa
                        const { data: equipamento, error: equipError } = await supabase
                            .from('equipamentos')
                            .select('id')
                            .eq('placa', placa)
                            .single();

                        if (equipError || !equipamento) {
                            throw new Error('Equipamento com esta placa não encontrado.');
                        }
                        const equipamentoId = equipamento.id;

                        // 2. Atualizar a filial_id do equipamento
                        const { error: updateError } = await supabase
                            .from('equipamentos')
                            .update({ filial_id: novaFilialId })
                            .eq('id', equipamentoId);

                        if (updateError) throw updateError;

                        // 3. Registrar a troca na tabela de histórico_trocas_filial
                        const { error: historyError } = await supabase
                            .from('historico_trocas_filial')
                            .insert([
                                {
                                    equipamento_id: equipamentoId,
                                    filial_id_destino: novaFilialId,
                                    data_execucao: dataExecucao
                                }
                            ]);

                        if (historyError) throw historyError;


                        trocaFilialMessage.classList.add('alert-success');
                        trocaFilialMessage.textContent = 'Troca de filial registrada com sucesso!';
                        trocaFilialForm.reset();
                        loadEquipamentosDashboard(); // Recarrega o dashboard
                    } catch (error) {
                        console.error('Erro ao registrar troca de filial:', error.message);
                        trocaFilialMessage.classList.add('alert-danger');
                        trocaFilialMessage.textContent = `Erro ao registrar troca de filial: ${error.message}`;
                    }
                });
            }

            document.getElementById('showTrocaFilial').addEventListener('click', () => {
                loadEquipamentosForDatalist();
                loadFiliaisForTroca();
            });

            // Gerenciamento de Dashboard (Filtros)
            if (filterDashboardBtn) {
                filterDashboardBtn.addEventListener('click', loadEquipamentosDashboard);
            }
            if (clearSearchBtn) {
                clearSearchBtn.addEventListener('click', () => {
                    filterSearchInput.value = '';
                    loadEquipamentosDashboard();
                });
            }

            // Carrega os responsáveis no filtro e o dashboard ao iniciar (após login)
            if (selectResponsavel) {
                loadResponsaveisForFilter(selectResponsavel);
            }
            // O loadFiliaisIntoSelect2 é chamado dentro de showScreen('mainDashboardScreen')
        });
    </script>
</body>
</html>
